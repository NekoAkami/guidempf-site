<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activité Milice - MPF Documentation</title>
    <link rel="stylesheet" href="assets/css/main-style.css">
    <link rel="stylesheet" href="assets/css/combine-terminals.css">
    <link rel="stylesheet" href="assets/css/global-nav.css">
    <link rel="stylesheet" href="assets/css/interactive-system.css">
    <link rel="stylesheet" href="assets/css/combine-animations.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        .milice-wrapper { max-width: 1000px; margin: 0 auto; }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.8rem; margin-bottom: 1.5rem;
        }
        .stat-box {
            padding: 1rem; text-align: center;
            background: rgba(0, 170, 255, 0.03);
            border: 1px solid rgba(0, 170, 255, 0.1);
            border-radius: 4px; transition: all 0.15s;
        }
        .stat-box:hover { background: rgba(0, 170, 255, 0.06); border-color: rgba(0, 170, 255, 0.2); }
        .stat-box .stat-number {
            font-family: 'Orbitron', sans-serif; font-size: 1.6rem;
            color: var(--accent-cyan); font-weight: 700;
        }
        .stat-box .stat-label {
            font-family: 'Share Tech Mono', monospace; font-size: 0.65rem;
            color: var(--text-muted); letter-spacing: 1px; margin-top: 0.3rem;
        }

        .activity-section { margin-bottom: 1.5rem; }

        .type-bar {
            display: flex; align-items: center; gap: 0.8rem;
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid rgba(0, 170, 255, 0.06);
            font-family: 'Share Tech Mono', monospace; font-size: 0.82rem;
        }
        .type-bar:hover { background: rgba(0, 170, 255, 0.02); }
        .type-bar .type-name {
            min-width: 180px; color: var(--text-primary); font-weight: 700;
        }
        .type-bar .type-count {
            font-family: 'Orbitron', sans-serif; font-size: 0.85rem;
            color: var(--accent-cyan); font-weight: 700; min-width: 40px;
            text-align: right;
        }
        .type-bar .bar-container {
            flex: 1; height: 18px;
            background: rgba(0, 170, 255, 0.05);
            border: 1px solid rgba(0, 170, 255, 0.1);
            border-radius: 2px; overflow: hidden;
        }
        .type-bar .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(0, 170, 255, 0.3), rgba(0, 170, 255, 0.5));
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .unit-activity-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .unit-activity-table th {
            text-align: left; padding: 0.5rem 0.4rem;
            color: var(--accent-cyan); font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem; letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.2);
            cursor: pointer; user-select: none;
        }
        .unit-activity-table th:hover { color: #fff; }
        .unit-activity-table td {
            padding: 0.4rem; color: var(--text-primary);
            border-bottom: 1px solid rgba(0, 170, 255, 0.06);
            vertical-align: middle; font-family: 'Share Tech Mono', monospace;
        }
        .unit-activity-table tr:hover { background: rgba(0, 170, 255, 0.03); }

        .period-tabs {
            display: flex; gap: 0.5rem; margin-bottom: 1rem;
        }
        .period-tab {
            padding: 0.4rem 0.8rem; border-radius: 3px; cursor: pointer;
            font-family: 'Share Tech Mono', monospace; font-size: 0.75rem;
            border: 1px solid rgba(0, 170, 255, 0.3);
            background: rgba(0, 170, 255, 0.05); color: var(--accent-cyan);
            transition: all 0.15s;
        }
        .period-tab:hover { background: rgba(0, 170, 255, 0.15); }
        .period-tab.active { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); font-weight: 700; }

        .search-bar {
            margin-bottom: 1rem;
        }
        .search-bar input {
            width: 100%; padding: 0.45rem 0.7rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
            outline: none; border-radius: 2px;
        }
        .search-bar input:focus { border-color: var(--accent-cyan); }

        #access-denied, #notApproved { display: none; text-align: center; padding: 3rem; }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>

    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">Activité de la Milice</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p>
            </div>
            <div id="access-denied">
                <h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">CONNEXION REQUISE</h2>
                <a href="login.html" style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;display:inline-block;margin-top:1rem;">→ SE CONNECTER</a>
            </div>
            <div id="notApproved">
                <h2 style="color:#ffaa00;font-family:'Orbitron',sans-serif;">EN ATTENTE D'APPROBATION</h2>
            </div>

            <div id="mainContent" style="display:none;">
                <div class="milice-wrapper">

                    <!-- Période -->
                    <div class="period-tabs" id="periodTabs">
                        <div class="period-tab" onclick="setPeriod('today')">AUJOURD'HUI</div>
                        <div class="period-tab active" onclick="setPeriod('week')">CETTE SEMAINE</div>
                        <div class="period-tab" onclick="setPeriod('month')">CE MOIS</div>
                        <div class="period-tab" onclick="setPeriod('all')">TOTAL</div>
                    </div>

                    <!-- Statistiques générales -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-box"><div class="stat-number" id="statTotalRapports">0</div><div class="stat-label">RAPPORTS TOTAL</div></div>
                        <div class="stat-box"><div class="stat-number" id="statUnites">0</div><div class="stat-label">UNITÉS ACTIVES</div></div>
                        <div class="stat-box"><div class="stat-number" id="statMoyenne">0</div><div class="stat-label">MOYENNE / UNITÉ</div></div>
                        <div class="stat-box"><div class="stat-number" id="statTopType">-</div><div class="stat-label">TYPE LE + FRÉQUENT</div></div>
                    </div>

                    <!-- Répartition par type -->
                    <div class="combine-terminal-wrapper animate-fadeInUp activity-section">
                        <div class="combine-header">
                            <h2>RÉPARTITION PAR TYPE DE RAPPORT</h2>
                            <span class="header-code">STATISTIQUES</span>
                        </div>
                        <div class="combine-body" id="typeBreakdown">
                            <p style="text-align:center;color:var(--text-muted);">Chargement...</p>
                        </div>
                    </div>

                    <!-- Activité par unité -->
                    <div class="combine-terminal-wrapper animate-fadeInUp delay-1 activity-section">
                        <div class="combine-header">
                            <h2>ACTIVITÉ PAR UNITÉ</h2>
                            <span class="header-code" id="unitCountLabel">0 UNITÉS</span>
                        </div>
                        <div class="combine-body">
                            <div class="search-bar">
                                <input type="text" id="unitSearch" placeholder="Rechercher une unité (matricule, nom)..." oninput="renderUnitActivity()">
                            </div>
                            <div style="overflow-x:auto;">
                                <table class="unit-activity-table">
                                    <thead>
                                        <tr>
                                            <th onclick="sortUnitsBy('matricule')">MATRICULE</th>
                                            <th onclick="sortUnitsBy('nom_steam')">NOM</th>
                                            <th onclick="sortUnitsBy('division')">DIVISION</th>
                                            <th onclick="sortUnitsBy('total')">RAPPORTS</th>
                                            <th>TYPES</th>
                                        </tr>
                                    </thead>
                                    <tbody id="unitActivityBody">
                                        <tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script type="module" src="assets/js/auth.js"></script>
    <script src="assets/js/global-nav.js"></script>
    <script src="assets/js/interactive-system.js"></script>
    <script src="assets/js/combine-animations.js"></script>

    <script type="module">
      import { auth, db } from './assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { loadReports, loadUnits } from './assets/js/github-data.js';

      let allReports = [], allUnits = [], currentPeriod = 'week';
      let unitSortField = 'total', unitSortDir = 'desc';

      function getWeekBounds() {
        const now = new Date(); const day = now.getDay();
        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(now); monday.setDate(diff); monday.setHours(0,0,0,0);
        const sunday = new Date(monday); sunday.setDate(sunday.getDate() + 6);
        return { start: monday.toISOString().substring(0,10), end: sunday.toISOString().substring(0,10) };
      }

      function getFilteredReports() {
        const today = new Date().toISOString().substring(0,10);
        const week = getWeekBounds();
        const month = today.substring(0, 7);
        return allReports.filter(r => {
          if ((r.type_rapport || 'unité') !== 'unité') return false; // Uniquement rapports unité
          if (currentPeriod === 'today' && r.created_at !== today) return false;
          if (currentPeriod === 'week' && (r.created_at < week.start || r.created_at > week.end)) return false;
          if (currentPeriod === 'month' && !r.created_at?.startsWith(month)) return false;
          return true;
        });
      }

      window.setPeriod = function(period) {
        currentPeriod = period;
        document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        updateAll();
      };

      function updateAll() {
        const reports = getFilteredReports();

        // Stats générales
        const uniqueUnits = new Set(reports.map(r => r.matricule));
        document.getElementById('statTotalRapports').textContent = reports.length;
        document.getElementById('statUnites').textContent = uniqueUnits.size;
        document.getElementById('statMoyenne').textContent = uniqueUnits.size ? (reports.length / uniqueUnits.size).toFixed(1) : '0';

        // Type le plus fréquent
        const typeCount = {};
        reports.forEach(r => {
          const t = r.type || 'Autre';
          typeCount[t] = (typeCount[t] || 0) + 1;
        });
        const topType = Object.entries(typeCount).sort((a,b) => b[1] - a[1])[0];
        document.getElementById('statTopType').textContent = topType ? topType[0] : '-';

        // Répartition par type
        renderTypeBreakdown(typeCount, reports.length);

        // Activité par unité
        renderUnitActivity();
      }

      function renderTypeBreakdown(typeCount, total) {
        const container = document.getElementById('typeBreakdown');
        const sorted = Object.entries(typeCount).sort((a,b) => b[1] - a[1]);
        if (!sorted.length) {
          container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:1rem;">Aucun rapport pour cette période</p>';
          return;
        }
        const max = sorted[0][1];
        container.innerHTML = sorted.map(([type, count]) => {
          const pct = total > 0 ? ((count/total)*100).toFixed(1) : 0;
          const barW = max > 0 ? ((count/max)*100) : 0;
          return `<div class="type-bar">
            <span class="type-name">${type}</span>
            <span class="type-count">${count}</span>
            <div class="bar-container"><div class="bar-fill" style="width:${barW}%"></div></div>
            <span style="color:var(--text-muted);font-size:0.72rem;min-width:45px;text-align:right;">${pct}%</span>
          </div>`;
        }).join('');
      }

      window.renderUnitActivity = function() {
        const reports = getFilteredReports();
        const q = (document.getElementById('unitSearch')?.value || '').toLowerCase();

        // Agréger par unité
        const unitMap = {};
        reports.forEach(r => {
          const mat = r.matricule;
          if (!mat) return;
          if (!unitMap[mat]) unitMap[mat] = { matricule: mat, nom_steam: r.nom_steam || '', division: '', types: {}, total: 0 };
          unitMap[mat].types[r.type || 'Autre'] = (unitMap[mat].types[r.type || 'Autre'] || 0) + 1;
          unitMap[mat].total++;
        });

        // Enrichir avec les unités connues
        allUnits.forEach(u => {
          if (unitMap[u.matricule]) {
            unitMap[u.matricule].nom_steam = u.nom_steam || unitMap[u.matricule].nom_steam;
            unitMap[u.matricule].division = u.division || '';
          }
        });

        let unitList = Object.values(unitMap);

        // Filtre recherche
        if (q) {
          unitList = unitList.filter(u => `${u.matricule} ${u.nom_steam} ${u.division}`.toLowerCase().includes(q));
        }

        // Tri
        unitList.sort((a, b) => {
          let va, vb;
          if (unitSortField === 'total') { va = a.total; vb = b.total; return unitSortDir === 'asc' ? va - vb : vb - va; }
          va = (a[unitSortField] || '').toLowerCase();
          vb = (b[unitSortField] || '').toLowerCase();
          return unitSortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
        });

        document.getElementById('unitCountLabel').textContent = unitList.length + ' UNITÉ' + (unitList.length > 1 ? 'S' : '');
        const tb = document.getElementById('unitActivityBody');
        if (!unitList.length) {
          tb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Aucune activité pour cette période</td></tr>';
          return;
        }
        tb.innerHTML = unitList.map(u => {
          const typesStr = Object.entries(u.types).sort((a,b) => b[1] - a[1]).map(([t,c]) => `${t}: ${c}`).join(', ');
          return `<tr>
            <td>${u.matricule}</td>
            <td style="font-size:0.75rem;">${u.nom_steam || '-'}</td>
            <td style="font-size:0.75rem;">${u.division || '-'}</td>
            <td style="font-weight:700;color:var(--accent-cyan);">${u.total}</td>
            <td style="font-size:0.72rem;color:var(--text-muted);max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${typesStr}">${typesStr}</td>
          </tr>`;
        }).join('');
      };

      window.sortUnitsBy = function(field) {
        if (unitSortField === field) unitSortDir = unitSortDir === 'asc' ? 'desc' : 'asc';
        else { unitSortField = field; unitSortDir = field === 'total' ? 'desc' : 'asc'; }
        renderUnitActivity();
      };

      onAuthStateChanged(auth, async(user) => {
        if(!user){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
        try {
          const s = await getDoc(doc(db,'users',user.uid));
          if(!s.exists()){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
          const ud = s.data();
          if(!ud.approved){document.getElementById('loading').style.display='none';document.getElementById('notApproved').style.display='block';return;}
          document.getElementById('loading').style.display='none';
          document.getElementById('mainContent').style.display='block';
          try { allReports = await loadReports(); } catch(_) { allReports = []; }
          try { allUnits = await loadUnits(); } catch(_) { allUnits = []; }
          updateAll();
        } catch(e) { console.error(e); document.getElementById('loading').style.display='none'; document.getElementById('access-denied').style.display='block'; }
      });
    </script>
</body>
</html>
