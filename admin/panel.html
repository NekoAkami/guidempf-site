<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MPF Documentation</title>
    <link rel="stylesheet" href="../assets/css/main-style.css">
    <link rel="stylesheet" href="../assets/css/combine-terminals.css">
    <link rel="stylesheet" href="../assets/css/global-nav.css">
    <link rel="stylesheet" href="../assets/css/interactive-system.css">
    <link rel="stylesheet" href="../assets/css/combine-animations.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <style>
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        .stat-box {
            background: rgba(0, 170, 255, 0.03);
            border: 1px solid rgba(0, 170, 255, 0.15);
            padding: 1rem;
            text-align: center;
            border-radius: 4px;
        }
        .stat-box .number {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-cyan);
            font-weight: 700;
        }
        .stat-box .label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-top: 0.3rem;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        .admin-table th {
            text-align: left;
            padding: 0.6rem 0.5rem;
            color: var(--accent-cyan);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.2);
            white-space: nowrap;
        }
        .admin-table td {
            padding: 0.5rem;
            color: var(--text-primary);
            border-bottom: 1px solid rgba(0, 170, 255, 0.06);
            vertical-align: middle;
        }
        .admin-table tr:hover {
            background: rgba(0, 170, 255, 0.03);
        }
        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }
        .badge-approved { background: rgba(0, 200, 80, 0.15); color: #00cc55; border: 1px solid rgba(0, 200, 80, 0.3); }
        .badge-pending { background: rgba(255, 170, 0, 0.15); color: #ffaa00; border: 1px solid rgba(255, 170, 0, 0.3); }
        .badge-revoked { background: rgba(255, 60, 60, 0.15); color: #ff4444; border: 1px solid rgba(255, 60, 60, 0.3); }
        .badge-admin { background: rgba(0, 170, 255, 0.15); color: var(--accent-cyan); border: 1px solid rgba(0, 170, 255, 0.3); }
        .btn-sm {
            padding: 0.25rem 0.6rem;
            font-size: 0.72rem;
            font-family: 'Share Tech Mono', monospace;
            cursor: pointer;
            border: 1px solid rgba(0, 170, 255, 0.3);
            background: rgba(0, 170, 255, 0.08);
            color: var(--accent-cyan);
            border-radius: 2px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-sm:hover { background: rgba(0, 170, 255, 0.2); }
        .btn-sm.danger { border-color: rgba(255, 60, 60, 0.3); background: rgba(255, 60, 60, 0.08); color: #ff4444; }
        .btn-sm.danger:hover { background: rgba(255, 60, 60, 0.2); }
        .btn-sm.success { border-color: rgba(0, 200, 80, 0.3); background: rgba(0, 200, 80, 0.08); color: #00cc55; }
        .btn-sm.success:hover { background: rgba(0, 200, 80, 0.2); }
        .action-cell { display: flex; gap: 0.3rem; flex-wrap: wrap; }
        .filter-row {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .filter-row input, .filter-row select {
            padding: 0.4rem 0.7rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            outline: none;
            border-radius: 2px;
        }
        .filter-row input:focus, .filter-row select:focus {
            border-color: var(--accent-cyan);
        }
        .filter-row input { flex: 1; min-width: 200px; }
        .pending-section {
            background: rgba(255, 170, 0, 0.04);
            border: 1px solid rgba(255, 170, 0, 0.2);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .pending-section h3 {
            color: #ffaa00;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85rem;
            margin: 0 0 0.8rem;
            letter-spacing: 1px;
        }
        .pending-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.6rem 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 170, 0, 0.1);
            border-radius: 3px;
            margin-bottom: 0.4rem;
            flex-wrap: wrap;
        }
        .pending-info { display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: center; }
        .pending-info span { font-size: 0.78rem; color: var(--text-muted); }
        .pending-info strong { color: var(--text-primary); }
        .alert-msg {
            padding: 0.6rem 1rem;
            border-radius: 3px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            font-family: 'Share Tech Mono', monospace;
            display: none;
        }
        .alert-msg.success { background: rgba(0, 200, 80, 0.1); border: 1px solid rgba(0, 200, 80, 0.3); color: #00cc55; }
        .alert-msg.error { background: rgba(255, 60, 60, 0.1); border: 1px solid rgba(255, 60, 60, 0.3); color: #ff4444; }
        .table-scroll { overflow-x: auto; }
        #access-denied { display: none; text-align: center; padding: 3rem; }

        /* Admin nav */
        .admin-nav {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
        }
        .admin-nav a {
            padding: 0.35rem 0.8rem;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-decoration: none;
            border: 1px solid rgba(0, 170, 255, 0.15);
            border-radius: 2px;
            transition: all 0.15s;
        }
        .admin-nav a:hover, .admin-nav a.active {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            background: rgba(0, 170, 255, 0.08);
        }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>

    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">Admin Panel</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>

    <!-- Navigation globale insÃ©rÃ©e automatiquement par global-nav.js -->

    <main>
        <div class="container">
            <!-- Loading / Access denied -->
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT DES DONNÃ‰ES...</p>
            </div>
            <div id="access-denied">
                <h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">ACCÃˆS REFUSÃ‰</h2>
                <p style="color:var(--text-muted);">Vous n'avez pas les droits administrateur.</p>
                <a href="../index.html" style="color:var(--accent-cyan);">Retour au site</a>
            </div>

            <!-- Main admin content (hidden until auth) -->
            <div id="adminContent" style="display:none;">

                <!-- Admin navigation -->
                <div class="admin-nav" style="margin-top: 1rem;">
                    <a href="panel.html" class="active">PANEL ADMIN</a>
                    <a href="unites.html">UNITÃ‰S</a>
                    <a href="heures.html">HEURES DE JEU</a>
                    <a href="heures-archives.html">ARCHIVES</a>
                    <a href="absences.html">ABSENCES</a>
                </div>

                <!-- Section Maintenance -->
                <div id="maintenanceSection" class="combine-terminal-wrapper" style="margin-bottom: 1.5rem;">
                    <div class="combine-header" style="cursor:pointer;" onclick="document.getElementById('maintenanceBody').style.display = document.getElementById('maintenanceBody').style.display === 'none' ? '' : 'none';">
                        <h2 id="maintSectionTitle">ðŸ”§ MAINTENANCE</h2>
                        <span class="header-code" id="maintStatusBadge">VÃ‰RIFICATION...</span>
                    </div>
                    <div class="combine-body" id="maintenanceBody">
                        <!-- Status actuel -->
                        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;">
                            <div id="maintCurrentStatus" style="font-family:'Share Tech Mono',monospace;font-size:0.85rem;padding:0.4rem 1rem;border-radius:3px;"></div>
                            <div id="maintActivatedInfo" style="font-size:0.75rem;color:var(--text-muted);font-family:'Share Tech Mono',monospace;"></div>
                        </div>

                        <!-- Formulaire activation -->
                        <div id="maintActivateForm" style="margin-bottom:1rem;">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;margin-bottom:0.8rem;">
                                <div>
                                    <label style="font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:var(--text-muted);letter-spacing:1px;">MESSAGE DE MAINTENANCE</label>
                                    <textarea id="maintMessage" rows="2" style="width:100%;padding:0.5rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.2);color:var(--text-primary);font-family:'Rajdhani',sans-serif;font-size:0.85rem;outline:none;border-radius:3px;resize:vertical;margin-top:0.3rem;" placeholder="Le site est temporairement indisponible pour maintenance."></textarea>
                                </div>
                                <div>
                                    <label style="font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:var(--text-muted);letter-spacing:1px;">RETOUR ESTIMÃ‰</label>
                                    <input type="datetime-local" id="maintReturnTime" style="width:100%;padding:0.5rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.2);color:var(--text-primary);font-family:'Share Tech Mono',monospace;font-size:0.8rem;outline:none;border-radius:3px;margin-top:0.3rem;">
                                    <div style="font-size:0.65rem;color:var(--text-muted);margin-top:0.2rem;">Optionnel â€” affichera un compte Ã  rebours</div>
                                </div>
                            </div>
                            <div style="display:flex;gap:0.6rem;flex-wrap:wrap;">
                                <button id="maintEnableBtn" class="btn-sm danger" style="font-weight:700;padding:0.4rem 1.2rem;">âš  ACTIVER MAINTENANCE</button>
                                <button id="maintDisableBtn" class="btn-sm success" style="font-weight:700;padding:0.4rem 1.2rem;display:none;">âœ“ REMETTRE EN LIGNE</button>
                                <a href="../maintenance.html" target="_blank" class="btn-sm" style="text-decoration:none;display:inline-flex;align-items:center;">APERÃ‡U PAGE â†—</a>
                            </div>
                        </div>

                        <!-- Journal maintenance -->
                        <details style="margin-top:0.8rem;">
                            <summary style="cursor:pointer;font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:var(--accent-cyan);letter-spacing:1px;user-select:none;">JOURNAL DE MAINTENANCE</summary>
                            <div id="maintLogs" style="margin-top:0.5rem;max-height:200px;overflow-y:auto;"></div>
                        </details>
                    </div>
                </div>

                <!-- Stats -->
                <div class="admin-stats" style="margin-top:1rem;">
                    <div class="stat-box">
                        <div class="number" id="totalCount">0</div>
                        <div class="label">TOTAL</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="approvedCount">0</div>
                        <div class="label">APPROUVÃ‰S</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="pendingCount" style="color:#ffaa00;">0</div>
                        <div class="label">EN ATTENTE</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="adminCount">0</div>
                        <div class="label">ADMINS</div>
                    </div>
                </div>

                <!-- Pending requests -->
                <div id="pendingSection" class="pending-section" style="display:none;">
                    <h3>âš  DEMANDES EN ATTENTE D'APPROBATION</h3>
                    <div id="pendingList"></div>
                </div>

                <!-- Alert message -->
                <div id="actionMessage" class="alert-msg"></div>

                <!-- All users table -->
                <div class="combine-terminal-wrapper">
                    <div class="combine-header">
                        <h2>LISTE DES UTILISATEURS</h2>
                        <span class="header-code">FIRESTORE // USERS DATABASE</span>
                    </div>
                    <div class="combine-body">
                        <div class="filter-row">
                            <input type="text" id="searchInput" placeholder="Rechercher email, matricule, steam, discord..." autocomplete="off">
                            <select id="statusFilter">
                                <option value="">Tous</option>
                                <option value="PENDING">En attente</option>
                                <option value="APPROVED">ApprouvÃ©s</option>
                                <option value="REVOKED">RÃ©voquÃ©s</option>
                            </select>
                        </div>
                        <div class="table-scroll">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>MATRICULE</th>
                                        <th>EMAIL</th>
                                        <th>NOM STEAM</th>
                                        <th>DISCORD</th>
                                        <th>STEAMID64</th>
                                        <th>ADMIN</th>
                                        <th>FORMATEUR</th>
                                        <th>STATUT</th>
                                        <th>DATE</th>
                                        <th>ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="usersList">
                                    <tr><td colspan="10" style="text-align:center;color:var(--text-muted);">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts standard du site (global-nav.js dÃ©tecte automatiquement le sous-dossier) -->
    <script type="module" src="../assets/js/auth.js"></script>
    <script src="../assets/js/global-nav.js"></script>
    <script src="../assets/js/interactive-system.js"></script>
    <script src="../assets/js/combine-animations.js"></script>

    <!-- Script admin-spÃ©cifique (importe depuis auth.js, pas de double init Firebase) -->
    <script type="module">
        // ====== MAINTENANCE SYSTEM ======
        (async () => {
          const { setMaintenanceMode, getMaintenanceInfo, getMaintenanceLogs, listenMaintenanceMode } = await import('../assets/js/maintenance.js');
          const { auth } = await import('../assets/js/auth.js');
          const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
          const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

          const enableBtn = document.getElementById('maintEnableBtn');
          const disableBtn = document.getElementById('maintDisableBtn');
          const statusEl = document.getElementById('maintCurrentStatus');
          const statusBadge = document.getElementById('maintStatusBadge');
          const activatedInfo = document.getElementById('maintActivatedInfo');
          const logsContainer = document.getElementById('maintLogs');
          const messageInput = document.getElementById('maintMessage');
          const returnInput = document.getElementById('maintReturnTime');

          let currentUserMatricule = '';

          // RÃ©cupÃ©rer le matricule de l'admin connectÃ©
          onAuthStateChanged(auth, async (user) => {
            if (!user) return;
            try {
              const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              const db = (await import('../assets/js/auth.js')).db;
              const snap = await getDoc(doc(db, 'users', user.uid));
              if (snap.exists()) currentUserMatricule = snap.data().matricule || user.email;
            } catch {}
          });

          // Ã‰coute temps rÃ©el
          listenMaintenanceMode((data) => {
            const enabled = data.enabled === true;
            if (enabled) {
              statusEl.innerHTML = '<span style="color:#ffaa00;font-weight:700;">âš  MODE MAINTENANCE ACTIF</span>';
              statusEl.style.background = 'rgba(255,170,0,0.1)';
              statusEl.style.border = '1px solid rgba(255,170,0,0.3)';
              statusBadge.textContent = 'âš  MAINTENANCE ACTIVE';
              statusBadge.style.color = '#ffaa00';
              enableBtn.style.display = 'none';
              disableBtn.style.display = '';
              if (data.activated_at) {
                const d = new Date(data.activated_at);
                let info = 'ActivÃ©e le ' + d.toLocaleString('fr-FR');
                if (data.activated_by) info += ' par ' + data.activated_by;
                activatedInfo.textContent = info;
              }
              if (data.message) messageInput.value = data.message;
              if (data.estimated_return) {
                try { returnInput.value = new Date(data.estimated_return).toISOString().slice(0, 16); } catch {}
              }
            } else {
              statusEl.innerHTML = '<span style="color:#00cc55;font-weight:700;">âœ“ SITE EN LIGNE</span>';
              statusEl.style.background = 'rgba(0,200,80,0.1)';
              statusEl.style.border = '1px solid rgba(0,200,80,0.3)';
              statusBadge.textContent = 'âœ“ EN LIGNE';
              statusBadge.style.color = '#00cc55';
              enableBtn.style.display = '';
              disableBtn.style.display = 'none';
              activatedInfo.textContent = '';
            }
          });

          // Charger les logs
          async function loadLogs() {
            const logs = await getMaintenanceLogs(15);
            if (logs.length === 0) {
              logsContainer.innerHTML = '<div style="font-size:0.75rem;color:var(--text-muted);padding:0.5rem;">Aucun historique</div>';
              return;
            }
            logsContainer.innerHTML = logs.map(l => {
              const d = new Date(l.timestamp);
              const isActivation = l.action === 'ACTIVATION';
              const color = isActivation ? '#ffaa00' : '#00cc55';
              return `<div style="display:flex;gap:0.8rem;align-items:baseline;padding:0.3rem 0;border-bottom:1px solid rgba(0,170,255,0.06);font-size:0.72rem;">
                <span style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;min-width:110px;">${d.toLocaleString('fr-FR', {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'})}</span>
                <span style="color:${color};font-weight:700;min-width:100px;">${l.action}</span>
                <span style="color:var(--text-muted);">par <strong style="color:var(--text-primary);">${l.by}</strong></span>
                ${l.message ? `<span style="color:var(--text-muted);font-style:italic;">"${l.message.substring(0, 60)}${l.message.length > 60 ? '...' : ''}"</span>` : ''}
              </div>`;
            }).join('');
          }
          loadLogs();

          // Activer la maintenance
          enableBtn.onclick = async () => {
            if (!confirm('Activer le mode maintenance ? Les utilisateurs seront redirigÃ©s.')) return;
            const msg = messageInput.value.trim() || 'Le site est temporairement indisponible pour maintenance.';
            const ret = returnInput.value ? new Date(returnInput.value).toISOString() : '';
            try {
              await setMaintenanceMode(true, {
                message: msg,
                estimated_return: ret,
                activated_by: currentUserMatricule
              });
              showMessage('âœ“ Mode maintenance activÃ©', 'success');
              loadLogs();
            } catch (err) {
              showMessage('âœ— Erreur: ' + err.message, 'error');
            }
          };

          // DÃ©sactiver la maintenance
          disableBtn.onclick = async () => {
            if (!confirm('Remettre le site en ligne ?')) return;
            try {
              await setMaintenanceMode(false, { activated_by: currentUserMatricule });
              messageInput.value = '';
              returnInput.value = '';
              showMessage('âœ“ Site remis en ligne', 'success');
              loadLogs();
            } catch (err) {
              showMessage('âœ— Erreur: ' + err.message, 'error');
            }
          };
        })();
      import { auth, db } from '../assets/js/auth.js';
      import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { collection, getDocs, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        loadUnits as ghLoadUnits, saveUnits as ghSaveUnits
      } from '../assets/js/github-data.js';

      let allUsers = [];
      let allUnitsCache = [];

      function showMessage(text, type = 'success') {
        const msg = document.getElementById('actionMessage');
        msg.style.display = 'block';
        msg.className = 'alert-msg ' + type;
        msg.textContent = text;
        setTimeout(() => { msg.style.display = 'none'; }, 4000);
      }

      async function loadUsers() {
        try {
          const [q, units] = await Promise.all([
            getDocs(collection(db, 'users')),
            ghLoadUnits().catch(() => [])
          ]);
          allUnitsCache = units;
          allUsers = [];
          q.forEach(snap => {
            allUsers.push({ id: snap.id, ...snap.data() });
          });
          // Pending first, then newest first
          allUsers.sort((a, b) => {
            if (a.approved !== b.approved) return a.approved ? 1 : -1;
            return (b.created_at || '').localeCompare(a.created_at || '');
          });
          updateStats();
          renderPending();
          renderUsers(allUsers);
        } catch (err) {
          console.error('loadUsers error:', err);
          showMessage('Erreur chargement: ' + err.message, 'error');
        }
      }

      function updateStats() {
        const total = allUsers.length;
        const approved = allUsers.filter(u => u.approved === true).length;
        const pending = allUsers.filter(u => u.approved !== true && u.status !== 'REVOKED').length;
        const admins = allUsers.filter(u => u.is_admin === true).length;
        document.getElementById('totalCount').textContent = total;
        document.getElementById('approvedCount').textContent = approved;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('adminCount').textContent = admins;
      }

      function renderPending() {
        const pending = allUsers.filter(u => u.approved !== true && u.status !== 'REVOKED');
        const section = document.getElementById('pendingSection');
        const list = document.getElementById('pendingList');

        if (pending.length === 0) {
          section.style.display = 'none';
          return;
        }

        section.style.display = 'block';
        list.innerHTML = pending.map(u => `
          <div class="pending-card">
            <div class="pending-info">
              <span>Matricule: <strong>${u.matricule || '???'}</strong></span>
              <span>${u.email || '-'}</span>
              <span>Steam: <strong>${u.nom_steam || '-'}</strong></span>
              <span>Discord: <strong>${u.discord || '-'}</strong></span>
              <span style="font-size:0.7rem;">${u.created_at ? u.created_at.substring(0, 10) : ''}</span>
            </div>
            <div class="action-cell">
              <button class="btn-sm success" onclick="approveUser('${u.id}')">âœ“ APPROUVER</button>
              <button class="btn-sm danger" onclick="revokeUser('${u.id}')">âœ— REFUSER</button>
            </div>
          </div>
        `).join('');
      }

      function renderUsers(users) {
        const tbody = document.getElementById('usersList');
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--text-muted);">Aucun utilisateur</td></tr>';
          return;
        }
        tbody.innerHTML = users.map(u => {
          const statusBadge = u.status === 'APPROVED'
            ? '<span class="badge badge-approved">APPROUVÃ‰</span>'
            : u.status === 'REVOKED'
              ? '<span class="badge badge-revoked">RÃ‰VOQUÃ‰</span>'
              : '<span class="badge badge-pending">EN ATTENTE</span>';
          const adminBadge = u.is_admin
            ? '<span class="badge badge-admin">ADMIN</span>'
            : '<span style="color:var(--text-muted);">-</span>';

          const unitEntry = allUnitsCache.find(unit => unit.matricule === u.matricule);
          const isFormateur = unitEntry && unitEntry.formateur;
          const formateurBadge = isFormateur
            ? '<span class="badge badge-admin" style="background:rgba(0,229,255,0.12);border-color:rgba(0,229,255,0.3);color:#00e5ff;">FORMATEUR</span>'
            : '<span style="color:var(--text-muted);">-</span>';
          const formateurToggle = u.approved && u.status !== 'REVOKED' && u.matricule
            ? `<button class="btn-sm" style="font-size:0.62rem;" onclick="toggleFormateur('${(u.matricule || '').replace(/'/g, "\\'")}')">F</button>`
            : '';

          let actions = '';
          if (!u.approved && u.status !== 'REVOKED') {
            actions += `<button class="btn-sm success" onclick="approveUser('${u.id}')">âœ“</button>`;
            actions += `<button class="btn-sm danger" onclick="revokeUser('${u.id}')">âœ—</button>`;
          }
          if (u.approved && u.status !== 'REVOKED') {
            actions += `<button class="btn-sm danger" onclick="revokeUser('${u.id}')">RÃ‰VOQUER</button>`;
          }
          if (u.status === 'REVOKED') {
            actions += `<button class="btn-sm" onclick="reactivateUser('${u.id}')">â†» RÃ‰ACTIVER</button>`;
          }

          return `<tr>
            <td><strong style="color:var(--accent-cyan);">${u.matricule || '-'}</strong></td>
            <td>${u.email || '-'}</td>
            <td>${u.nom_steam || '<span style="color:var(--text-muted);">-</span>'}</td>
            <td>${u.discord || '<span style="color:var(--text-muted);">-</span>'}</td>
            <td style="font-size:0.72rem;">${u.steamid64 || '<span style="color:var(--text-muted);">-</span>'}</td>
            <td>${adminBadge}</td>
            <td>${formateurBadge}</td>
            <td>${statusBadge}</td>
            <td style="font-size:0.72rem;color:var(--text-muted);">${u.created_at ? u.created_at.substring(0, 10) : '-'}</td>
            <td class="action-cell">${formateurToggle} ${actions}</td>
          </tr>`;
        }).join('');
      }

      function filterUsers() {
        const search = (document.getElementById('searchInput').value || '').toLowerCase();
        const status = document.getElementById('statusFilter').value;

        let filtered = allUsers.filter(u => {
          const matchSearch = !search ||
            (u.email || '').toLowerCase().includes(search) ||
            (u.matricule || '').includes(search) ||
            (u.nom_steam || '').toLowerCase().includes(search) ||
            (u.discord || '').toLowerCase().includes(search) ||
            (u.steamid64 || '').includes(search);
          const matchStatus = !status || (u.status === status);
          return matchSearch && matchStatus;
        });
        renderUsers(filtered);
      }

      window.approveUser = async (userId) => {
        try {
          // 1) Approve the user in Firestore
          await updateDoc(doc(db, 'users', userId), {
            approved: true,
            status: 'APPROVED',
            approved_at: new Date().toISOString()
          });

          // 2) Auto-link or create unit in JSON via GitHub API
          const userData = allUsers.find(u => u.id === userId);
          if (userData && userData.matricule) {
            try {
                const units = await ghLoadUnits();
                const today = new Date().toISOString().substring(0, 10);

                // Chercher par SteamID64 OU par matricule (lien automatique)
                const bySteam = userData.steamid64 ? units.findIndex(u => u.steamid64 === userData.steamid64) : -1;
                const byMatricule = units.findIndex(u => u.matricule === userData.matricule);
                const existingIdx = bySteam !== -1 ? bySteam : byMatricule;

                if (existingIdx !== -1) {
                  // UnitÃ© existante trouvÃ©e â†’ mise Ã  jour avec les infos d'inscription
                  const existing = units[existingIdx];
                  units[existingIdx] = {
                    ...existing,
                    matricule: userData.matricule,
                    steamid64: userData.steamid64 || existing.steamid64 || '',
                    nom_steam: userData.nom_steam || existing.nom_steam || '',
                    discord: userData.discord || existing.discord || '',
                    updated_at: today
                  };
                  await ghSaveUnits(units, `Liaison unitÃ© ${userData.matricule} (approbation â€” SteamID match)`);
                  showMessage('âœ“ Utilisateur approuvÃ© â€” unitÃ© existante liÃ©e automatiquement', 'success');
                } else {
                  // Aucune unitÃ© existante â†’ en crÃ©er une nouvelle
                  units.push({
                    matricule: userData.matricule,
                    steamid64: userData.steamid64 || '',
                    nom_steam: userData.nom_steam || '',
                    discord: userData.discord || '',
                    division: 'N/A',
                    rang: 'MISSING',
                    ordre: '',
                    date_entree: today,
                    updated_at: today
                  });
                  await ghSaveUnits(units, `Ajout unitÃ© ${userData.matricule} (approbation)`);
                  showMessage('âœ“ Utilisateur approuvÃ© + nouvelle unitÃ© crÃ©Ã©e', 'success');
                }
            } catch (ghErr) {
              console.warn('Units update failed:', ghErr.message);
              showMessage('âœ“ ApprouvÃ© (âš  erreur mise Ã  jour unitÃ©s: ' + ghErr.message + ')', 'success');
            }
          } else {
            showMessage('âœ“ Utilisateur approuvÃ©', 'success');
          }

          await loadUsers();
        } catch (err) {
          showMessage('âœ— Erreur: ' + err.message, 'error');
        }
      };

      window.revokeUser = async (userId) => {
        if (!confirm('RÃ©voquer cet utilisateur ?')) return;
        try {
          await updateDoc(doc(db, 'users', userId), {
            approved: false,
            status: 'REVOKED',
            revoked_at: new Date().toISOString()
          });
          showMessage('âœ“ Utilisateur rÃ©voquÃ©', 'success');
          await loadUsers();
        } catch (err) {
          showMessage('âœ— Erreur: ' + err.message, 'error');
        }
      };

      window.reactivateUser = async (userId) => {
        try {
          await updateDoc(doc(db, 'users', userId), {
            approved: true,
            status: 'APPROVED',
            reactivated_at: new Date().toISOString()
          });
          showMessage('âœ“ Utilisateur rÃ©activÃ©', 'success');
          await loadUsers();
        } catch (err) {
          showMessage('âœ— Erreur: ' + err.message, 'error');
        }
      };

      window.toggleFormateur = async (matricule) => {
        try {
          const units = await ghLoadUnits();
          const idx = units.findIndex(u => u.matricule === matricule);
          if (idx === -1) {
            showMessage('âš  UnitÃ© introuvable pour ' + matricule, 'error');
            return;
          }
          const current = units[idx].formateur || false;
          units[idx].formateur = !current;
          units[idx].updated_at = new Date().toISOString().substring(0, 10);
          await ghSaveUnits(units, `${!current ? 'Ajout' : 'Retrait'} formateur ${matricule}`);
          allUnitsCache = units;
          renderUsers(allUsers);
          showMessage(`âœ“ ${matricule} â€” Formateur ${!current ? 'ACTIVÃ‰' : 'DÃ‰SACTIVÃ‰'}`, 'success');
        } catch (err) {
          showMessage('âœ— Erreur formateur: ' + err.message, 'error');
        }
      };

      document.getElementById('searchInput').addEventListener('input', filterUsers);
      document.getElementById('statusFilter').addEventListener('change', filterUsers);

      // Auth check â€” admin + HG (Ofc/Cmd) pour maintenance uniquement
      onAuthStateChanged(auth, async (user) => {
        if (!user) return; // auth.js redirige dÃ©jÃ  vers login
        try {
          const snap = await getDoc(doc(db, 'users', user.uid));
          if (!snap.exists()) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('access-denied').style.display = 'block';
            return;
          }
          const uData = snap.data();
          const isAdmin = uData.is_admin === true;
          // VÃ©rifier HG depuis units.json
          let isHG = false;
          const userMatricule = uData.matricule || '';
          if (userMatricule) {
            try {
              const res = await fetch('https://raw.githubusercontent.com/NekoAkami/guidempf-site/main/data/units.json');
              if (res.ok) {
                const units = await res.json();
                const unit = units.find(u => u.matricule === userMatricule);
                if (unit && (unit.rang === 'Ofc' || unit.rang === 'Cmd')) isHG = true;
              }
            } catch (_) {}
          }
          if (!isAdmin && !isHG) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('access-denied').style.display = 'block';
            return;
          }
          document.getElementById('loading').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
          if (isAdmin) {
            // Admin : accÃ¨s complet
            await loadUsers();
          } else {
            // HG : uniquement la section maintenance visible
            document.querySelectorAll('#adminContent > .combine-terminal-wrapper').forEach(el => {
              if (el.id !== 'maintenanceSection') el.style.display = 'none';
            });
            // Masquer aussi les stats et autres sections non-maintenance
            document.querySelectorAll('#adminContent > div:not(.combine-terminal-wrapper)').forEach(el => {
              if (!el.closest('#maintenanceSection')) el.style.display = 'none';
            });
          }
        } catch (err) {
          console.error('Admin auth error:', err);
          document.getElementById('loading').innerHTML = '<p style="color:#ff4444;">Erreur: ' + err.message + '</p>';
        }
      });
    </script>
</body>
</html>
