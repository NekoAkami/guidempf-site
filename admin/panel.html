<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MPF Documentation</title>
    <link rel="stylesheet" href="../assets/css/bundle.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <style>
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        .stat-box {
            background: rgba(0, 170, 255, 0.03);
            border: 1px solid rgba(0, 170, 255, 0.15);
            padding: 1rem;
            text-align: center;
            border-radius: 4px;
        }
        .stat-box .number {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-cyan);
            font-weight: 700;
        }
        .stat-box .label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-top: 0.3rem;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        .admin-table th {
            text-align: left;
            padding: 0.6rem 0.5rem;
            color: var(--accent-cyan);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.2);
            white-space: nowrap;
        }
        .admin-table td {
            padding: 0.5rem;
            color: var(--text-primary);
            border-bottom: 1px solid rgba(0, 170, 255, 0.06);
            vertical-align: middle;
        }
        .admin-table tr:hover {
            background: rgba(0, 170, 255, 0.03);
        }
        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }
        .badge-approved { background: rgba(0, 200, 80, 0.15); color: #00cc55; border: 1px solid rgba(0, 200, 80, 0.3); }
        .badge-pending { background: rgba(255, 170, 0, 0.15); color: #ffaa00; border: 1px solid rgba(255, 170, 0, 0.3); }
        .badge-revoked { background: rgba(255, 60, 60, 0.15); color: #ff4444; border: 1px solid rgba(255, 60, 60, 0.3); }
        .badge-admin { background: rgba(0, 170, 255, 0.15); color: var(--accent-cyan); border: 1px solid rgba(0, 170, 255, 0.3); }
        .badge-linked { background: rgba(0, 200, 80, 0.12); color: #00cc55; border: 1px solid rgba(0, 200, 80, 0.25); }
        .badge-unlinked { background: rgba(255, 170, 0, 0.12); color: #ffaa00; border: 1px solid rgba(255, 170, 0, 0.25); }
        .btn-sm {
            padding: 0.25rem 0.6rem;
            font-size: 0.72rem;
            font-family: 'Share Tech Mono', monospace;
            cursor: pointer;
            border: 1px solid rgba(0, 170, 255, 0.3);
            background: rgba(0, 170, 255, 0.08);
            color: var(--accent-cyan);
            border-radius: 2px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-sm:hover { background: rgba(0, 170, 255, 0.2); }
        .btn-sm.danger { border-color: rgba(255, 60, 60, 0.3); background: rgba(255, 60, 60, 0.08); color: #ff4444; }
        .btn-sm.danger:hover { background: rgba(255, 60, 60, 0.2); }
        .btn-sm.success { border-color: rgba(0, 200, 80, 0.3); background: rgba(0, 200, 80, 0.08); color: #00cc55; }
        .btn-sm.success:hover { background: rgba(0, 200, 80, 0.2); }
        .action-cell { display: flex; gap: 0.3rem; flex-wrap: wrap; }
        .filter-row {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .filter-row input, .filter-row select {
            padding: 0.4rem 0.7rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            outline: none;
            border-radius: 2px;
        }
        .filter-row input:focus, .filter-row select:focus {
            border-color: var(--accent-cyan);
        }
        .filter-row input { flex: 1; min-width: 200px; }
        .pending-section {
            background: rgba(255, 170, 0, 0.04);
            border: 1px solid rgba(255, 170, 0, 0.2);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .pending-section h3 {
            color: #ffaa00;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85rem;
            margin: 0 0 0.8rem;
            letter-spacing: 1px;
        }
        .pending-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.6rem 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 170, 0, 0.1);
            border-radius: 3px;
            margin-bottom: 0.4rem;
            flex-wrap: wrap;
        }
        .pending-info { display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: center; }
        .pending-info span { font-size: 0.78rem; color: var(--text-muted); }
        .pending-info strong { color: var(--text-primary); }
        .alert-msg {
            padding: 0.6rem 1rem;
            border-radius: 3px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            font-family: 'Share Tech Mono', monospace;
            display: none;
        }
        .alert-msg.success { background: rgba(0, 200, 80, 0.1); border: 1px solid rgba(0, 200, 80, 0.3); color: #00cc55; }
        .alert-msg.error { background: rgba(255, 60, 60, 0.1); border: 1px solid rgba(255, 60, 60, 0.3); color: #ff4444; }
        .table-scroll { overflow-x: auto; }
        #access-denied { display: none; text-align: center; padding: 3rem; }

        /* Admin nav */
        .admin-nav {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
        }
        .admin-nav a {
            padding: 0.35rem 0.8rem;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-decoration: none;
            border: 1px solid rgba(0, 170, 255, 0.15);
            border-radius: 2px;
            transition: all 0.15s;
        }
        .admin-nav a:hover, .admin-nav a.active {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            background: rgba(0, 170, 255, 0.08);
        }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>

    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">Admin Panel</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>

    <!-- Navigation globale insérée automatiquement par global-nav.js -->

    <main>
        <div class="container">
            <!-- Loading / Access denied -->
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT DES DONNÉES...</p>
            </div>
            <div id="access-denied">
                <h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">ACCÈS REFUSÉ</h2>
                <p style="color:var(--text-muted);">Vous n'avez pas les droits administrateur.</p>
                <a href="../index.html" style="color:var(--accent-cyan);">Retour au site</a>
            </div>

            <!-- Main admin content (hidden until auth) -->
            <div id="adminContent" style="display:none;">

                <!-- Admin navigation -->
                <div class="admin-nav" style="margin-top: 1rem;">
                    <a href="panel.html" class="active">PANEL ADMIN</a>
                    <a href="unites.html">UNITÉS</a>
                    <a href="heures.html">HEURES DE JEU</a>
                    <a href="heures-archives.html">ARCHIVES</a>
                    <a href="absences.html">ABSENCES</a>
                    <a href="maintenance-admin.html">MAINTENANCE</a>
                    <a href="navigation.html">NAVIGATION</a>
                </div>

                <!-- Stats -->
                <div class="admin-stats" style="margin-top:1rem;">
                    <div class="stat-box">
                        <div class="number" id="totalCount">0</div>
                        <div class="label">TOTAL</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="approvedCount">0</div>
                        <div class="label">APPROUVÉS</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="pendingCount" style="color:#ffaa00;">0</div>
                        <div class="label">EN ATTENTE</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="adminCount">0</div>
                        <div class="label">ADMINS</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="linkedCount" style="color:#00cc55;">0</div>
                        <div class="label">REGISTER</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="unlinkedCount" style="color:#ffaa00;">0</div>
                        <div class="label">MISSING</div>
                    </div>
                </div>

                <!-- Pending requests -->
                <div id="pendingSection" class="pending-section" style="display:none;">
                    <h3>⚠ DEMANDES EN ATTENTE D'APPROBATION</h3>
                    <div id="pendingList"></div>
                </div>

                <!-- Alert message -->
                <div id="actionMessage" class="alert-msg"></div>

                <!-- All users table -->
                <div class="combine-terminal-wrapper">
                    <div class="combine-header">
                        <h2>LISTE DES UTILISATEURS</h2>
                        <span class="header-code">FIRESTORE // USERS DATABASE</span>
                    </div>
                    <div class="combine-body">
                        <div class="filter-row">
                            <input type="text" id="searchInput" placeholder="Rechercher email, matricule, steam, discord..." autocomplete="off">
                            <select id="statusFilter">
                                <option value="">Tous</option>
                                <option value="PENDING">En attente</option>
                                <option value="APPROVED">Approuvés</option>
                                <option value="REVOKED">Révoqués</option>
                            </select>
                            <select id="unitFilter">
                                <option value="">Unité: Tous</option>
                                <option value="LINKED">Register</option>
                                <option value="UNLINKED">Missing</option>
                            </select>
                        </div>
                        <div class="table-scroll">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>MATRICULE</th>
                                        <th>EMAIL</th>
                                        <th>NOM STEAM</th>
                                        <th>DISCORD</th>
                                        <th>STEAMID64</th>
                                        <th>ADMIN</th>
                                        <th>FORMATEUR</th>
                                        <th>UNITÉ</th>
                                        <th>STATUT</th>
                                        <th>DATE</th>
                                        <th>ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="usersList">
                                    <tr><td colspan="11" style="text-align:center;color:var(--text-muted);">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts standard du site (global-nav.js détecte automatiquement le sous-dossier) -->
    <script type="module" src="../assets/js/auth.js"></script>
    <script src="../assets/js/global-nav.js" defer></script>
    <script src="../assets/js/interactive-system.js" defer></script>
    <script src="../assets/js/combine-animations.js" defer></script>

    <!-- Script admin-spécifique (importe depuis auth.js, pas de double init Firebase) -->
    <script type="module">

      import { auth, db } from '../assets/js/auth.js';
      import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { collection, getDocs, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        loadUnits as ghLoadUnits, saveUnits as ghSaveUnits
      } from '../assets/js/github-data.js';

      let allUsers = [];
      let allUnitsCache = [];

      function showMessage(text, type = 'success') {
        const msg = document.getElementById('actionMessage');
        msg.style.display = 'block';
        msg.className = 'alert-msg ' + type;
        msg.textContent = text;
        setTimeout(() => { msg.style.display = 'none'; }, 4000);
      }

      async function loadUsers() {
        try {
          const [q, units] = await Promise.all([
            getDocs(collection(db, 'users')),
            ghLoadUnits().catch(() => [])
          ]);
          allUnitsCache = units;
          allUsers = [];
          q.forEach(snap => {
            allUsers.push({ id: snap.id, ...snap.data() });
          });
          // Pending first, then newest first
          allUsers.sort((a, b) => {
            if (a.approved !== b.approved) return a.approved ? 1 : -1;
            return (b.created_at || '').localeCompare(a.created_at || '');
          });
          updateStats();
          renderPending();
          renderUsers(allUsers);
        } catch (err) {
          console.error('loadUsers error:', err);
          showMessage('Erreur chargement: ' + err.message, 'error');
        }
      }

      function updateStats() {
        const total = allUsers.length;
        const approved = allUsers.filter(u => u.approved === true).length;
        const pending = allUsers.filter(u => u.approved !== true && u.status !== 'REVOKED').length;
        const admins = allUsers.filter(u => u.is_admin === true).length;
        const linked = allUsers.filter(u => { const ue = u.matricule && allUnitsCache.find(unit => unit.matricule === u.matricule); return ue && ue.rang && ue.rang !== 'MISSING'; }).length;
        const unlinked = allUsers.filter(u => { const ue = u.matricule && allUnitsCache.find(unit => unit.matricule === u.matricule); return !ue || !ue.rang || ue.rang === 'MISSING'; }).length;
        document.getElementById('totalCount').textContent = total;
        document.getElementById('approvedCount').textContent = approved;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('adminCount').textContent = admins;
        document.getElementById('linkedCount').textContent = linked;
        document.getElementById('unlinkedCount').textContent = unlinked;
      }

      function renderPending() {
        const pending = allUsers.filter(u => u.approved !== true && u.status !== 'REVOKED');
        const section = document.getElementById('pendingSection');
        const list = document.getElementById('pendingList');

        if (pending.length === 0) {
          section.style.display = 'none';
          return;
        }

        section.style.display = 'block';
        list.innerHTML = pending.map(u => `
          <div class="pending-card">
            <div class="pending-info">
              <span>Matricule: <strong>${u.matricule || '???'}</strong></span>
              <span>${u.email || '-'}</span>
              <span>Steam: <strong>${u.nom_steam || '-'}</strong></span>
              <span>Discord: <strong>${u.discord || '-'}</strong></span>
              <span style="font-size:0.7rem;">${u.created_at ? u.created_at.substring(0, 10) : ''}</span>
            </div>
            <div class="action-cell">
              <button class="btn-sm success" onclick="approveUser('${u.id}')">✓ APPROUVER</button>
              <button class="btn-sm danger" onclick="revokeUser('${u.id}')">✗ REFUSER</button>
            </div>
          </div>
        `).join('');
      }

      function renderUsers(users) {
        const tbody = document.getElementById('usersList');
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:var(--text-muted);">Aucun utilisateur</td></tr>';
          return;
        }
        tbody.innerHTML = users.map(u => {
          const statusBadge = u.status === 'APPROVED'
            ? '<span class="badge badge-approved">APPROUVÉ</span>'
            : u.status === 'REVOKED'
              ? '<span class="badge badge-revoked">RÉVOQUÉ</span>'
              : '<span class="badge badge-pending">EN ATTENTE</span>';
          const adminBadge = u.is_admin
            ? '<span class="badge badge-admin">ADMIN</span>'
            : '<span style="color:var(--text-muted);">-</span>';

          const unitEntry = allUnitsCache.find(unit => unit.matricule === u.matricule);
          const isRegistered = unitEntry && unitEntry.rang && unitEntry.rang !== 'MISSING';
          const unitLinkedBadge = isRegistered
            ? '<span class="badge badge-linked">REGISTER</span>'
            : '<span class="badge badge-unlinked">MISSING</span>';
          const isFormateur = unitEntry && unitEntry.formateur;
          const formateurBadge = isFormateur
            ? '<span class="badge badge-admin" style="background:rgba(0,229,255,0.12);border-color:rgba(0,229,255,0.3);color:#00e5ff;">FORMATEUR</span>'
            : '<span style="color:var(--text-muted);">-</span>';
          const formateurToggle = u.approved && u.status !== 'REVOKED' && u.matricule
            ? `<button class="btn-sm" style="font-size:0.62rem;" onclick="toggleFormateur('${(u.matricule || '').replace(/'/g, "\\'")}')">F</button>`
            : '';

          let actions = '';
          if (!u.approved && u.status !== 'REVOKED') {
            actions += `<button class="btn-sm success" onclick="approveUser('${u.id}')">✓</button>`;
            actions += `<button class="btn-sm danger" onclick="revokeUser('${u.id}')">✗</button>`;
          }
          if (u.approved && u.status !== 'REVOKED') {
            actions += `<button class="btn-sm danger" onclick="revokeUser('${u.id}')">RÉVOQUER</button>`;
          }
          if (u.status === 'REVOKED') {
            actions += `<button class="btn-sm" onclick="reactivateUser('${u.id}')">↻ RÉACTIVER</button>`;
          }

          return `<tr>
            <td><strong style="color:var(--accent-cyan);">${u.matricule || '-'}</strong></td>
            <td>${u.email || '-'}</td>
            <td>${u.nom_steam || '<span style="color:var(--text-muted);">-</span>'}</td>
            <td>${u.discord || '<span style="color:var(--text-muted);">-</span>'}</td>
            <td style="font-size:0.72rem;">${u.steamid64 || '<span style="color:var(--text-muted);">-</span>'}</td>
            <td>${adminBadge}</td>
            <td>${formateurBadge}</td>
            <td>${unitLinkedBadge}</td>
            <td>${statusBadge}</td>
            <td style="font-size:0.72rem;color:var(--text-muted);">${u.created_at ? u.created_at.substring(0, 10) : '-'}</td>
            <td class="action-cell">${formateurToggle} ${actions}</td>
          </tr>`;
        }).join('');
      }

      function filterUsers() {
        const search = (document.getElementById('searchInput').value || '').toLowerCase();
        const status = document.getElementById('statusFilter').value;

        let filtered = allUsers.filter(u => {
          const matchSearch = !search ||
            (u.email || '').toLowerCase().includes(search) ||
            (u.matricule || '').includes(search) ||
            (u.nom_steam || '').toLowerCase().includes(search) ||
            (u.discord || '').toLowerCase().includes(search) ||
            (u.steamid64 || '').includes(search);
          const matchStatus = !status || (u.status === status);
          const unitLink = document.getElementById('unitFilter').value;
          const ue = u.matricule && allUnitsCache.find(unit => unit.matricule === u.matricule);
          const isReg = ue && ue.rang && ue.rang !== 'MISSING';
          const matchUnit = !unitLink || (unitLink === 'LINKED' && isReg) || (unitLink === 'UNLINKED' && !isReg);
          return matchSearch && matchStatus && matchUnit;
        });
        renderUsers(filtered);
      }

      window.approveUser = async (userId) => {
        try {
          // 1) Approve the user in Firestore
          await updateDoc(doc(db, 'users', userId), {
            approved: true,
            status: 'APPROVED',
            approved_at: new Date().toISOString()
          });

          // 2) Auto-link or create unit in JSON via GitHub API
          const userData = allUsers.find(u => u.id === userId);
          if (userData && userData.matricule) {
            try {
                const units = await ghLoadUnits();
                const today = new Date().toISOString().substring(0, 10);

                // Chercher par SteamID64 OU par matricule (lien automatique)
                const bySteam = userData.steamid64 ? units.findIndex(u => u.steamid64 === userData.steamid64) : -1;
                const byMatricule = units.findIndex(u => u.matricule === userData.matricule);
                const existingIdx = bySteam !== -1 ? bySteam : byMatricule;

                if (existingIdx !== -1) {
                  // Unité existante trouvée → mise à jour avec les infos d'inscription
                  const existing = units[existingIdx];
                  units[existingIdx] = {
                    ...existing,
                    matricule: userData.matricule,
                    steamid64: userData.steamid64 || existing.steamid64 || '',
                    nom_steam: userData.nom_steam || existing.nom_steam || '',
                    discord: userData.discord || existing.discord || '',
                    updated_at: today
                  };
                  await ghSaveUnits(units, `Liaison unité ${userData.matricule} (approbation — SteamID match)`);
                  showMessage('✓ Utilisateur approuvé — unité existante liée automatiquement', 'success');
                } else {
                  // Aucune unité existante → en créer une nouvelle
                  units.push({
                    matricule: userData.matricule,
                    steamid64: userData.steamid64 || '',
                    nom_steam: userData.nom_steam || '',
                    discord: userData.discord || '',
                    division: 'N/A',
                    rang: 'MISSING',
                    ordre: '',
                    date_entree: today,
                    updated_at: today
                  });
                  await ghSaveUnits(units, `Ajout unité ${userData.matricule} (approbation)`);
                  showMessage('✓ Utilisateur approuvé + nouvelle unité créée', 'success');
                }
            } catch (ghErr) {
              console.warn('Units update failed:', ghErr.message);
              showMessage('✓ Approuvé (⚠ erreur mise à jour unités: ' + ghErr.message + ')', 'success');
            }
          } else {
            showMessage('✓ Utilisateur approuvé', 'success');
          }

          await loadUsers();
        } catch (err) {
          showMessage('✗ Erreur: ' + err.message, 'error');
        }
      };

      window.revokeUser = async (userId) => {
        if (!confirm('Révoquer cet utilisateur ?')) return;
        try {
          await updateDoc(doc(db, 'users', userId), {
            approved: false,
            status: 'REVOKED',
            revoked_at: new Date().toISOString()
          });
          showMessage('✓ Utilisateur révoqué', 'success');
          await loadUsers();
        } catch (err) {
          showMessage('✗ Erreur: ' + err.message, 'error');
        }
      };

      window.reactivateUser = async (userId) => {
        try {
          await updateDoc(doc(db, 'users', userId), {
            approved: true,
            status: 'APPROVED',
            reactivated_at: new Date().toISOString()
          });
          showMessage('✓ Utilisateur réactivé', 'success');
          await loadUsers();
        } catch (err) {
          showMessage('✗ Erreur: ' + err.message, 'error');
        }
      };

      window.toggleFormateur = async (matricule) => {
        try {
          const units = await ghLoadUnits();
          const idx = units.findIndex(u => u.matricule === matricule);
          if (idx === -1) {
            showMessage('⚠ Unité introuvable pour ' + matricule, 'error');
            return;
          }
          const current = units[idx].formateur || false;
          units[idx].formateur = !current;
          units[idx].updated_at = new Date().toISOString().substring(0, 10);
          await ghSaveUnits(units, `${!current ? 'Ajout' : 'Retrait'} formateur ${matricule}`);
          allUnitsCache = units;
          renderUsers(allUsers);
          showMessage(`✓ ${matricule} — Formateur ${!current ? 'ACTIVÉ' : 'DÉSACTIVÉ'}`, 'success');
        } catch (err) {
          showMessage('✗ Erreur formateur: ' + err.message, 'error');
        }
      };

      document.getElementById('searchInput').addEventListener('input', filterUsers);
      document.getElementById('statusFilter').addEventListener('change', filterUsers);
      document.getElementById('unitFilter').addEventListener('change', filterUsers);

      // Auth check — admin only
      onAuthStateChanged(auth, async (user) => {
        if (!user) return; // auth.js redirige déjà vers login
        try {
          const snap = await getDoc(doc(db, 'users', user.uid));
          if (!snap.exists() || !snap.data().is_admin) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('access-denied').style.display = 'block';
            return;
          }
          document.getElementById('loading').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
          await loadUsers();
          // Auto-refresh toutes les 30 secondes
          setInterval(() => loadUsers(), 30000);
        } catch (err) {
          console.error('Admin auth error:', err);
          document.getElementById('loading').innerHTML = '<p style="color:#ff4444;">Erreur: ' + err.message + '</p>';
        }
      });
    </script>
</body>
</html>
