<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Unit√©s - MPF Documentation</title>
    <link rel="stylesheet" href="../assets/css/bundle.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <style>
        /* Admin nav */
        .admin-nav {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
        }
        .admin-nav a {
            padding: 0.35rem 0.8rem;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-decoration: none;
            border: 1px solid rgba(0, 170, 255, 0.15);
            border-radius: 2px;
            transition: all 0.15s;
        }
        .admin-nav a:hover, .admin-nav a.active {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            background: rgba(0, 170, 255, 0.08);
        }

        /* Stats */
        .unit-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        .stat-box {
            background: rgba(0, 170, 255, 0.03);
            border: 1px solid rgba(0, 170, 255, 0.15);
            padding: 0.8rem;
            text-align: center;
            border-radius: 4px;
        }
        .stat-box .number {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-cyan);
            font-weight: 700;
        }
        .stat-box .label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-top: 0.2rem;
        }

        /* Table */
        .units-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        .units-table th {
            text-align: left;
            padding: 0.55rem 0.4rem;
            color: var(--accent-cyan);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.2);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }
        .units-table th:hover { color: #fff; }
        .units-table td {
            padding: 0.45rem 0.4rem;
            color: var(--text-primary);
            border-bottom: 1px solid rgba(0, 170, 255, 0.06);
            vertical-align: middle;
        }
        .units-table tr:hover { background: rgba(0, 170, 255, 0.03); }
        .units-table .matricule-cell {
            font-weight: 700;
            color: var(--accent-cyan);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
        }
        .units-table .steamid-cell {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: 'Share Tech Mono', monospace;
        }

        /* Division badges */
        .div-badge {
            display: inline-block;
            padding: 0.12rem 0.45rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            font-weight: 700;
        }
        /* Famille Helix/Apex */
        .div-HELIX { background: rgba(50, 205, 50, 0.15); color: #32cd32; border: 1px solid rgba(50, 205, 50, 0.3); }
        .div-APEX { background: rgba(0, 100, 200, 0.15); color: #0088dd; border: 1px solid rgba(0, 100, 200, 0.3); }
        /* Famille Razor/Mace */
        .div-RAZOR { background: rgba(136, 136, 136, 0.15); color: #999999; border: 1px solid rgba(136, 136, 136, 0.3); }
        .div-MACE { background: rgba(0, 128, 128, 0.15); color: #00aaaa; border: 1px solid rgba(0, 128, 128, 0.3); }
        /* Famille Zone/Defender */
        .div-ZONE { background: rgba(68, 136, 255, 0.15); color: #4488ff; border: 1px solid rgba(68, 136, 255, 0.3); }
        .div-DEFENDER { background: rgba(0, 150, 100, 0.15); color: #00bb77; border: 1px solid rgba(0, 150, 100, 0.3); }
        /* Famille Jury/Judge */
        .div-JURY { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.3); }
        .div-JUDGE { background: rgba(128, 0, 128, 0.15); color: #cc44cc; border: 1px solid rgba(128, 0, 128, 0.3); }
        /* Famille Exogen/Hunter */
        .div-EXOGEN { background: rgba(0, 191, 165, 0.15); color: #00bfa5; border: 1px solid rgba(0, 191, 165, 0.3); }
        .div-HUNTER { background: rgba(0, 160, 40, 0.15); color: #00aa33; border: 1px solid rgba(0, 160, 40, 0.3); }
        /* Famille Grid/Hammer */
        .div-GRID { background: rgba(200, 200, 0, 0.15); color: #cccc00; border: 1px solid rgba(200, 200, 0, 0.3); }
        .div-HAMMER { background: rgba(220, 170, 0, 0.15); color: #ddaa00; border: 1px solid rgba(220, 170, 0, 0.3); }
        /* Famille Spectre/Ghost */
        .div-SPECTRE { background: rgba(85, 85, 85, 0.15); color: #888888; border: 1px solid rgba(85, 85, 85, 0.3); }
        .div-GHOST { background: rgba(140, 140, 200, 0.15); color: #aaaadd; border: 1px solid rgba(140, 140, 200, 0.3); }
        /* Standalone */
        .div-UNION { background: rgba(100, 100, 220, 0.15); color: #8888ee; border: 1px solid rgba(100, 100, 220, 0.3); }
        .div-NONE { background: rgba(60, 60, 60, 0.15); color: #666; border: 1px solid rgba(60, 60, 60, 0.3); }

        /* Rang badge */
        .rang-badge {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 2px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        /* Haut Grad√©s */
        .rang-Cmd  { background: rgba(255, 215, 0, 0.2); color: #ffd700; border: 1px solid rgba(255, 215, 0, 0.4); }
        .rang-Ofc  { background: rgba(255, 180, 0, 0.2); color: #ffbb00; border: 1px solid rgba(255, 180, 0, 0.4); }
        /* MPEF */
        .rang-DvL  { background: rgba(255, 40, 40, 0.2); color: #ff3333; border: 1px solid rgba(255, 40, 40, 0.4); }
        .rang-01   { background: rgba(255, 50, 50, 0.18); color: #ff4444; border: 1px solid rgba(255, 50, 50, 0.35); }
        .rang-02   { background: rgba(255, 140, 0, 0.18); color: #ff8800; border: 1px solid rgba(255, 140, 0, 0.35); }
        /* MPF */
        .rang-03   { background: rgba(200, 200, 0, 0.15); color: #bbbb00; border: 1px solid rgba(200, 200, 0, 0.3); }
        .rang-04   { background: rgba(0, 180, 120, 0.15); color: #00bb77; border: 1px solid rgba(0, 180, 120, 0.3); }
        .rang-05   { background: rgba(0, 140, 255, 0.15); color: #0099ff; border: 1px solid rgba(0, 140, 255, 0.3); }
        /* Recrues */
        .rang-RCT  { background: rgba(128, 128, 128, 0.15); color: #999; border: 1px solid rgba(128, 128, 128, 0.3); }
        /* Vortigaunts */
        .rang-STB   { background: rgba(160, 0, 200, 0.15); color: #bb44dd; border: 1px solid rgba(160, 0, 200, 0.3); }
        .rang-STBE  { background: rgba(180, 0, 220, 0.18); color: #cc44ee; border: 1px solid rgba(180, 0, 220, 0.35); }
        .rang-CABAL { background: rgba(200, 0, 200, 0.2); color: #dd44dd; border: 1px solid rgba(200, 0, 200, 0.4); }
        /* Missing */
        .rang-MISSING { background: rgba(255, 0, 0, 0.25); color: #ff2222; border: 1px solid rgba(255, 0, 0, 0.5); animation: pulse-missing 1.5s ease-in-out infinite; }
        @keyframes pulse-missing { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Statut absence badges */
        .statut-badge {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .statut-absence {
            background: rgba(255, 140, 0, 0.2);
            color: #ffaa00;
            border: 1px solid rgba(255, 140, 0, 0.4);
        }
        .statut-pause {
            background: rgba(255, 40, 40, 0.2);
            color: #ff4444;
            border: 1px solid rgba(255, 40, 40, 0.4);
            animation: pulse-missing 1.5s ease-in-out infinite;
        }
        .statut-ok {
            color: rgba(100,100,100,0.4);
            font-size: 0.65rem;
        }

        /* Sync indicator */
        .sync-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.4rem 0.8rem;
            border-radius: 3px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.72rem;
            z-index: 999;
            transition: all 0.3s;
            pointer-events: none;
            opacity: 0;
        }
        .sync-indicator.syncing {
            opacity: 1;
            background: rgba(255, 200, 0, 0.15);
            border: 1px solid rgba(255, 200, 0, 0.4);
            color: #ffc800;
        }
        .sync-indicator.synced {
            opacity: 1;
            background: rgba(0, 200, 80, 0.15);
            border: 1px solid rgba(0, 200, 80, 0.4);
            color: #00cc55;
        }
        .sync-indicator.error {
            opacity: 1;
            background: rgba(255, 60, 60, 0.15);
            border: 1px solid rgba(255, 60, 60, 0.4);
            color: #ff4444;
        }
        .sync-indicator.hidden { opacity: 0; }
        @keyframes spin-sync { to { transform: rotate(360deg); } }
        .sync-spinner { display: inline-block; animation: spin-sync 1s linear infinite; }

        /* ======= BL√ÇMES ======= */
        .blame-dots { display: flex; gap: 4px; align-items: center; }
        .blame-dot {
            position: relative; width: 14px; height: 14px; border-radius: 50%;
            cursor: pointer; flex-shrink: 0; transition: transform 0.15s;
        }
        .blame-dot:hover { transform: scale(1.4); z-index: 10; }
        .blame-dot.viewtime { background: #ff4444; box-shadow: 0 0 6px rgba(255,68,68,0.6); }
        .blame-dot.manual { background: #ffaa00; box-shadow: 0 0 6px rgba(255,170,0,0.6); }
        .blame-tooltip {
            display: none; position: absolute; bottom: calc(100% + 6px);
            left: 50%; transform: translateX(-50%);
            background: rgba(10,10,20,0.95); border: 1px solid rgba(0,170,255,0.3);
            color: var(--text-primary); padding: 0.4rem 0.6rem; border-radius: 3px;
            font-family: 'Share Tech Mono', monospace; font-size: 0.68rem;
            white-space: nowrap; z-index: 100; pointer-events: none;
            box-shadow: 0 2px 12px rgba(0,0,0,0.6);
        }
        .blame-dot:hover .blame-tooltip { display: block; }
        .blame-count-badge {
            font-family: 'Orbitron', sans-serif; font-size: 0.68rem;
            font-weight: 700; padding: 0.08rem 0.3rem; border-radius: 2px; margin-left: 3px;
        }
        .blame-0 { color: rgba(100,100,100,0.4); }
        .blame-1 { color: #ffaa00; }
        .blame-2 { background: rgba(255,100,0,0.2); color: #ff6600; border: 1px solid rgba(255,100,0,0.4); }
        .blame-3 { background: rgba(255,40,40,0.25); color: #ff2222; border: 1px solid rgba(255,40,40,0.5); animation: pulse-missing 1.5s ease-in-out infinite; }
        .blame-add-btn {
            padding: 0.12rem 0.35rem; font-size: 0.6rem;
            font-family: 'Share Tech Mono', monospace; cursor: pointer;
            border: 1px solid rgba(255,140,0,0.3); background: rgba(255,140,0,0.08);
            color: #ff8800; border-radius: 2px; transition: all 0.15s; margin-left: 3px;
        }
        .blame-add-btn:hover { background: rgba(255,140,0,0.2); }
        .blame-list-modal { margin-top: 0.8rem; max-height: 200px; overflow-y: auto; }
        .blame-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.4rem 0.5rem; border-bottom: 1px solid rgba(0,170,255,0.06);
            font-size: 0.75rem; font-family: 'Share Tech Mono', monospace;
        }
        .blame-list-item .blame-info { flex: 1; }
        .blame-list-item .blame-reason { color: var(--text-primary); }
        .blame-list-item .blame-meta { color: var(--text-muted); font-size: 0.65rem; }
        .blame-type-tag { font-size: 0.6rem; padding: 0.05rem 0.25rem; border-radius: 2px; font-weight: 700; margin-right: 4px; }
        .blame-type-viewtime { background: rgba(255,68,68,0.15); color: #ff4444; border: 1px solid rgba(255,68,68,0.3); }
        .blame-type-manual { background: rgba(255,170,0,0.15); color: #ffaa00; border: 1px solid rgba(255,170,0,0.3); }

        /* Buttons */
        .btn-sm {
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            font-family: 'Share Tech Mono', monospace;
            cursor: pointer;
            border: 1px solid rgba(0, 170, 255, 0.3);
            background: rgba(0, 170, 255, 0.08);
            color: var(--accent-cyan);
            border-radius: 2px;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .btn-sm:hover { background: rgba(0, 170, 255, 0.2); }
        .btn-sm.danger { border-color: rgba(255, 60, 60, 0.3); background: rgba(255, 60, 60, 0.08); color: #ff4444; }
        .btn-sm.danger:hover { background: rgba(255, 60, 60, 0.2); }
        .btn-sm.success { border-color: rgba(0, 200, 80, 0.3); background: rgba(0, 200, 80, 0.08); color: #00cc55; }
        .btn-sm.success:hover { background: rgba(0, 200, 80, 0.2); }
        .btn-sm.warning { border-color: rgba(255, 140, 0, 0.3); background: rgba(255, 140, 0, 0.08); color: #ff8800; }
        .btn-sm.warning:hover { background: rgba(255, 140, 0, 0.2); }
        .action-cell { display: flex; gap: 0.3rem; flex-wrap: wrap; }

        /* LED de connexion */
        .online-led {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
            margin-right: 6px;
            vertical-align: middle;
            flex-shrink: 0;
        }
        .online-led.active {
            background: #00cc66;
            box-shadow: 0 0 6px rgba(0, 204, 102, 0.7);
            animation: ledPulse 2s ease infinite;
        }
        @keyframes ledPulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 6px rgba(0, 204, 102, 0.7); }
            50% { opacity: 0.7; box-shadow: 0 0 12px rgba(0, 204, 102, 0.9); }
        }
        .nom-cell-wrapper {
            display: flex;
            align-items: center;
        }

        .btn-action {
            padding: 0.5rem 1.2rem;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid rgba(0, 170, 255, 0.4);
            background: rgba(0, 170, 255, 0.1);
            color: var(--accent-cyan);
            border-radius: 3px;
            transition: all 0.15s;
            letter-spacing: 0.5px;
        }
        .btn-action:hover { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); }
        .btn-action.primary { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); font-weight: 700; }
        .btn-action.primary:hover { background: rgba(0, 170, 255, 0.35); }

        /* Filter */
        .filter-row {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-row input, .filter-row select {
            padding: 0.4rem 0.6rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.78rem;
            outline: none;
            border-radius: 2px;
        }
        .filter-row input:focus, .filter-row select:focus { border-color: var(--accent-cyan); }
        .filter-row input { flex: 1; min-width: 180px; }

        /* Alert */
        .alert-msg {
            padding: 0.6rem 1rem;
            border-radius: 3px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            font-family: 'Share Tech Mono', monospace;
            display: none;
        }
        .alert-msg.success { background: rgba(0, 200, 80, 0.1); border: 1px solid rgba(0, 200, 80, 0.3); color: #00cc55; }
        .alert-msg.error { background: rgba(255, 60, 60, 0.1); border: 1px solid rgba(255, 60, 60, 0.3); color: #ff4444; }
        .alert-msg.info { background: rgba(0, 170, 255, 0.1); border: 1px solid rgba(0, 170, 255, 0.3); color: var(--accent-cyan); }

        .table-scroll { overflow-x: auto; }
        #access-denied { display: none; text-align: center; padding: 3rem; }

        /* Modal overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 500;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.visible {
            display: flex;
        }
        .modal {
            background: var(--bg-secondary);
            border: 1px solid rgba(0, 170, 255, 0.3);
            border-radius: 4px;
            padding: 1.5rem;
            width: 95%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.7);
        }
        .modal h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.95rem;
            color: var(--accent-cyan);
            margin-bottom: 1rem;
            letter-spacing: 1px;
        }
        .modal label {
            display: block;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.72rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-top: 0.7rem;
            margin-bottom: 0.2rem;
        }
        .modal input, .modal select {
            width: 100%;
            padding: 0.45rem 0.6rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.82rem;
            outline: none;
            border-radius: 2px;
        }
        .modal input:focus, .modal select:focus { border-color: var(--accent-cyan); }
        .modal-actions {
            display: flex;
            gap: 0.6rem;
            margin-top: 1.2rem;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>

    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">Gestion des Unit√©s</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p>
            </div>
            <div id="access-denied">
                <h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">ACC√àS REFUS√â</h2>
                <p style="color:var(--text-muted);">Vous n'avez pas les droits administrateur.</p>
                <a href="../index.html" style="color:var(--accent-cyan);">Retour au site</a>
            </div>

            <div id="mainContent" style="display:none;">
                <!-- Nav -->
                <div class="admin-nav" style="margin-top: 1rem;">
                    <a href="panel.html">‚Üê PANEL ADMIN</a>
                    <a href="unites.html" class="active">UNIT√âS</a>
                    <a href="archives-unites.html">VIR√âS</a>
                    <a href="heures.html">HEURES DE JEU</a>
                    <a href="heures-archives.html">ARCHIVES</a>
                    <a href="absences.html">ABSENCES</a>
                    <a href="maintenance-admin.html">MAINTENANCE</a>
                    <a href="navigation.html">NAVIGATION</a>
                </div>

                <!-- Stats -->
                <div class="unit-stats">
                    <div class="stat-box">
                        <div class="number" id="statTotal">0</div>
                        <div class="label">TOTAL UNIT√âS</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statActive">0</div>
                        <div class="label">ACTIVES</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statDivisions">0</div>
                        <div class="label">DIVISIONS</div>
                    </div>
                </div>

                <!-- Alert -->
                <div id="alertMsg" class="alert-msg"></div>

                <!-- Units table -->
                <div class="combine-terminal-wrapper">
                    <div class="combine-header">
                        <h2>REGISTRE DES UNIT√âS</h2>
                        <span class="header-code" id="unitCount">CHARGEMENT...</span>
                    </div>
                    <div class="combine-body">
                        <div class="filter-row">
                            <input type="text" id="searchInput" placeholder="Rechercher matricule, nom, SteamID, Discord..." autocomplete="off">
                            <select id="divisionFilter">
                                <option value="">Toutes divisions</option>
                                <optgroup label="‚îÄ Helix / Apex ‚îÄ">
                                    <option value="HELIX">HELIX</option>
                                    <option value="APEX">APEX</option>
                                </optgroup>
                                <optgroup label="‚îÄ Razor / Mace ‚îÄ">
                                    <option value="RAZOR">RAZOR</option>
                                    <option value="MACE">MACE</option>
                                </optgroup>
                                <optgroup label="‚îÄ Zone / Defender ‚îÄ">
                                    <option value="ZONE">ZONE</option>
                                    <option value="DEFENDER">DEFENDER</option>
                                </optgroup>
                                <optgroup label="‚îÄ Jury / Judge ‚îÄ">
                                    <option value="JURY">JURY</option>
                                    <option value="JUDGE">JUDGE</option>
                                </optgroup>
                                <optgroup label="‚îÄ Exogen / Hunter ‚îÄ">
                                    <option value="EXOGEN">EXOGEN</option>
                                    <option value="HUNTER">HUNTER</option>
                                </optgroup>
                                <optgroup label="‚îÄ Grid / Hammer ‚îÄ">
                                    <option value="GRID">GRID</option>
                                    <option value="HAMMER">HAMMER</option>
                                </optgroup>
                                <optgroup label="‚îÄ Spectre / Ghost ‚îÄ">
                                    <option value="SPECTRE">SPECTRE</option>
                                    <option value="GHOST">GHOST</option>
                                </optgroup>
                                <optgroup label="‚îÄ Autres ‚îÄ">
                                    <option value="UNION">UNION</option>
                                    <option value="N/A">N/A</option>
                                </optgroup>
                            </select>
                            <select id="rangFilter">
                                <option value="">Tous rangs</option>
                                <optgroup label="‚îÄ Recrues ‚îÄ">
                                    <option value="RCT">RCT</option>
                                </optgroup>
                                <optgroup label="‚îÄ MPF ‚îÄ">
                                    <option value=".05">.05</option>
                                    <option value=".04">.04</option>
                                    <option value=".03">.03</option>
                                </optgroup>
                                <optgroup label="‚îÄ MPEF ‚îÄ">
                                    <option value=".02">.02</option>
                                    <option value=".01">.01</option>
                                    <option value="DvL">DvL</option>
                                </optgroup>
                                <optgroup label="‚îÄ Haut Grad√©s ‚îÄ">
                                    <option value="Ofc">Ofc</option>
                                    <option value="Cmd">Cmd</option>
                                </optgroup>
                                <optgroup label="‚îÄ Vortigaunts ‚îÄ">
                                    <option value="STB">STB</option>
                                    <option value="STBE">STBE</option>
                                    <option value="CABAL">CABAL</option>
                                </optgroup>
                                <optgroup label="‚îÄ Autre ‚îÄ">
                                    <option value="MISSING">MISSING</option>
                                </optgroup>
                            </select>
                            <button class="btn-action primary" onclick="openAddModal()">+ AJOUTER UNIT√â</button>
                        </div>
                        <div class="table-scroll">
                            <table class="units-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortBy('matricule')">MATRICULE</th>
                                        <th onclick="sortBy('nom_steam')">NOM STEAM</th>
                                        <th onclick="sortBy('steamid64')">STEAMID64</th>
                                        <th onclick="sortBy('discord')">DISCORD</th>
                                        <th onclick="sortBy('division')">DIVISION</th>
                                        <th onclick="sortBy('rang')">RANG</th>
                                        <th onclick="sortBy('blames')">BL√ÇMES</th>
                                        <th>FORMATEUR</th>
                                        <th>STATUT</th>
                                        <th onclick="sortBy('ordre')">ORDRE</th>
                                        <th onclick="sortBy('date_entree')">ENTR√âE</th>
                                        <th>ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="unitsBody">
                                    <tr><td colspan="12" style="text-align:center;color:var(--text-muted);">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Add/Edit unit -->
    <div id="unitModal" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">AJOUTER UNE UNIT√â</h3>
            <input type="hidden" id="editId">

            <div id="missingUserSection" style="display:none;margin-bottom:0.8rem;">
                <label style="color:#ff8800;">PR√â-REMPLIR DEPUIS UN UTILISATEUR MISSING</label>
                <select id="missingUserSelect" style="width:100%;padding:0.45rem 0.6rem;background:rgba(255,140,0,0.06);border:1px solid rgba(255,140,0,0.3);color:var(--text-primary);font-family:'Share Tech Mono',monospace;font-size:0.82rem;outline:none;border-radius:2px;cursor:pointer;">
                    <option value="">‚Äî S√©lectionner un utilisateur MISSING ‚Äî</option>
                </select>
                <div style="border-bottom:1px solid rgba(255,140,0,0.15);margin-top:0.6rem;"></div>
            </div>

            <label>MATRICULE *</label>
            <input type="text" id="fMatricule" placeholder="Ex: 230" maxlength="10">

            <label>STEAMID64</label>
            <input type="text" id="fSteamid" placeholder="Ex: 76561198414645840" maxlength="20">

            <label>NOM STEAM</label>
            <input type="text" id="fNomSteam" placeholder="Ex: yellowaitc">

            <label>DISCORD</label>
            <input type="text" id="fDiscord" placeholder="Ex: yellowaitc#1234">

            <label>DIVISION</label>
            <select id="fDivision">
                <option value="">‚Äî Aucune ‚Äî</option>
                <optgroup label="‚îÄ Helix / Apex ‚îÄ">
                    <option value="HELIX">HELIX</option>
                    <option value="APEX">APEX</option>
                </optgroup>
                <optgroup label="‚îÄ Razor / Mace ‚îÄ">
                    <option value="RAZOR">RAZOR</option>
                    <option value="MACE">MACE</option>
                </optgroup>
                <optgroup label="‚îÄ Zone / Defender ‚îÄ">
                    <option value="ZONE">ZONE</option>
                    <option value="DEFENDER">DEFENDER</option>
                </optgroup>
                <optgroup label="‚îÄ Jury / Judge ‚îÄ">
                    <option value="JURY">JURY</option>
                    <option value="JUDGE">JUDGE</option>
                </optgroup>
                <optgroup label="‚îÄ Exogen / Hunter ‚îÄ">
                    <option value="EXOGEN">EXOGEN</option>
                    <option value="HUNTER">HUNTER</option>
                </optgroup>
                <optgroup label="‚îÄ Grid / Hammer ‚îÄ">
                    <option value="GRID">GRID</option>
                    <option value="HAMMER">HAMMER</option>
                </optgroup>
                <optgroup label="‚îÄ Spectre / Ghost ‚îÄ">
                    <option value="SPECTRE">SPECTRE</option>
                    <option value="GHOST">GHOST</option>
                </optgroup>
                <optgroup label="‚îÄ Autres ‚îÄ">
                    <option value="UNION">UNION</option>
                    <option value="N/A">N/A</option>
                </optgroup>
            </select>

            <label>RANG</label>
            <select id="fRang">
                <option value="">‚Äî Aucun ‚Äî</option>
                <optgroup label="‚îÄ Recrues ‚îÄ">
                    <option value="RCT">RCT</option>
                </optgroup>
                <optgroup label="‚îÄ MPF ‚îÄ">
                    <option value=".05">.05</option>
                    <option value=".04">.04</option>
                    <option value=".03">.03</option>
                </optgroup>
                <optgroup label="‚îÄ MPEF ‚îÄ">
                    <option value=".02">.02</option>
                    <option value=".01">.01</option>
                    <option value="DvL">DvL</option>
                </optgroup>
                <optgroup label="‚îÄ Haut Grad√©s ‚îÄ">
                    <option value="Ofc">Ofc</option>
                    <option value="Cmd">Cmd</option>
                </optgroup>
                <optgroup label="‚îÄ Vortigaunts ‚îÄ">
                    <option value="STB">STB</option>
                    <option value="STBE">STBE</option>
                    <option value="CABAL">CABAL</option>
                </optgroup>
                <optgroup label="‚îÄ Autre ‚îÄ">
                    <option value="MISSING">MISSING</option>
                </optgroup>
            </select>

            <label>ORDRE</label>
            <input type="number" id="fOrdre" placeholder="Ex: 5" min="1" max="99">

            <label>DATE D'ENTR√âE MILICE</label>
            <input type="date" id="fDateEntree">

            <div style="display:flex;align-items:center;gap:0.6rem;margin:0.6rem 0 0.2rem;">
                <label style="margin:0;cursor:pointer;display:flex;align-items:center;gap:0.4rem;">
                    <input type="checkbox" id="fFormateur" style="accent-color:var(--accent-cyan);width:16px;height:16px;cursor:pointer;">
                    <span>FORMATEUR</span>
                </label>
            </div>

            <div class="modal-actions">
                <button class="btn-action" onclick="closeModal()">ANNULER</button>
                <button class="btn-action primary" id="btnModalSave" onclick="saveUnit()">SAUVEGARDER</button>
            </div>
        </div>
    </div>

    <!-- Modal: Bl√¢mes d'une unit√© -->
    <div id="blameModal" class="modal-overlay">
        <div class="modal">
            <h3 id="blameModalTitle">BL√ÇMES ‚Äî ???</h3>
            <div id="blameListModal" class="blame-list-modal">
                <p style="color:var(--text-muted);font-size:0.75rem;">Aucun bl√¢me</p>
            </div>
            <hr style="border:none;border-top:1px solid rgba(0,170,255,0.1);margin:0.8rem 0;">
            <div id="blameAddSection">
                <label>RAISON DU BL√ÇME</label>
                <textarea id="blameReason" rows="2" placeholder="Raison du bl√¢me..." style="width:100%;resize:vertical;padding:0.45rem 0.6rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.2);color:var(--text-primary);font-family:'Share Tech Mono',monospace;font-size:0.82rem;outline:none;border-radius:2px;"></textarea>
                <div class="modal-actions" style="margin-top:0.6rem;">
                    <button class="btn-action" style="border-color:rgba(255,140,0,0.5);background:rgba(255,140,0,0.15);color:#ff8800;" onclick="addManualBlame()">+ AJOUTER BL√ÇME</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-action" onclick="closeBlameModal()">FERMER</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="../assets/js/auth.js"></script>
    <script src="../assets/js/global-nav.js?v=20260214" defer></script>
    <script src="../assets/js/interactive-system.js" defer></script>
    <script src="../assets/js/combine-animations.js" defer></script>

    <script type="module">
      import { auth, db } from '../assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        loadUnits as ghLoadUnits, saveUnits as ghSaveUnits,
        loadAbsences as ghLoadAbsences,
        addFiredUnit,
        onSyncStatus,
        loadBlames, addBlame as ghAddBlame, deleteBlame as ghDeleteBlame
      } from '../assets/js/github-data.js';

      // ========== SYNC INDICATOR ==========
      {
        const ind = document.createElement('div');
        ind.id = 'syncIndicator';
        ind.className = 'sync-indicator hidden';
        document.body.appendChild(ind);
        let hideTimer = null;
        onSyncStatus(status => {
          clearTimeout(hideTimer);
          if (status === 'syncing') {
            ind.innerHTML = '<span class="sync-spinner">‚ü≥</span> Synchronisation...';
            ind.className = 'sync-indicator syncing';
          } else if (status === 'synced') {
            ind.innerHTML = '‚úì Synchronis√©';
            ind.className = 'sync-indicator synced';
            hideTimer = setTimeout(() => { ind.className = 'sync-indicator hidden'; }, 2500);
          } else {
            ind.innerHTML = '‚ö† Erreur sync';
            ind.className = 'sync-indicator error';
            hideTimer = setTimeout(() => { ind.className = 'sync-indicator hidden'; }, 6000);
          }
        });
      }

      // ========== STATE ==========
      let allUnits = [];
      let allAbsences = [];
      let allBlames = [];
      let allFirestoreUsers = [];
      let onlineMatricules = new Set();
      let currentSort = { key: 'ordre', asc: true };
      let blameModalMatricule = '';
      let currentUserMatricule = '';
      const BLAME_EXPIRY_DAYS = 30;

      // ========== SAVE QUEUE (s√©rialisation des √©critures) ==========
      let _saveQueue = Promise.resolve();
      async function queueSave(saveFn) {
        _saveQueue = _saveQueue.then(saveFn).catch(async (err) => {
          console.error('[Units] Save failed, reloading:', err);
          showAlert('‚ö† Sauvegarde √©chou√©e: ' + (err.message || err) + ' ‚Äî Rechargement...', 'error');
          // Rollback : recharger les donn√©es r√©elles depuis Firestore
          try {
            const freshUnits = await ghLoadUnits();
            allUnits = freshUnits.map(u => ({ ...u, id: u.matricule || Math.random().toString(36).substr(2, 9) }));
            updateStats();
            renderTable();
          } catch (_) {}
        });
        return _saveQueue;
      }

      // ========== UTILS ==========
      function showAlert(text, type = 'success') {
        const el = document.getElementById('alertMsg');
        el.style.display = 'block';
        el.className = 'alert-msg ' + type;
        el.textContent = text;
        setTimeout(() => { el.style.display = 'none'; }, 5000);
      }

      function divBadge(div) {
        if (!div) return '<span class="div-badge div-NONE">‚Äî</span>';
        return `<span class="div-badge div-${div}">${div}</span>`;
      }

      function rangClass(rang) {
        if (!rang) return '';
        const r = rang.replace('.', '');
        return 'rang-' + r;
      }

      // ========== LOAD UNITS ==========
      /** R√©cup√®re les matricules des unit√©s actuellement en ligne */
      async function fetchOnlineMatricules() {
        try {
          const { Timestamp, collection: col, getDocs: gDocs, query: q, where: w, doc: d, getDoc: gDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
          const cutoff = Timestamp.fromDate(new Date(Date.now() - 2 * 60 * 1000));
          const snap = await gDocs(q(col(db, 'presence'), w('last_seen', '>', cutoff)));
          const onlineUids = snap.docs.map(s => s.id);
          const mats = new Set();
          for (const uid of onlineUids) {
            try {
              const uDoc = await gDoc(d(db, 'users', uid));
              if (uDoc.exists() && uDoc.data().matricule) {
                mats.add(uDoc.data().matricule);
              }
            } catch (_) {}
          }
          return mats;
        } catch (_) { return new Set(); }
      }

      /** Lundi de la semaine contenant d */
      function getWeekMonday(d) {
        const date = new Date(d);
        const day = date.getDay();
        const diff = day === 0 ? -6 : 1 - day;
        date.setDate(date.getDate() + diff);
        date.setHours(0, 0, 0, 0);
        return date;
      }
      function getWeekSunday(d) {
        const mon = getWeekMonday(d);
        const sun = new Date(mon);
        sun.setDate(sun.getDate() + 6);
        sun.setHours(23, 59, 59, 999);
        return sun;
      }
      function daysInCurrentWeek(debut, fin) {
        const now = new Date();
        const ws = getWeekMonday(now), we = getWeekSunday(now);
        const s = new Date(debut), e = new Date(fin);
        const oS = s > ws ? s : ws, oE = e < we ? e : we;
        if (oS > oE) return 0;
        return Math.ceil((oE - oS) / 86400000) + 1;
      }

      /** Retourne le statut absence d'une unit√© par matricule */
      function getUnitAbsenceStatus(matricule) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        for (const abs of allAbsences) {
          if (abs.matricule !== matricule) continue;
          const debut = new Date(abs.debut);
          const fin = new Date(abs.fin);
          debut.setHours(0, 0, 0, 0);
          fin.setHours(23, 59, 59, 999);
          if (today >= debut && today <= fin) {
            const dw = daysInCurrentWeek(abs.debut, abs.fin);
            return dw >= 3 ? 'pause' : 'absence';
          }
        }
        return null;
      }

      function statutBadge(matricule) {
        const s = getUnitAbsenceStatus(matricule);
        if (s === 'pause') return '<span class="statut-badge statut-pause">PAUSE</span>';
        if (s === 'absence') return '<span class="statut-badge statut-absence">ABSENCE</span>';
        return '<span class="statut-ok">‚Äî</span>';
      }

      // ========== BLAME HELPERS ==========
      function getActiveBlames(matricule) {
        const now = new Date();
        return allBlames.filter(b => {
          if (b.matricule !== matricule) return false;
          if (b.expires_at && new Date(b.expires_at) < now) return false;
          return true;
        });
      }

      function blameCellHTML(matricule) {
        const active = getActiveBlames(matricule);
        const count = active.length;
        let dots = '';
        active.forEach(b => {
          const typeClass = b.type === 'viewtime' ? 'viewtime' : 'manual';
          const reason = (b.raison || 'Aucune raison').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const dateStr = b.created_at ? new Date(b.created_at).toLocaleDateString('fr-FR') : '?';
          const expStr = b.expires_at ? new Date(b.expires_at).toLocaleDateString('fr-FR') : '?';
          dots += `<span class="blame-dot ${typeClass}" onclick="event.stopPropagation();openBlameModal('${matricule}')">
            <span class="blame-tooltip">${b.type === 'viewtime' ? '‚è± VIEWTIME' : 'üìù MANUEL'} ‚Äî ${reason}<br>üìÖ ${dateStr} ‚Üí expire ${expStr}</span>
          </span>`;
        });
        let badge = '';
        if (count === 0) badge = '<span class="blame-count-badge blame-0">0</span>';
        else if (count === 1) badge = `<span class="blame-count-badge blame-1">${count}</span>`;
        else if (count === 2) badge = `<span class="blame-count-badge blame-2">${count} ‚ö† R√âTRO</span>`;
        else badge = `<span class="blame-count-badge blame-3">${count} ‚õî EXCLU</span>`;
        const addBtn = `<button class="blame-add-btn" onclick="event.stopPropagation();openBlameModal('${matricule}')" title="G√©rer bl√¢mes">+</button>`;
        return `<div class="blame-dots">${dots}${badge}${addBtn}</div>`;
      }

      window.openBlameModal = function(matricule) {
        blameModalMatricule = matricule;
        const u = allUnits.find(x => x.matricule === matricule);
        document.getElementById('blameModalTitle').textContent = `BL√ÇMES ‚Äî ${matricule} ${u ? '(' + u.nom_steam + ')' : ''}`;
        document.getElementById('blameReason').value = '';
        renderBlameListModal(matricule);
        document.getElementById('blameModal').classList.add('visible');
      };

      function renderBlameListModal(matricule) {
        const now = new Date();
        const blames = allBlames.filter(b => b.matricule === matricule).sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
        const container = document.getElementById('blameListModal');
        if (blames.length === 0) {
          container.innerHTML = '<p style="color:var(--text-muted);font-size:0.75rem;text-align:center;">Aucun bl√¢me pour cette unit√©</p>';
          return;
        }
        container.innerHTML = blames.map(b => {
          const isExpired = b.expires_at && new Date(b.expires_at) < now;
          const typeTag = b.type === 'viewtime'
            ? '<span class="blame-type-tag blame-type-viewtime">VIEWTIME</span>'
            : '<span class="blame-type-tag blame-type-manual">MANUEL</span>';
          const dateStr = b.created_at ? new Date(b.created_at).toLocaleDateString('fr-FR') : '?';
          const expStr = b.expires_at ? new Date(b.expires_at).toLocaleDateString('fr-FR') : '?';
          return `<div class="blame-list-item" style="${isExpired ? 'opacity:0.4;' : ''}">
            <div class="blame-info">
              ${typeTag}<span class="blame-reason">${b.raison || '-'}</span>
              <div class="blame-meta">${dateStr} ‚Üí expire ${expStr}${isExpired ? ' (EXPIR√â)' : ''} ${b.created_by ? '‚Äî par ' + b.created_by : ''}</div>
            </div>
            <button class="blame-add-btn" style="border-color:rgba(255,60,60,0.3);color:#ff4444;background:rgba(255,60,60,0.08);" onclick="removeBlame('${b._id}')">‚úó Suppr.</button>
          </div>`;
        }).join('');
      }

      window.closeBlameModal = function() {
        document.getElementById('blameModal').classList.remove('visible');
      };
      document.getElementById('blameModal').addEventListener('click', e => {
        if (e.target === document.getElementById('blameModal')) closeBlameModal();
      });

      window.addManualBlame = async function() {
        const reason = document.getElementById('blameReason').value.trim();
        if (!reason) { alert('Veuillez entrer une raison.'); return; }
        if (!blameModalMatricule) return;
        const now = new Date();
        const expiresAt = new Date(now);
        expiresAt.setDate(expiresAt.getDate() + BLAME_EXPIRY_DAYS);
        try {
          const saved = await ghAddBlame({
            matricule: blameModalMatricule,
            raison: reason,
            type: 'manual',
            created_at: now.toISOString(),
            expires_at: expiresAt.toISOString(),
            created_by: currentUserMatricule || 'HG'
          });
          allBlames.push(saved);
          renderBlameListModal(blameModalMatricule);
          renderTable();
          document.getElementById('blameReason').value = '';
          showAlert(`‚úì Bl√¢me ajout√© √† ${blameModalMatricule}`, 'success');
        } catch (err) {
          showAlert('Erreur ajout bl√¢me: ' + err.message, 'error');
        }
      };

      window.removeBlame = async function(docId) {
        if (!confirm('Supprimer ce bl√¢me ?')) return;
        try {
          await ghDeleteBlame(docId);
          allBlames = allBlames.filter(b => b._id !== docId);
          if (blameModalMatricule) renderBlameListModal(blameModalMatricule);
          renderTable();
          showAlert('‚úì Bl√¢me supprim√©', 'success');
        } catch (err) {
          showAlert('Erreur suppression bl√¢me: ' + err.message, 'error');
        }
      };

      async function loadUnits() {
        try {
          [allUnits, allAbsences, onlineMatricules, allFirestoreUsers, allBlames] = await Promise.all([ghLoadUnits(), ghLoadAbsences(), fetchOnlineMatricules(), loadFirestoreUsers(), loadBlames()]);
          allUnits = allUnits.map(u => ({ ...u, id: u.matricule || Math.random().toString(36).substr(2, 9) }));
          updateStats();
          renderTable();
          // Rafra√Æchir la pr√©sence toutes les 30s
          setInterval(async () => {
            onlineMatricules = await fetchOnlineMatricules();
            renderTable();
          }, 30000);
        } catch (err) {
          console.error('Erreur chargement units:', err);
          showAlert('Erreur chargement: ' + err.message, 'error');
        }
      }

      function updateStats() {
        document.getElementById('statTotal').textContent = allUnits.length;
        document.getElementById('statActive').textContent = allUnits.filter(u => u.division && u.division !== 'N/A' && u.division !== 'RCT').length;
        const divisions = new Set(allUnits.map(u => u.division).filter(d => d && d !== 'N/A'));
        document.getElementById('statDivisions').textContent = divisions.size;
      }

      function renderTable() {
        const search = (document.getElementById('searchInput').value || '').toLowerCase();
        const divFilter = document.getElementById('divisionFilter').value;
        const rangFilter = document.getElementById('rangFilter').value;

        let filtered = allUnits.filter(u => {
          const matchSearch = !search ||
            (u.matricule || '').toLowerCase().includes(search) ||
            (u.nom_steam || '').toLowerCase().includes(search) ||
            (u.steamid64 || '').includes(search) ||
            (u.discord || '').toLowerCase().includes(search);
          const matchDiv = !divFilter || u.division === divFilter;
          const matchRang = !rangFilter || u.rang === rangFilter;
          return matchSearch && matchDiv && matchRang;
        });

        // Sort ‚Äî hi√©rarchie militaire : Cmd > Ofc > DvL > .01 > .02 > .03 > .04 > .05 > RCT, MISSING en bas
        const rangOrder = { 'Cmd': 0, 'Ofc': 1, 'DvL': 2, '.01': 3, '.02': 4, '.03': 5, '.04': 6, '.05': 7, 'RCT': 8, 'CABAL': 9, 'STBE': 10, 'STB': 11, 'MISSING': 99 };
        filtered.sort((a, b) => {
          const ra = rangOrder[a.rang] ?? 50;
          const rb = rangOrder[b.rang] ?? 50;
          if (ra !== rb) return ra - rb;

          let va, vb;
          const key = currentSort.key;
          if (key === 'blames') {
            va = getActiveBlames(a.matricule).length;
            vb = getActiveBlames(b.matricule).length;
            const cmp = vb - va;
            if (cmp !== 0) return cmp;
            return (a.matricule || '').localeCompare(b.matricule || '');
          } else if (key === 'ordre') {
            va = parseInt(a.ordre) || 999;
            vb = parseInt(b.ordre) || 999;
          } else if (key === 'matricule') {
            va = (a.matricule || '').padStart(4, '0');
            vb = (b.matricule || '').padStart(4, '0');
          } else {
            va = (a[key] || '').toLowerCase();
            vb = (b[key] || '').toLowerCase();
          }
          if (currentSort.asc) return va > vb ? 1 : va < vb ? -1 : 0;
          return va < vb ? 1 : va > vb ? -1 : 0;
        });

        document.getElementById('unitCount').textContent = `${filtered.length} / ${allUnits.length} UNIT√âS`;

        const tbody = document.getElementById('unitsBody');
        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;color:var(--text-muted);">Aucune unit√© trouv√©e</td></tr>';
          return;
        }

        tbody.innerHTML = filtered.map(u => {
          const safeMatricule = (u.matricule || '').replace(/'/g, "\\'");
          const isOnline = onlineMatricules.has(u.matricule);
          const ledClass = isOnline ? 'online-led active' : 'online-led';
          return `<tr>
            <td class="matricule-cell">${u.matricule || '-'}</td>
            <td><div class="nom-cell-wrapper"><span class="${ledClass}" title="${isOnline ? 'En ligne' : 'Hors ligne'}"></span>${u.nom_steam || '<span style="color:var(--text-muted);">-</span>'}</div></td>
            <td class="steamid-cell">${u.steamid64 || '-'}</td>
            <td style="font-size:0.78rem;">${u.discord || '<span style="color:var(--text-muted);">-</span>'}</td>
            <td>${divBadge(u.division)}</td>
            <td><span class="rang-badge ${rangClass(u.rang)}">${u.rang || '-'}</span></td>
            <td>${blameCellHTML(u.matricule)}</td>
            <td>${u.formateur ? '<span style="color:#00e5ff;font-size:0.7rem;font-weight:700;">FORMATEUR</span>' : '<span style="color:var(--text-muted);">-</span>'}</td>
            <td>${statutBadge(u.matricule)}</td>
            <td style="font-size:0.78rem;color:var(--text-muted);">${u.ordre || '-'}</td>
            <td style="font-size:0.72rem;color:var(--text-muted);">${u.date_entree || '-'}</td>
            <td class="action-cell">
              <button class="btn-sm ${u.formateur ? 'success' : ''}" onclick="toggleFormateur('${safeMatricule}')" title="${u.formateur ? 'Retirer formateur' : 'Mettre formateur'}" style="font-size:0.62rem;font-weight:700;">F</button>
              <button class="btn-sm" onclick="editUnit('${safeMatricule}')" title="Modifier">‚úé</button>
              <button class="btn-sm warning" onclick="fireUnit('${safeMatricule}')" title="Virer">‚äò</button>
              <button class="btn-sm danger" onclick="deleteUnit('${safeMatricule}')" title="Supprimer">‚úó</button>
            </td>
          </tr>`;
        }).join('');
      }

      // ========== SORT ==========
      window.sortBy = function(key) {
        if (currentSort.key === key) {
          currentSort.asc = !currentSort.asc;
        } else {
          currentSort = { key, asc: true };
        }
        renderTable();
      };

      // ========== MODAL ==========
      /** Charge les utilisateurs approuv√©s depuis Firestore */
      async function loadFirestoreUsers() {
        try {
          const snap = await getDocs(collection(db, 'users'));
          const users = [];
          snap.forEach(d => {
            const data = d.data();
            if (data.approved && data.status !== 'REVOKED') {
              users.push({ id: d.id, ...data });
            }
          });
          return users;
        } catch (err) {
          console.warn('Erreur chargement users Firestore:', err.message);
          return [];
        }
      }

      /** Retourne les utilisateurs MISSING (enregistr√©s mais pas d'unit√© li√©e avec un vrai rang) */
      function getMissingUsers() {
        return allFirestoreUsers.filter(u => {
          if (!u.matricule) return false;
          const unitEntry = allUnits.find(unit => unit.matricule === u.matricule);
          return !unitEntry || !unitEntry.rang || unitEntry.rang === 'MISSING';
        });
      }

      window.openAddModal = function() {
        document.getElementById('modalTitle').textContent = 'AJOUTER UNE UNIT√â';
        document.getElementById('editId').value = '';
        document.getElementById('fMatricule').value = '';
        document.getElementById('fMatricule').disabled = false;
        document.getElementById('fSteamid').value = '';
        document.getElementById('fNomSteam').value = '';
        document.getElementById('fDiscord').value = '';
        document.getElementById('fDivision').value = '';
        document.getElementById('fRang').value = '';
        document.getElementById('fOrdre').value = '';
        document.getElementById('fDateEntree').value = '';
        document.getElementById('fFormateur').checked = false;

        // Populate missing users dropdown
        const missingSection = document.getElementById('missingUserSection');
        const missingSelect = document.getElementById('missingUserSelect');
        const missingUsers = getMissingUsers();
        if (missingUsers.length > 0) {
          missingSection.style.display = 'block';
          missingSelect.innerHTML = '<option value="">‚Äî S√©lectionner un utilisateur MISSING (' + missingUsers.length + ') ‚Äî</option>' +
            missingUsers.map(u => `<option value="${u.id}">[${u.matricule}] ${u.nom_steam || u.email || '?'} ‚Äî ${u.discord || '-'}</option>`).join('');
          missingSelect.onchange = function() {
            const selected = missingUsers.find(u => u.id === this.value);
            if (selected) {
              document.getElementById('fMatricule').value = selected.matricule || '';
              document.getElementById('fSteamid').value = selected.steamid64 || '';
              document.getElementById('fNomSteam').value = selected.nom_steam || '';
              document.getElementById('fDiscord').value = selected.discord || '';
            }
          };
        } else {
          missingSection.style.display = 'none';
        }

        document.getElementById('unitModal').classList.add('visible');
      };

      window.editUnit = function(matricule) {
        const unit = allUnits.find(u => u.matricule === matricule);
        if (!unit) return;

        document.getElementById('modalTitle').textContent = 'MODIFIER UNIT√â ‚Äî ' + unit.matricule;
        document.getElementById('editId').value = unit.matricule;
        document.getElementById('missingUserSection').style.display = 'none';
        document.getElementById('fMatricule').value = unit.matricule || '';
        document.getElementById('fMatricule').disabled = true;
        document.getElementById('fSteamid').value = unit.steamid64 || '';
        document.getElementById('fNomSteam').value = unit.nom_steam || '';
        document.getElementById('fDiscord').value = unit.discord || '';
        document.getElementById('fDivision').value = unit.division || '';
        document.getElementById('fRang').value = unit.rang || '';
        document.getElementById('fOrdre').value = unit.ordre || '';
        document.getElementById('fDateEntree').value = unit.date_entree || '';
        document.getElementById('fFormateur').checked = unit.formateur || false;
        document.getElementById('unitModal').classList.add('visible');
      };

      window.closeModal = function() {
        document.getElementById('unitModal').classList.remove('visible');
      };

      // Close modal on overlay click
      document.getElementById('unitModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('unitModal')) closeModal();
      });

      // ========== SAVE UNIT ==========
      window.saveUnit = async function() {


        const editId = document.getElementById('editId').value;
        const matricule = document.getElementById('fMatricule').value.trim();
        const steamid64 = document.getElementById('fSteamid').value.trim();
        const nom_steam = document.getElementById('fNomSteam').value.trim();
        const discord = document.getElementById('fDiscord').value.trim();
        const division = document.getElementById('fDivision').value;
        const rang = document.getElementById('fRang').value;
        const ordre = document.getElementById('fOrdre').value.trim();
        const date_entree = document.getElementById('fDateEntree').value;
        const formateur = document.getElementById('fFormateur').checked;

        if (!matricule) {
          showAlert('Le matricule est obligatoire', 'error');
          return;
        }

        if (!editId && allUnits.some(u => u.matricule === matricule)) {
          showAlert('Ce matricule existe d√©j√† !', 'error');
          return;
        }

        const unitData = {
          matricule,
          steamid64: steamid64 || '',
          nom_steam: nom_steam || '',
          discord: discord || '',
          division: division || '',
          rang: rang || '',
          ordre: ordre ? parseInt(ordre) : '',
          date_entree: date_entree || '',
          formateur: formateur,
          updated_at: new Date().toISOString().substring(0, 10)
        };

        // MAJ optimiste : appliquer imm√©diatement dans le tableau
        if (editId) {
          const idx = allUnits.findIndex(u => u.matricule === editId);
          if (idx !== -1) allUnits[idx] = { ...unitData, id: editId };
        } else {
          allUnits.push({ ...unitData, id: matricule });
        }

        closeModal();
        updateStats();
        renderTable();

        // Sauvegarde s√©rialis√©e + confirmation
        const label = editId ? `Modification unit√© ${matricule}` : `Ajout unit√© ${matricule}`;
        await queueSave(async () => {
          const toSave = allUnits.map(({ id, ...rest }) => rest);
          await ghSaveUnits(toSave, label);
          showAlert('‚úì ' + label + ' ‚Äî Synchronis√©', 'success');
        });
      };

      // ========== FIRE UNIT (VIRER) ==========
      window.fireUnit = async function(matricule) {
        const unit = allUnits.find(u => u.matricule === matricule);
        if (!unit) return;
        if (!confirm(`Virer l'unit√© ${matricule} (${unit.nom_steam || '?'}) de la milice ?\n\nL'unit√© sera archiv√©e et pourra √™tre r√©int√©gr√©e depuis les archives.`)) return;

        // Archiver l'unit√©
        const firedData = {
          matricule: unit.matricule || '',
          steamid64: unit.steamid64 || '',
          nom_steam: unit.nom_steam || '',
          discord: unit.discord || '',
          division: unit.division || '',
          rang: unit.rang || '',
          ordre: unit.ordre || '',
          date_entree: unit.date_entree || '',
          formateur: unit.formateur || false,
          fired_at: new Date().toISOString(),
          fired_reason: 'Vir√© de la milice'
        };

        try {
          await addFiredUnit(firedData);
        } catch (err) {
          showAlert('‚ö† Erreur archivage: ' + err.message, 'error');
          return;
        }

        // Retirer de la liste active
        allUnits = allUnits.filter(u => u.matricule !== matricule);
        updateStats();
        renderTable();

        // Sauvegarder la liste active (s√©rialis√©)
        await queueSave(async () => {
          const toSave = allUnits.map(({ id, ...rest }) => rest);
          await ghSaveUnits(toSave, `Unit√© ${matricule} vir√©e`);
          showAlert(`‚úì Unit√© ${matricule} vir√©e, archiv√©e et synchronis√©e`, 'success');
        });
      };

      // ========== DELETE UNIT ==========
      window.deleteUnit = async function(matricule) {
        const unit = allUnits.find(u => u.matricule === matricule);
        if (!unit) return;
        if (!confirm(`Supprimer l'unit√© ${matricule} de la liste ?`)) return;

        // Suppression optimiste
        allUnits = allUnits.filter(u => u.matricule !== matricule);
        updateStats();
        renderTable();

        // Sauvegarde s√©rialis√©e
        await queueSave(async () => {
          const toSave = allUnits.map(({ id, ...rest }) => rest);
          await ghSaveUnits(toSave, `Suppression unit√© ${matricule}`);
          showAlert('‚úì Unit√© supprim√©e et synchronis√©e', 'success');
        });
      };

      // ========== TOGGLE FORMATEUR ==========
      window.toggleFormateur = async function(matricule) {
        const idx = allUnits.findIndex(u => u.matricule === matricule);
        if (idx === -1) { showAlert('Unit√© introuvable: ' + matricule, 'error'); return; }
        const current = allUnits[idx].formateur || false;
        allUnits[idx].formateur = !current;
        allUnits[idx].updated_at = new Date().toISOString().substring(0, 10);
        renderTable();

        await queueSave(async () => {
          const toSave = allUnits.map(({ id, ...rest }) => rest);
          await ghSaveUnits(toSave, `${!current ? 'Ajout' : 'Retrait'} formateur ${matricule}`);
          showAlert(`‚úì ${matricule} ‚Äî Formateur ${!current ? 'ACTIV√â' : 'D√âSACTIV√â'} ‚Äî Synchronis√©`, 'success');
        });
      };

      // ========== FILTERS ==========
      document.getElementById('searchInput').addEventListener('input', renderTable);
      document.getElementById('divisionFilter').addEventListener('change', renderTable);
      document.getElementById('rangFilter').addEventListener('change', renderTable);

      // ========== AUTH CHECK ==========
      onAuthStateChanged(auth, async (user) => {
        if (!user) return;
        try {
          // Tentative de v√©rification admin via Firestore
          const snap = await getDoc(doc(db, 'users', user.uid));
          if (!snap.exists()) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('access-denied').style.display = 'block';
            return;
          }
          const uData = snap.data();
          if (!uData.is_admin && !uData.is_hg) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('access-denied').style.display = 'block';
            return;
          }
          currentUserMatricule = uData.matricule || '';
        } catch (err) {
          console.warn('Firestore admin check failed, allowing authenticated user:', err.message);
        }
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        await loadUnits();
      });
    </script>
</body>
</html>
