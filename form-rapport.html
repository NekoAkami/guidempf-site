<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport d'Activité - MPF</title>
    <link rel="stylesheet" href="assets/css/main-style.css">
    <link rel="stylesheet" href="assets/css/combine-terminals.css">
    <link rel="stylesheet" href="assets/css/global-nav.css">
    <link rel="stylesheet" href="assets/css/interactive-system.css">
    <link rel="stylesheet" href="assets/css/combine-animations.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        .rapport-wrapper { max-width: 700px; margin: 0 auto; }

        .user-info-bar {
            display: flex; align-items: center; gap: 1rem;
            padding: 0.8rem 1rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.15);
            border-radius: 4px; margin-bottom: 1.5rem;
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
        }
        .user-info-bar .user-avatar {
            width: 42px; height: 42px;
            background: rgba(0, 170, 255, 0.15);
            border: 1px solid var(--accent-cyan); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron', sans-serif; font-size: 0.85rem;
            color: var(--accent-cyan); font-weight: 700; flex-shrink: 0;
        }
        .user-info-bar .user-details { flex: 1; }
        .user-info-bar .user-matricule {
            font-family: 'Orbitron', sans-serif; font-size: 0.82rem;
            color: var(--accent-cyan); font-weight: 700;
        }
        .user-info-bar .user-status {
            font-size: 0.68rem; padding: 0.15rem 0.5rem; border-radius: 2px;
            background: rgba(0, 200, 80, 0.1); border: 1px solid rgba(0, 200, 80, 0.3); color: #00cc55;
        }

        .form-group { margin-bottom: 1.2rem; }
        .form-group label {
            display: block; font-family: 'Share Tech Mono', monospace;
            font-size: 0.72rem; color: var(--text-muted);
            letter-spacing: 1px; margin-bottom: 0.3rem;
        }
        .form-group label .req { color: #ff4444; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 0.5rem 0.7rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace; font-size: 0.82rem;
            outline: none; border-radius: 2px;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--accent-cyan);
        }
        .form-group select { cursor: pointer; }
        .form-group select option { background: #0a1628; color: var(--text-primary); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group .hint {
            font-size: 0.68rem; color: var(--text-muted); margin-top: 0.2rem;
            font-family: 'Share Tech Mono', monospace;
        }
        .form-group.error input, .form-group.error textarea, .form-group.error select {
            border-color: #ff4444;
        }
        .form-group .error-msg {
            font-size: 0.7rem; color: #ff4444; margin-top: 0.2rem;
            font-family: 'Share Tech Mono', monospace; display: none;
        }
        .form-group.error .error-msg { display: block; }

        /* Champ conditionnel rations */
        #grpCitoyens { display: none; }
        #grpCitoyens.visible { display: block; }

        /* Sélection multiple unités */
        .units-selector {
            position: relative;
        }
        .units-input-row {
            display: flex; align-items: center; gap: 0;
        }
        .units-input-row input {
            flex: 1; border-radius: 2px 0 0 2px !important;
        }
        .units-toggle-btn {
            padding: 0.5rem 0.6rem;
            background: rgba(0, 170, 255, 0.12);
            border: 1px solid rgba(0, 170, 255, 0.2);
            border-left: none;
            color: var(--accent-cyan);
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'Share Tech Mono', monospace;
            border-radius: 0 2px 2px 0;
            transition: background 0.15s, border-color 0.15s;
            display: flex; align-items: center; justify-content: center;
            min-width: 32px;
            height: 100%;
        }
        .units-toggle-btn:hover {
            background: rgba(0, 170, 255, 0.25);
            border-color: var(--accent-cyan);
        }
        .units-toggle-btn.active {
            background: rgba(0, 170, 255, 0.2);
            border-color: var(--accent-cyan);
        }
        .units-dropdown {
            display: none;
            position: absolute; left: 0; right: 0; top: 100%;
            background: #0a1628;
            border: 1px solid rgba(0, 170, 255, 0.3);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            border-radius: 0 0 4px 4px;
        }
        .units-dropdown.open { display: block; }
        .units-dropdown-search {
            width: 100%; padding: 0.4rem 0.6rem;
            background: rgba(0, 170, 255, 0.06);
            border: none; border-bottom: 1px solid rgba(0, 170, 255, 0.15);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace; font-size: 0.78rem;
            outline: none;
        }
        .units-dropdown-item {
            padding: 0.35rem 0.6rem;
            font-family: 'Share Tech Mono', monospace; font-size: 0.78rem;
            color: var(--text-primary);
            cursor: pointer;
            display: flex; align-items: center; gap: 0.5rem;
            transition: background 0.1s;
        }
        .units-dropdown-item:hover { background: rgba(0, 170, 255, 0.1); }
        .units-dropdown-item.selected { background: rgba(0, 170, 255, 0.15); }
        .units-dropdown-item .unit-check {
            width: 14px; height: 14px;
            border: 1px solid rgba(0, 170, 255, 0.4);
            border-radius: 2px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.65rem; color: var(--accent-cyan);
            flex-shrink: 0;
        }
        .units-dropdown-item.selected .unit-check {
            background: rgba(0, 170, 255, 0.2);
            border-color: var(--accent-cyan);
        }
        .units-tags {
            display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.4rem;
        }
        .unit-tag {
            display: inline-flex; align-items: center; gap: 0.3rem;
            padding: 0.15rem 0.45rem;
            background: rgba(0, 170, 255, 0.12);
            border: 1px solid rgba(0, 170, 255, 0.25);
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace; font-size: 0.72rem;
            color: var(--accent-cyan);
        }
        .unit-tag .remove-tag {
            cursor: pointer; color: #ff6666; font-size: 0.8rem;
            margin-left: 0.1rem;
        }
        .unit-tag .remove-tag:hover { color: #ff4444; }

        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (max-width: 500px) { .row-2 { grid-template-columns: 1fr; } }

        .form-actions {
            display: flex; gap: 0.8rem; margin-top: 1.5rem; justify-content: flex-end;
        }
        .btn-action {
            padding: 0.5rem 1.2rem; font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem; cursor: pointer;
            border: 1px solid rgba(0, 170, 255, 0.4);
            background: rgba(0, 170, 255, 0.1); color: var(--accent-cyan);
            border-radius: 3px; transition: all 0.15s; letter-spacing: 0.5px;
        }
        .btn-action:hover { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); }
        .btn-action.primary { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); font-weight: 700; }
        .btn-action.primary:hover { background: rgba(0, 170, 255, 0.35); }
        .btn-action:disabled { opacity: 0.4; cursor: not-allowed; }

        .alert-msg {
            padding: 0.6rem 1rem; border-radius: 3px; margin-bottom: 1rem;
            font-size: 0.8rem; font-family: 'Share Tech Mono', monospace; display: none;
        }
        .alert-msg.success { display: block; background: rgba(0, 200, 80, 0.1); border: 1px solid rgba(0, 200, 80, 0.3); color: #00cc55; }
        .alert-msg.error { display: block; background: rgba(255, 60, 60, 0.1); border: 1px solid rgba(255, 60, 60, 0.3); color: #ff4444; }

        .my-reports-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .my-reports-table th {
            text-align: left; padding: 0.5rem 0.4rem;
            color: var(--accent-cyan); font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem; letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.2);
        }
        .my-reports-table td {
            padding: 0.4rem; color: var(--text-primary);
            border-bottom: 1px solid rgba(0, 170, 255, 0.06); vertical-align: middle;
        }
        .my-reports-table tr:hover { background: rgba(0, 170, 255, 0.03); }
        .type-badge {
            display: inline-block; padding: 0.1rem 0.4rem; border-radius: 2px;
            font-family: 'Share Tech Mono', monospace; font-size: 0.68rem;
            font-weight: 700; letter-spacing: 0.5px;
            background: rgba(0, 170, 255, 0.15); color: var(--accent-cyan);
            border: 1px solid rgba(0, 170, 255, 0.3);
        }

        .sync-indicator {
            position: fixed; bottom: 1rem; right: 1rem;
            padding: 0.4rem 0.8rem; border-radius: 3px;
            font-family: 'Share Tech Mono', monospace; font-size: 0.72rem;
            z-index: 999; transition: all 0.3s; pointer-events: none; opacity: 0;
        }
        .sync-indicator.syncing { opacity: 1; background: rgba(255, 200, 0, 0.15); border: 1px solid rgba(255, 200, 0, 0.4); color: #ffc800; }
        .sync-indicator.synced { opacity: 1; background: rgba(0, 200, 80, 0.15); border: 1px solid rgba(0, 200, 80, 0.4); color: #00cc55; }
        .sync-indicator.error { opacity: 1; background: rgba(255, 60, 60, 0.15); border: 1px solid rgba(255, 60, 60, 0.4); color: #ff4444; }
        .sync-indicator.hidden { opacity: 0; }
        @keyframes spin-sync { to { transform: rotate(360deg); } }
        .sync-spinner { display: inline-block; animation: spin-sync 1s linear infinite; }

        #access-denied, #notApproved { display: none; text-align: center; padding: 3rem; }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>

    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">Rapport d'Activité</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p>
            </div>
            <div id="access-denied">
                <h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">CONNEXION REQUISE</h2>
                <p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.5rem;">Vous devez être connecté pour soumettre un rapport.</p>
                <a href="login.html" style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;display:inline-block;margin-top:1rem;">→ SE CONNECTER</a>
            </div>
            <div id="notApproved">
                <h2 style="color:#ffaa00;font-family:'Orbitron',sans-serif;">EN ATTENTE D'APPROBATION</h2>
                <p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.5rem;">Votre compte n'a pas encore été approuvé.</p>
            </div>

            <div id="mainContent" style="display:none;">
                <div class="rapport-wrapper">

                    <div class="user-info-bar" id="userInfoBar">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-details">
                            <div class="user-matricule" id="userIdentification">---</div>
                            <div id="userAccreditation" style="font-size:0.7rem;color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.15rem;"></div>
                        </div>
                        <div class="user-status">CONNECTÉ</div>
                    </div>

                    <div id="alertMsg" class="alert-msg"></div>

                    <div class="combine-terminal-wrapper">
                        <div class="combine-header">
                            <h2>RAPPORT D'ACTIVITÉ</h2>
                            <span class="header-code">FORM-01</span>
                        </div>
                        <div class="combine-body">

                            <div class="row-2">
                                <div class="form-group" id="grpType">
                                    <label>TYPE D'ACTIVITÉ <span class="req">*</span></label>
                                    <select id="fType" onchange="onTypeChange()">
                                        <option value="">— Sélectionner —</option>
                                        <option value="Patrouille">Patrouille</option>
                                        <option value="Opération">Opération</option>
                                        <option value="Fouille mineur">Fouille mineur</option>
                                        <option value="Fouille majeur">Fouille majeur</option>
                                        <option value="Point Passage">Point Passage</option>
                                        <option value="Protection VIP">Protection VIP</option>
                                        <option value="Distribution ration">Distribution ration</option>
                                        <option value="Formation">Formation</option>
                                        <option value="Conscription">Conscription</option>
                                        <option value="Interrogatoire">Interrogatoire</option>
                                        <option value="Test de loyauté">Test de loyauté</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                                    <div class="error-msg" id="errType"></div>
                                </div>
                                <div class="form-group" id="grpSecteur">
                                    <label>SECTEUR / ZONE</label>
                                    <input type="text" id="fSecteur" placeholder="Ex: Secteur 3, Nexus, Slums...">
                                </div>
                            </div>

                            <!-- Champ conditionnel : nombre de citoyens (Distribution ration) -->
                            <div class="form-group" id="grpCitoyens">
                                <label>NOMBRE DE CITOYENS <span class="req">*</span></label>
                                <input type="number" id="fCitoyens" min="0" placeholder="Nombre de citoyens présents">
                                <div class="hint">Indiquez combien de citoyens étaient présents lors de la distribution</div>
                                <div class="error-msg" id="errCitoyens"></div>
                            </div>

                            <!-- Sélection des unités avec dropdown optionnel -->
                            <div class="form-group" id="grpUnites">
                                <label>UNITÉS IMPLIQUÉES</label>
                                <div class="units-selector" id="unitsSelectorWrapper">
                                    <div class="units-input-row">
                                        <input type="text" id="fUnites" placeholder="Ex: 954, 123, 456" onkeydown="onUnitInputKey(event)">
                                        <button type="button" class="units-toggle-btn" id="unitsToggleBtn" onclick="toggleUnitsDropdown()" title="Afficher la liste des unités">▼</button>
                                    </div>
                                    <div class="units-dropdown" id="unitsDropdown">
                                        <input type="text" class="units-dropdown-search" id="unitsDropdownSearch" placeholder="Rechercher une unité..." oninput="filterUnitsDropdown()">
                                        <div id="unitsDropdownList"></div>
                                    </div>
                                    <div class="units-tags" id="unitsTags"></div>
                                </div>
                                <div class="hint">Saisissez les matricules séparés par des virgules ou utilisez ▼ pour sélectionner depuis la liste</div>
                            </div>

                            <div class="form-group" id="grpResume">
                                <label>RÉSUMÉ DE L'ACTIVITÉ <span class="req">*</span></label>
                                <textarea id="fResume" rows="5" placeholder="Décrivez le déroulement de l'activité..."></textarea>
                                <div class="error-msg" id="errResume"></div>
                            </div>

                            <div class="form-group">
                                <label>NOTES SUPPLÉMENTAIRES</label>
                                <textarea id="fNotes" rows="2" placeholder="Informations complémentaires (optionnel)"></textarea>
                            </div>

                            <div class="form-actions">
                                <button class="btn-action" onclick="resetForm()">RÉINITIALISER</button>
                                <button class="btn-action primary" id="btnSubmit" onclick="submitReport()">⟩ SOUMETTRE LE RAPPORT</button>
                            </div>
                        </div>
                    </div>

                    <div class="combine-terminal-wrapper" style="margin-top: 1.5rem;">
                        <div class="combine-header">
                            <h2>MES RAPPORTS</h2>
                            <span class="header-code" id="myReportCount">0</span>
                        </div>
                        <div class="combine-body">
                            <div style="overflow-x:auto;">
                                <table class="my-reports-table">
                                    <thead>
                                        <tr>
                                            <th>DATE</th>
                                            <th>TYPE</th>
                                            <th>SECTEUR</th>
                                            <th>RÉSUMÉ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myReportsBody">
                                        <tr><td colspan="4" style="text-align:center;color:var(--text-muted);">Aucun rapport soumis</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script type="module" src="assets/js/auth.js"></script>
    <script src="assets/js/global-nav.js"></script>
    <script src="assets/js/interactive-system.js"></script>
    <script src="assets/js/combine-animations.js"></script>

    <script type="module">
      import { auth, db } from './assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { loadReports as ghLoadReports, saveReports as ghSaveReports, loadUnits as ghLoadUnits, onSyncStatus } from './assets/js/github-data.js';

      function getAccreditation(r) {
        if (r === 'RCT') return 'Recrue';
        if (['.05','.04','.03','STB'].includes(r)) return 'MPF';
        if (['.02','.01','DvL','STBE','CABAL'].includes(r)) return 'MPEF';
        if (['Ofc','Cmd'].includes(r)) return 'HautGradé';
        return '';
      }

      { const i=document.createElement('div');i.id='syncIndicator';i.className='sync-indicator hidden';document.body.appendChild(i);let t=null;
        onSyncStatus(s=>{clearTimeout(t);if(s==='syncing'){i.innerHTML='<span class="sync-spinner">⟳</span> Synchronisation...';i.className='sync-indicator syncing';}else if(s==='synced'){i.innerHTML='✓ Synchronisé';i.className='sync-indicator synced';t=setTimeout(()=>i.className='sync-indicator hidden',2500);}else{i.innerHTML='⚠ Erreur sync';i.className='sync-indicator error';t=setTimeout(()=>i.className='sync-indicator hidden',6000);}});
      }

      let currentUser = null, allReports = [], allUnitsData = [], selectedUnits = new Set();

      function showAlert(t, type='success') { const e=document.getElementById('alertMsg'); e.style.display='block'; e.className='alert-msg '+type; e.textContent=t; setTimeout(()=>e.style.display='none',6000); }
      function fmtDate(d) { if(!d)return'-'; const p=d.split('-'); return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d; }

      /* === Gestion type d'activité conditionnel === */
      window.onTypeChange = function() {
        const v = document.getElementById('fType').value;
        const grp = document.getElementById('grpCitoyens');
        const secteurInput = document.getElementById('fSecteur');
        if (v === 'Distribution ration') {
          grp.classList.add('visible');
          secteurInput.disabled = true;
          secteurInput.value = '';
          secteurInput.style.opacity = '0.4';
          secteurInput.style.cursor = 'not-allowed';
          secteurInput.placeholder = 'Non applicable pour Distribution ration';
        } else {
          grp.classList.remove('visible');
          document.getElementById('fCitoyens').value = '';
          secteurInput.disabled = false;
          secteurInput.style.opacity = '1';
          secteurInput.style.cursor = '';
          secteurInput.placeholder = 'Ex: Secteur 3, Nexus, Slums...';
        }
      };

      /* === Gestion du dropdown des unités === */
      window.toggleUnitsDropdown = function() {
        const dd = document.getElementById('unitsDropdown');
        const btn = document.getElementById('unitsToggleBtn');
        const isOpen = dd.classList.contains('open');
        if (isOpen) {
          dd.classList.remove('open');
          btn.classList.remove('active');
          btn.textContent = '▼';
        } else {
          dd.classList.add('open');
          btn.classList.add('active');
          btn.textContent = '▲';
          document.getElementById('unitsDropdownSearch').value = '';
          filterUnitsDropdown();
          document.getElementById('unitsDropdownSearch').focus();
        }
      };

      // Fermer le dropdown en cliquant ailleurs
      document.addEventListener('click', function(e) {
        const wrapper = document.getElementById('unitsSelectorWrapper');
        if (wrapper && !wrapper.contains(e.target)) {
          const dd = document.getElementById('unitsDropdown');
          const btn = document.getElementById('unitsToggleBtn');
          if (dd && dd.classList.contains('open')) {
            dd.classList.remove('open');
            btn.classList.remove('active');
            btn.textContent = '▼';
          }
        }
      });

      window.filterUnitsDropdown = function() {
        const q = (document.getElementById('unitsDropdownSearch').value || '').toLowerCase();
        const list = document.getElementById('unitsDropdownList');
        const filtered = allUnitsData.filter(u => {
          const txt = `${u.matricule} ${u.nom_steam||''} ${u.division||''}`.toLowerCase();
          return txt.includes(q);
        });
        list.innerHTML = filtered.length ? filtered.map(u => {
          const sel = selectedUnits.has(u.matricule) ? ' selected' : '';
          const check = selectedUnits.has(u.matricule) ? '✓' : '';
          const divLabel = u.division ? ` <span style="color:var(--text-muted);font-size:0.7rem;">[${u.division}]</span>` : '';
          return `<div class="units-dropdown-item${sel}" data-mat="${u.matricule}" onclick="toggleUnitSelection('${u.matricule}')">
            <span class="unit-check">${check}</span>
            <span>${u.matricule} — ${u.nom_steam||'Inconnu'}${divLabel}</span>
          </div>`;
        }).join('') : '<div style="padding:0.5rem;color:var(--text-muted);font-size:0.78rem;text-align:center;">Aucune unité trouvée</div>';
      };

      window.toggleUnitSelection = function(mat) {
        if (selectedUnits.has(mat)) {
          selectedUnits.delete(mat);
        } else {
          selectedUnits.add(mat);
        }
        renderUnitsTags();
        filterUnitsDropdown();
        syncUnitsInput();
      };

      window.removeUnitTag = function(mat) {
        selectedUnits.delete(mat);
        renderUnitsTags();
        filterUnitsDropdown();
        syncUnitsInput();
      };

      function renderUnitsTags() {
        const container = document.getElementById('unitsTags');
        if (!selectedUnits.size) { container.innerHTML = ''; return; }
        container.innerHTML = Array.from(selectedUnits).map(mat => {
          const u = allUnitsData.find(x => x.matricule === mat);
          const label = u ? `${mat} (${u.nom_steam||'?'})` : mat;
          return `<span class="unit-tag">${label}<span class="remove-tag" onclick="removeUnitTag('${mat}')">&times;</span></span>`;
        }).join('');
      }

      function syncUnitsInput() {
        document.getElementById('fUnites').value = Array.from(selectedUnits).join(', ');
      }

      window.onUnitInputKey = function(e) {
        if (e.key === 'Enter') { e.preventDefault(); parseManualUnits(); }
      };

      function parseManualUnits() {
        const raw = document.getElementById('fUnites').value;
        const mats = raw.split(/[,;\s]+/).map(s => s.trim()).filter(Boolean);
        mats.forEach(m => { if (m) selectedUnits.add(m); });
        syncUnitsInput();
        renderUnitsTags();
        filterUnitsDropdown();
      }

      function populateUnitsDropdown(units) {
        allUnitsData = units || [];
        filterUnitsDropdown();
      }

      window.submitReport = async function() {
        if (!currentUser) { showAlert('Erreur: utilisateur non identifié','error'); return; }
        // Parse les unités manuelles avant soumission
        parseManualUnits();

        let ok=true;
        ['grpType','grpResume'].forEach(id=>document.getElementById(id).classList.remove('error'));
        document.getElementById('grpCitoyens').classList.remove('error');
        if (!document.getElementById('fType').value) { document.getElementById('grpType').classList.add('error'); document.getElementById('errType').textContent='Sélectionnez un type'; ok=false; }
        if (!document.getElementById('fResume').value.trim()) { document.getElementById('grpResume').classList.add('error'); document.getElementById('errResume').textContent='Le résumé est obligatoire'; ok=false; }
        // Validation citoyens si Distribution ration
        if (document.getElementById('fType').value === 'Distribution ration') {
          const nb = document.getElementById('fCitoyens').value;
          if (!nb || parseInt(nb) < 0) {
            document.getElementById('grpCitoyens').classList.add('error');
            document.getElementById('errCitoyens').textContent='Indiquez le nombre de citoyens';
            ok=false;
          }
        }
        if (!ok) return;

        const btn=document.getElementById('btnSubmit'); btn.disabled=true; btn.textContent='⏳ ENVOI...';
        const r = {
          matricule: currentUser.matricule, nom_steam: currentUser.nom_steam||'',
          type: document.getElementById('fType').value,
          secteur: document.getElementById('fSecteur').value.trim(),
          unites: document.getElementById('fUnites').value.trim(),
          resume: document.getElementById('fResume').value.trim(),
          notes: document.getElementById('fNotes').value.trim(),
          created_at: new Date().toISOString().substring(0,10)
        };
        // Ajouter nb citoyens si distribution ration
        if (r.type === 'Distribution ration') {
          r.nb_citoyens = parseInt(document.getElementById('fCitoyens').value) || 0;
        }
        allReports.push(r);
        try {
          await ghSaveReports([...allReports], `Rapport ${currentUser.matricule} - ${r.type}`);
          showAlert('✓ Rapport soumis avec succès !','success');
          resetForm(); renderMyReports();
        } catch(e) { allReports.pop(); showAlert('✗ Erreur: '+e.message,'error'); }
        finally { btn.disabled=false; btn.textContent='⟩ SOUMETTRE LE RAPPORT'; }
      };

      window.resetForm = function() {
        ['fType','fSecteur','fUnites','fResume','fNotes','fCitoyens'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
        ['grpType','grpResume','grpCitoyens'].forEach(id=>document.getElementById(id).classList.remove('error'));
        document.getElementById('grpCitoyens').classList.remove('visible');
        selectedUnits.clear();
        renderUnitsTags();
        filterUnitsDropdown();
        // Fermer le dropdown
        const dd=document.getElementById('unitsDropdown'), btn=document.getElementById('unitsToggleBtn');
        if(dd){dd.classList.remove('open');} if(btn){btn.classList.remove('active');btn.textContent='▼';}
      };

      function renderMyReports() {
        if(!currentUser)return;
        const mine=allReports.filter(r=>r.matricule===currentUser.matricule).sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||''));
        document.getElementById('myReportCount').textContent=`${mine.length} RAPPORT${mine.length>1?'S':''}`;
        const tb=document.getElementById('myReportsBody');
        if(!mine.length){tb.innerHTML='<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">Aucun rapport soumis</td></tr>';return;}
        tb.innerHTML=mine.map(r=>`<tr>
          <td style="font-size:0.75rem;">${fmtDate(r.created_at)}</td>
          <td><span class="type-badge">${r.type}</span></td>
          <td style="font-size:0.75rem;">${r.secteur||'-'}</td>
          <td style="font-size:0.75rem;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(r.resume||'').replace(/"/g,'&quot;')}">${r.resume||'-'}</td>
        </tr>`).join('');
      }

      onAuthStateChanged(auth, async(user) => {
        if(!user){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
        try {
          const s=await getDoc(doc(db,'users',user.uid));
          if(!s.exists()){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
          const ud=s.data();
          if(!ud.approved){document.getElementById('loading').style.display='none';document.getElementById('notApproved').style.display='block';return;}
          currentUser={matricule:ud.matricule||'???',nom_steam:ud.nom_steam||'',steamid64:ud.steamid64||''};
          let ui=null;try{const u=await ghLoadUnits();allUnitsData=u||[];populateUnitsDropdown(allUnitsData);ui=u.find(x=>x.matricule===currentUser.matricule)||null;}catch(_){allUnitsData=[];}
          const rg=ui?(ui.rang||''):'';const isHG=rg==='Ofc'||rg==='Cmd';const dv=ui&&!isHG?(ui.division||''):'';
          const acc=getAccreditation(rg);
          document.getElementById('userIdentification').textContent='Identification : '+[rg,dv,currentUser.matricule].filter(Boolean).join(' ');
          document.getElementById('userAvatar').textContent=currentUser.matricule.substring(0,3);
          if(acc){let l='Accréditation : '+acc;if(ui&&ui.formateur)l+=' — '+((acc==='MPF'||acc==='Recrue')?'Unité Formatrice MPF':'Unité Formatrice MPEF');document.getElementById('userAccreditation').textContent=l;}
          document.getElementById('loading').style.display='none';document.getElementById('mainContent').style.display='block';
          try{allReports=await ghLoadReports();}catch(_){allReports=[];}
          renderMyReports();
        }catch(e){console.error(e);document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';}
      });
    </script>
</body>
</html>
