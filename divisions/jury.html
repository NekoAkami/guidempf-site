<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Division JURY - MPF Documentation</title>
    <link rel="stylesheet" href="../assets/css/bundle.css">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <style>
        .div-wrapper { max-width: 1000px; margin: 0 auto; }
        .div-header-card {
            padding: 1.5rem; margin-bottom: 1.5rem;
            background: rgba(231, 76, 60, 0.03);
            border: 1px solid rgba(231, 76, 60, 0.15);
            border-left: 4px solid #e74c3c;
            border-radius: 4px;
        }
        .div-header-card h2 {
            font-family: 'Orbitron', sans-serif; font-size: 1.3rem;
            color: #e74c3c; margin-bottom: 0.5rem;
        }
        .div-header-card p { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; }
        .div-info { color: var(--text-muted); font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; margin-top: 0.5rem; }
        .sub-pages { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .sub-page-card {
            padding: 1rem; background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 4px;
            text-decoration: none; display: block; transition: all 0.15s;
        }
        .sub-page-card:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.25); }
        .sub-page-card h3 { color: #e74c3c; font-family: 'Orbitron', sans-serif; font-size: 0.85rem; margin-bottom: 0.3rem; }
        .sub-page-card p { color: var(--text-muted); font-size: 0.8rem; }
        .jury-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .jury-tab { padding: 0.5rem 1rem; border-radius: 3px; cursor: pointer; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; border: 1px solid rgba(231,76,60,0.3); background: rgba(231,76,60,0.05); color: #e74c3c; transition: all 0.15s; font-weight: 700; }
        .jury-tab:hover { background: rgba(231,76,60,0.15); }
        .jury-tab.active { background: rgba(231,76,60,0.2); border-color: #e74c3c; }
        .jury-tab-content { display: none; }
        .jury-tab-content.active { display: block; }
        .rapports-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .rapports-table th {
            text-align: left; padding: 0.5rem 0.4rem; color: #e74c3c;
            font-family: 'Share Tech Mono', monospace; font-size: 0.68rem;
            letter-spacing: 1px; border-bottom: 2px solid rgba(255,255,255,0.15);
            cursor: pointer; user-select: none;
        }
        .rapports-table td {
            padding: 0.4rem; color: var(--text-primary);
            border-bottom: 1px solid rgba(255,255,255,0.04);
            font-family: 'Share Tech Mono', monospace; vertical-align: middle;
        }
        .rapports-table tr:hover { background: rgba(255,255,255,0.02); }
        .type-badge {
            display: inline-block; padding: 0.1rem 0.4rem; border-radius: 2px;
            font-family: 'Share Tech Mono', monospace; font-size: 0.68rem;
            font-weight: 700; background: rgba(255,255,255,0.1); color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .search-bar { margin-bottom: 1rem; display: flex; gap: 0.5rem; }
        .search-bar input {
            flex: 1; padding: 0.45rem 0.7rem; background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.15); color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
            outline: none; border-radius: 2px;
        }
        .search-bar input:focus { border-color: #e74c3c; }
        .pagination {
            display: flex; gap: 0.5rem; justify-content: center; align-items: center;
            margin-top: 1rem; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
        }
        .pagination button {
            padding: 0.3rem 0.7rem; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2); color: #fff;
            cursor: pointer; font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; border-radius: 2px;
        }
        .pagination button:hover { background: rgba(255,255,255,0.1); }
        .pagination button:disabled { opacity: 0.3; cursor: not-allowed; }
        .pagination button.active { background: rgba(255,255,255,0.15); font-weight: 700; }
        .pagination .page-info { color: var(--text-muted); }
        .report-detail-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.75); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .report-detail-box { background: #0a1628; border: 1px solid rgba(255,255,255,0.2); padding: 1.5rem; border-radius: 6px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .report-detail-box h3 { color: #fff; font-family: 'Orbitron', sans-serif; font-size: 0.9rem; margin-bottom: 1rem; }
        .report-detail-box .detail-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; font-family: 'Share Tech Mono', monospace; font-size: 0.82rem; }
        .report-detail-box .detail-label { color: var(--text-muted); min-width: 120px; }
        .report-detail-box .detail-value { color: var(--text-primary); flex: 1; }
        .report-detail-box .close-btn { margin-top: 1rem; padding: 0.4rem 1rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #fff; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; cursor: pointer; border-radius: 3px; display: block; margin-left: auto; }
        .status-badge { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 2px; font-size: 0.68rem; font-weight: 700; }
        .status-badge.pending { background: rgba(255,200,0,0.15); color: #ffc800; border: 1px solid rgba(255,200,0,0.3); }
        .status-badge.treated { background: rgba(0,200,80,0.15); color: #00cc55; border: 1px solid rgba(0,200,80,0.3); }
        .status-badge.archived { background: rgba(150,150,150,0.15); color: #999; border: 1px solid rgba(150,150,150,0.3); }
        .complaint-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .complaint-actions button { padding: 0.4rem 0.8rem; font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; cursor: pointer; border-radius: 3px; transition: all 0.15s; }
        .complaint-actions .btn-treat { border: 1px solid rgba(0,200,80,0.4); background: rgba(0,200,80,0.1); color: #00cc55; }
        .complaint-actions .btn-treat:hover { background: rgba(0,200,80,0.2); }
        .complaint-actions .btn-archive { border: 1px solid rgba(150,150,150,0.4); background: rgba(150,150,150,0.1); color: #999; }
        .complaint-actions .btn-archive:hover { background: rgba(150,150,150,0.2); }
        #access-denied { display: none; text-align: center; padding: 3rem; }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">Division JURY</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:#e74c3c;font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p>
            </div>
            <div id="access-denied">
                <h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">ACC√àS REFUS√â</h2>
                <p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.5rem;">Vous n'√™tes pas membre de cette division.</p>
            </div>
            <div id="mainContent" style="display:none;">
                <div class="div-wrapper">
                    <div class="div-header-card">
                        <h2>‚öñÔ∏è DIVISION JURY</h2>
                        <p>Justice & Jugement ‚Äî Verdicts, proc√®s et application des sentences.</p>
                        <div class="div-info">ACC√àS : GRADE 05+ ‚Äî CODE COULEUR : OR</div>
                    </div>
                    <div id="divInfoSection"></div>

                    <div class="jury-tabs">
                        <button class="jury-tab active" onclick="switchJuryTab('rapports')">üìÑ RAPPORTS</button>
                        <button class="jury-tab" onclick="switchJuryTab('plaintes')">‚ö†Ô∏è PLAINTES</button>
                    </div>

                    <div id="juryTabRapports" class="jury-tab-content active">
                    <div class="combine-terminal-wrapper animate-fadeInUp" style="border-color: rgba(255,255,255,0.15);">
                        <div class="combine-header" style="border-color: rgba(255,255,255,0.1);">
                            <h2 style="color:#e74c3c;">RAPPORTS DIVISION JURY</h2>
                            <span class="header-code" id="reportCount">0</span>
                        </div>
                        <div class="combine-body">
                            <div class="search-bar">
                                <input type="text" id="searchInput" placeholder="Rechercher dans les rapports..." oninput="applyFilters()">
                            </div>
                            <div style="overflow-x:auto;">
                                <table class="rapports-table">
                                    <thead>
                                        <tr>
                                            <th onclick="sortBy('created_at')">DATE ‚ñº</th>
                                            <th onclick="sortBy('matricule')">MATRICULE</th>
                                            <th onclick="sortBy('nom_steam')">NOM</th>
                                            <th onclick="sortBy('type')">TYPE</th>
                                            <th>R√âSUM√â</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportsBody">
                                        <tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" id="pagination"></div>
                        </div>
                    </div>
                    </div>

                    <div id="juryTabPlaintes" class="jury-tab-content">
                    <div class="combine-terminal-wrapper animate-fadeInUp" style="border-color: rgba(255,255,255,0.15);">
                        <div class="combine-header" style="border-color: rgba(255,255,255,0.1);">
                            <h2 style="color:#e74c3c;">PLAINTES RE√áUES</h2>
                            <span class="header-code" id="complaintCount">0</span>
                        </div>
                        <div class="combine-body">
                            <div class="search-bar">
                                <input type="text" id="complaintSearch" placeholder="Rechercher dans les plaintes..." oninput="renderComplaints()">
                            </div>
                            <div style="overflow-x:auto;">
                                <table class="rapports-table">
                                    <thead>
                                        <tr>
                                            <th>DATE</th>
                                            <th>PLAIGNANT</th>
                                            <th>CIBLE</th>
                                            <th>CAT√âGORIE</th>
                                            <th>STATUT</th>
                                        </tr>
                                    </thead>
                                    <tbody id="complaintsBody">
                                        <tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script type="module" src="../assets/js/auth.js"></script>
    <script src="../assets/js/global-nav.js" defer></script>
    <script src="../assets/js/interactive-system.js" defer></script>
    <script src="../assets/js/combine-animations.js" defer></script>
    <script type="module">
      import { auth, db } from '../assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { loadReports, loadUnits, loadComplaints, updateComplaint } from '../assets/js/github-data.js';
      const DIVISION = 'JURY';
      let allReports = [], allComplaints = [], filteredReports = [], currentPage = 1, perPage = 20;
      let sortField = 'created_at', sortDir = 'desc';
      function fmtDate(d) { if(!d) return '-'; const p=d.split('-'); return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d; }
      window.switchJuryTab = function(tab) {
        document.querySelectorAll('.jury-tab').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.jury-tab-content').forEach(c=>c.classList.remove('active'));
        if(tab==='rapports'){document.querySelectorAll('.jury-tab')[0].classList.add('active');document.getElementById('juryTabRapports').classList.add('active');}
        else{document.querySelectorAll('.jury-tab')[1].classList.add('active');document.getElementById('juryTabPlaintes').classList.add('active');renderComplaints();}
      };
      window.applyFilters = function() {
        const q = (document.getElementById('searchInput').value || '').toLowerCase();
        filteredReports = allReports.filter(r => {
          if (r.type_rapport !== 'divisionnaire' || r.division !== DIVISION) return false;
          if (q) { const txt = `${r.matricule} ${r.nom_steam||''} ${r.type||''} ${r.resume||''}`.toLowerCase(); if (!txt.includes(q)) return false; }
          return true;
        });
        filteredReports.sort((a,b) => { const va = (a[sortField]||'').toString().toLowerCase(), vb = (b[sortField]||'').toString().toLowerCase(); return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va); });
        currentPage = 1; renderTable();
      };
      window.sortBy = function(f) { if (sortField === f) sortDir = sortDir === 'asc' ? 'desc' : 'asc'; else { sortField = f; sortDir = 'desc'; } applyFilters(); };
      function renderTable() {
        const start = (currentPage-1)*perPage; const page = filteredReports.slice(start, start+perPage);
        document.getElementById('reportCount').textContent = filteredReports.length + ' RAPPORT' + (filteredReports.length>1?'S':'');
        const tb = document.getElementById('reportsBody');
        if (!page.length) { tb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Aucun rapport divisionnaire</td></tr>'; }
        else { tb.innerHTML = page.map(r => `<tr style="cursor:pointer;" onclick="showDetail('${r._id}')"><td style="font-size:0.75rem;">${fmtDate(r.created_at)}</td><td>${r.matricule||'-'}</td><td style="font-size:0.75rem;">${r.nom_steam||'-'}</td><td><span class="type-badge">${r.type||'-'}</span></td><td style="font-size:0.75rem;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.resume||'-'}</td></tr>`).join(''); }
        const totalPages = Math.ceil(filteredReports.length/perPage)||1;
        const pag = document.getElementById('pagination');
        let html = `<button onclick="goPage(1)" ${currentPage===1?'disabled':''}>¬´</button><button onclick="goPage(${currentPage-1})" ${currentPage===1?'disabled':''}>‚Äπ</button>`;
        for (let i=Math.max(1,currentPage-2);i<=Math.min(totalPages,currentPage+2);i++) html+=`<button onclick="goPage(${i})" class="${i===currentPage?'active':''}">${i}</button>`;
        html+=`<button onclick="goPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>‚Ä∫</button><button onclick="goPage(${totalPages})" ${currentPage===totalPages?'disabled':''}>¬ª</button><span class="page-info">${currentPage}/${totalPages}</span>`;
        pag.innerHTML = html;
      }
      window.goPage = function(p) { const t=Math.ceil(filteredReports.length/perPage)||1; currentPage=Math.max(1,Math.min(t,p)); renderTable(); };
      window.showDetail = function(id) {
        const r = allReports.find(x=>x._id===id); if(!r) return;
        const o = document.createElement('div'); o.className='report-detail-overlay';
        o.innerHTML=`<div class="report-detail-box"><h3>RAPPORT DIVISIONNAIRE ‚Äî ${DIVISION}</h3><div class="detail-row"><span class="detail-label">DATE</span><span class="detail-value">${fmtDate(r.created_at)}</span></div><div class="detail-row"><span class="detail-label">MATRICULE</span><span class="detail-value">${r.matricule||'-'}</span></div><div class="detail-row"><span class="detail-label">NOM</span><span class="detail-value">${r.nom_steam||'-'}</span></div><div class="detail-row"><span class="detail-label">TYPE</span><span class="detail-value">${r.type||'-'}</span></div><div class="detail-row"><span class="detail-label">SECTEUR</span><span class="detail-value">${r.secteur||'-'}</span></div><div class="detail-row"><span class="detail-label">UNIT√âS</span><span class="detail-value">${r.unites||'-'}</span></div><div class="detail-row"><span class="detail-label">R√âSUM√â</span><span class="detail-value">${r.resume||'-'}</span></div>${r.notes?`<div class="detail-row"><span class="detail-label">NOTES</span><span class="detail-value">${r.notes}</span></div>`:''}<button class="close-btn" onclick="this.closest('.report-detail-overlay').remove()">FERMER</button></div>`;
        document.body.appendChild(o); o.addEventListener('click',e=>{if(e.target===o)o.remove();});
      };
      window.renderComplaints = function() {
        const q = (document.getElementById('complaintSearch')?.value || '').toLowerCase();
        let list = allComplaints;
        if(q) list = list.filter(c => `${c.plaignant_matricule||''} ${c.cible_matricule||''} ${c.categorie||''} ${c.description||''}`.toLowerCase().includes(q));
        list.sort((a,b) => (b.created_at||'').localeCompare(a.created_at||''));
        document.getElementById('complaintCount').textContent = list.length + ' PLAINTE' + (list.length>1?'S':'');
        const tb = document.getElementById('complaintsBody');
        if(!list.length){tb.innerHTML='<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Aucune plainte</td></tr>';return;}
        tb.innerHTML = list.map(c => {
          const sc = c.statut==='traite'?'treated':(c.statut==='archive'?'archived':'pending');
          const sl = c.statut==='traite'?'TRAIT√â':(c.statut==='archive'?'ARCHIV√â':'EN ATTENTE');
          return `<tr style="cursor:pointer;" onclick="showComplaintDetail('${c._id}')"><td style="font-size:0.75rem;">${fmtDate(c.created_at)}</td><td>${c.plaignant_matricule||'-'}</td><td>${c.cible_matricule||'-'}</td><td><span class="type-badge">${c.categorie||'-'}</span></td><td><span class="status-badge ${sc}">${sl}</span></td></tr>`;
        }).join('');
      };
      window.showComplaintDetail = function(id) {
        const c = allComplaints.find(x=>x._id===id); if(!c) return;
        const o = document.createElement('div'); o.className='report-detail-overlay';
        const sc = c.statut==='traite'?'TRAIT√â':(c.statut==='archive'?'ARCHIV√â':'EN ATTENTE');
        let actionsHtml = '';
        if(c.statut==='en_attente') actionsHtml = `<div class="complaint-actions"><button class="btn-treat" onclick="updateComplaintStatus('${c._id}','traite')">‚úì MARQUER TRAIT√â</button><button class="btn-archive" onclick="updateComplaintStatus('${c._id}','archive')">üìÅ ARCHIVER</button></div>`;
        else if(c.statut==='traite') actionsHtml = `<div class="complaint-actions"><button class="btn-archive" onclick="updateComplaintStatus('${c._id}','archive')">üìÅ ARCHIVER</button></div>`;
        o.innerHTML=`<div class="report-detail-box"><h3>PLAINTE ‚Äî ${c.categorie||'-'}</h3><div class="detail-row"><span class="detail-label">DATE</span><span class="detail-value">${fmtDate(c.created_at)}</span></div><div class="detail-row"><span class="detail-label">PLAIGNANT</span><span class="detail-value">${c.plaignant_matricule||'-'}</span></div><div class="detail-row"><span class="detail-label">CIBLE</span><span class="detail-value">${c.cible_matricule||'-'}</span></div><div class="detail-row"><span class="detail-label">DATE INCIDENT</span><span class="detail-value">${fmtDate(c.date_incident)}</span></div><div class="detail-row"><span class="detail-label">LIEU</span><span class="detail-value">${c.lieu||'-'}</span></div><div class="detail-row"><span class="detail-label">DESCRIPTION</span><span class="detail-value">${c.description||'-'}</span></div>${c.temoins?`<div class="detail-row"><span class="detail-label">T√âMOINS</span><span class="detail-value">${c.temoins}</span></div>`:''}${c.preuves?`<div class="detail-row"><span class="detail-label">PREUVES</span><span class="detail-value">${c.preuves}</span></div>`:''}<div class="detail-row"><span class="detail-label">STATUT</span><span class="detail-value">${sc}</span></div>${actionsHtml}<button class="close-btn" onclick="this.closest('.report-detail-overlay').remove()">FERMER</button></div>`;
        document.body.appendChild(o); o.addEventListener('click',e=>{if(e.target===o)o.remove();});
      };
      window.updateComplaintStatus = async function(id, newStatus) {
        try {
          await updateComplaint(id, { statut: newStatus });
          const c = allComplaints.find(x=>x._id===id);
          if(c) c.statut = newStatus;
          document.querySelector('.report-detail-overlay')?.remove();
          renderComplaints();
        } catch(e) { alert('Erreur: ' + e.message); }
      };
      onAuthStateChanged(auth, async(user) => {
        if(!user){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
        try {
          const s = await getDoc(doc(db,'users',user.uid));
          if(!s.exists()||!s.data().approved){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
          const ud = s.data();
          let units = []; try { units = await loadUnits(); } catch(_){}
          const ui = units.find(x => x.matricule === ud.matricule);
          const rg = ui?(ui.rang||''):'';
          const isHG = rg === 'Ofc' || rg === 'Cmd';
          const userDiv = ui?(ui.division||''):'';
          if (userDiv !== DIVISION && !isHG) { document.getElementById('loading').style.display='none'; document.getElementById('access-denied').style.display='block'; return; }
          document.getElementById('loading').style.display='none';
          document.getElementById('mainContent').style.display='block';
          try { allReports = await loadReports(); } catch(_) { allReports = []; }
          try { allComplaints = await loadComplaints(); } catch(_) { allComplaints = []; }
          applyFilters();
        } catch(e) { console.error(e); document.getElementById('loading').style.display='none'; document.getElementById('access-denied').style.display='block'; }
      });
    </script>
</body>
</html>