<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewtime - MPF Documentation</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="assets/css/bundle.css">
    <style>
        /* Stats */
        .vt-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        .stat-box {
            background: rgba(0, 170, 255, 0.03);
            border: 1px solid rgba(0, 170, 255, 0.15);
            padding: 0.8rem;
            text-align: center;
            border-radius: 4px;
        }
        .stat-box .number {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            color: var(--accent-cyan);
            font-weight: 700;
        }
        .stat-box .label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-top: 0.2rem;
        }
        .stat-box.warn .number { color: #ffaa00; }
        .stat-box.danger .number { color: #ff4444; }

        /* Table */
        .vt-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }
        .vt-table th {
            text-align: left;
            padding: 0.55rem 0.5rem;
            color: var(--accent-cyan);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.2);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: color 0.15s;
        }
        .vt-table th:hover { color: #fff; }
        .vt-table th.sort-active {
            color: #fff;
            border-bottom-color: var(--accent-cyan);
        }
        .vt-table th .sort-arrow {
            display: inline-block;
            margin-left: 0.3rem;
            font-size: 0.6rem;
            opacity: 0.7;
        }
        .vt-table td {
            padding: 0.45rem 0.5rem;
            color: var(--text-primary);
            border-bottom: 1px solid rgba(0, 170, 255, 0.06);
            vertical-align: middle;
        }
        .vt-table tr:hover { background: rgba(0, 170, 255, 0.03); }
        .vt-table .matricule-cell {
            font-weight: 700;
            color: var(--accent-cyan);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
        }

        /* Hours display */
        .hours-cell {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            min-width: 200px;
        }
        .hours-ring {
            position: relative;
            width: 38px;
            height: 38px;
            flex-shrink: 0;
        }
        .hours-ring svg {
            width: 38px;
            height: 38px;
            transform: rotate(-90deg);
        }
        .hours-ring-bg {
            fill: none;
            stroke: rgba(0, 170, 255, 0.08);
            stroke-width: 3;
        }
        .hours-ring-fill {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.6s ease;
        }
        .hours-info {
            flex: 1;
            min-width: 0;
        }
        .hours-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.82rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .hours-value .h-num { font-size: 0.9rem; }
        .hours-value .h-unit { font-size: 0.68rem; opacity: 0.7; margin-right: 0.15rem; }
        .hours-bar-mini {
            height: 4px;
            background: rgba(0, 170, 255, 0.06);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.25rem;
            position: relative;
        }
        .hours-bar-mini-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        .hours-bar-mini .hours-threshold {
            position: absolute;
            top: -1px;
            bottom: -1px;
            width: 1.5px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 2;
        }
        .hours-epic { color: #bb44ff; }
        .hours-good { color: #00cc55; }
        .hours-low { color: #ffaa00; }
        .hours-danger { color: #ff4444; }
        .hours-pause { color: #00aaff; }

        /* Compliance badge */
        .compliance-ok {
            display: inline-block;
            padding: 0.08rem 0.35rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            background: rgba(0, 200, 80, 0.15);
            color: #00cc55;
            border: 1px solid rgba(0, 200, 80, 0.3);
        }
        .compliance-fail {
            display: inline-block;
            padding: 0.08rem 0.35rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            background: rgba(255, 40, 40, 0.2);
            color: #ff4444;
            border: 1px solid rgba(255, 40, 40, 0.4);
        }
        .compliance-exempt {
            display: inline-block;
            padding: 0.08rem 0.35rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            background: rgba(255, 170, 0, 0.15);
            color: #ffaa00;
            border: 1px solid rgba(255, 170, 0, 0.3);
        }

        /* Division badges */
        .div-badge {
            display: inline-block;
            padding: 0.12rem 0.45rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            font-weight: 700;
        }
        .div-HELIX { background: rgba(50, 205, 50, 0.15); color: #32cd32; border: 1px solid rgba(50, 205, 50, 0.3); }
        .div-APEX { background: rgba(0, 100, 200, 0.15); color: #0088dd; border: 1px solid rgba(0, 100, 200, 0.3); }
        .div-RAZOR { background: rgba(136, 136, 136, 0.15); color: #999999; border: 1px solid rgba(136, 136, 136, 0.3); }
        .div-MACE { background: rgba(0, 128, 128, 0.15); color: #00aaaa; border: 1px solid rgba(0, 128, 128, 0.3); }
        .div-ZONE { background: rgba(68, 136, 255, 0.15); color: #4488ff; border: 1px solid rgba(68, 136, 255, 0.3); }
        .div-DEFENDER { background: rgba(0, 150, 100, 0.15); color: #00bb77; border: 1px solid rgba(0, 150, 100, 0.3); }
        .div-JURY { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border: 1px solid rgba(231, 76, 60, 0.3); }
        .div-JUDGE { background: rgba(128, 0, 128, 0.15); color: #cc44cc; border: 1px solid rgba(128, 0, 128, 0.3); }
        .div-EXOGEN { background: rgba(0, 191, 165, 0.15); color: #00bfa5; border: 1px solid rgba(0, 191, 165, 0.3); }
        .div-HUNTER { background: rgba(0, 160, 40, 0.15); color: #00aa33; border: 1px solid rgba(0, 160, 40, 0.3); }
        .div-GRID { background: rgba(200, 200, 0, 0.15); color: #cccc00; border: 1px solid rgba(200, 200, 0, 0.3); }
        .div-HAMMER { background: rgba(220, 170, 0, 0.15); color: #ddaa00; border: 1px solid rgba(220, 170, 0, 0.3); }
        .div-SPECTRE { background: rgba(85, 85, 85, 0.15); color: #888888; border: 1px solid rgba(85, 85, 85, 0.3); }
        .div-GHOST { background: rgba(140, 140, 200, 0.15); color: #aaaadd; border: 1px solid rgba(140, 140, 200, 0.3); }
        .div-UNION { background: rgba(100, 100, 220, 0.15); color: #8888ee; border: 1px solid rgba(100, 100, 220, 0.3); }
        .div-NONE { background: rgba(60, 60, 60, 0.15); color: #666; border: 1px solid rgba(60, 60, 60, 0.3); }

        /* Rang badge */
        .rang-badge {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 2px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .rang-Cmd  { background: rgba(255, 215, 0, 0.2); color: #ffd700; border: 1px solid rgba(255, 215, 0, 0.4); }
        .rang-Ofc  { background: rgba(255, 180, 0, 0.2); color: #ffbb00; border: 1px solid rgba(255, 180, 0, 0.4); }
        .rang-DvL  { background: rgba(255, 40, 40, 0.2); color: #ff3333; border: 1px solid rgba(255, 40, 40, 0.4); }
        .rang-01   { background: rgba(255, 50, 50, 0.18); color: #ff4444; border: 1px solid rgba(255, 50, 50, 0.35); }
        .rang-02   { background: rgba(255, 140, 0, 0.18); color: #ff8800; border: 1px solid rgba(255, 140, 0, 0.35); }
        .rang-03   { background: rgba(200, 200, 0, 0.15); color: #bbbb00; border: 1px solid rgba(200, 200, 0, 0.3); }
        .rang-04   { background: rgba(0, 180, 120, 0.15); color: #00bb77; border: 1px solid rgba(0, 180, 120, 0.3); }
        .rang-05   { background: rgba(0, 140, 255, 0.15); color: #0099ff; border: 1px solid rgba(0, 140, 255, 0.3); }
        .rang-RCT  { background: rgba(128, 128, 128, 0.15); color: #999; border: 1px solid rgba(128, 128, 128, 0.3); }
        .rang-STB   { background: rgba(160, 0, 200, 0.15); color: #bb44dd; border: 1px solid rgba(160, 0, 200, 0.3); }
        .rang-STBE  { background: rgba(180, 0, 220, 0.18); color: #cc44ee; border: 1px solid rgba(180, 0, 220, 0.35); }
        .rang-CABAL { background: rgba(200, 0, 200, 0.2); color: #dd44dd; border: 1px solid rgba(200, 0, 200, 0.4); }
        .rang-MISSING { background: rgba(255, 0, 0, 0.25); color: #ff2222; border: 1px solid rgba(255, 0, 0, 0.5); }

        /* Status badges */
        .statut-badge {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .statut-absence {
            background: rgba(255, 140, 0, 0.2);
            color: #ffaa00;
            border: 1px solid rgba(255, 140, 0, 0.4);
        }
        .statut-pause {
            background: rgba(255, 40, 40, 0.2);
            color: #ff4444;
            border: 1px solid rgba(255, 40, 40, 0.4);
            animation: pulse-pause 1.5s ease-in-out infinite;
        }
        @keyframes pulse-pause { 0%,100% { opacity: 1; } 50% { opacity: 0.65; } }
        .statut-ok {
            color: rgba(100,100,100,0.4);
            font-size: 0.65rem;
        }

        .table-scroll { overflow-x: auto; }

        .week-banner {
            background: rgba(0, 170, 255, 0.06);
            border: 1px solid rgba(0, 170, 255, 0.2);
            border-radius: 4px;
            padding: 0.8rem 1.2rem;
            margin-bottom: 1.2rem;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.78rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .week-banner strong { color: var(--accent-cyan); }

        .filter-row {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-row input, .filter-row select {
            padding: 0.4rem 0.6rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.78rem;
            outline: none;
            border-radius: 2px;
        }
        .filter-row input:focus, .filter-row select:focus { border-color: var(--accent-cyan); }
        .filter-row input { flex: 1; min-width: 180px; }

        .no-data {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
            font-family: 'Share Tech Mono', monospace;
        }
        .no-data h3 {
            font-family: 'Orbitron', sans-serif;
            color: rgba(0, 170, 255, 0.5);
            margin-bottom: 0.5rem;
        }

        /* ======= BL√ÇMES ======= */
        .blame-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .blame-dot {
            position: relative;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.15s;
        }
        .blame-dot:hover {
            transform: scale(1.4);
            z-index: 10;
        }
        .blame-dot.viewtime {
            background: #ff4444;
            box-shadow: 0 0 6px rgba(255, 68, 68, 0.6);
        }
        .blame-dot.manual {
            background: #ffaa00;
            box-shadow: 0 0 6px rgba(255, 170, 0, 0.6);
        }
        .blame-dot.expired {
            background: #555;
            opacity: 0.4;
            box-shadow: none;
        }
        .blame-tooltip {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 10, 20, 0.95);
            border: 1px solid rgba(0, 170, 255, 0.3);
            color: var(--text-primary);
            padding: 0.4rem 0.6rem;
            border-radius: 3px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 2px 12px rgba(0,0,0,0.6);
        }
        .blame-dot:hover .blame-tooltip {
            display: block;
        }
        .blame-count-badge {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.72rem;
            font-weight: 700;
            padding: 0.1rem 0.35rem;
            border-radius: 2px;
            margin-left: 4px;
        }
        .blame-0 { color: rgba(100,100,100,0.4); }
        .blame-1 { color: #ffaa00; }
        .blame-2 { background: rgba(255,100,0,0.2); color: #ff6600; border: 1px solid rgba(255,100,0,0.4); }
        .blame-3 { background: rgba(255,40,40,0.25); color: #ff2222; border: 1px solid rgba(255,40,40,0.5); animation: pulse-pause 1.5s ease-in-out infinite; }

        .blame-add-btn {
            padding: 0.15rem 0.4rem;
            font-size: 0.65rem;
            font-family: 'Share Tech Mono', monospace;
            cursor: pointer;
            border: 1px solid rgba(255, 140, 0, 0.3);
            background: rgba(255, 140, 0, 0.08);
            color: #ff8800;
            border-radius: 2px;
            transition: all 0.15s;
            margin-left: 4px;
        }
        .blame-add-btn:hover { background: rgba(255, 140, 0, 0.2); }
        .blame-del-btn {
            font-size: 0.55rem;
            cursor: pointer;
            color: #ff4444;
            margin-left: 2px;
            opacity: 0.6;
            transition: opacity 0.15s;
        }
        .blame-del-btn:hover { opacity: 1; }

        /* Admin weekly banner */
        .weekly-check-banner {
            background: rgba(255, 140, 0, 0.08);
            border: 1px solid rgba(255, 140, 0, 0.3);
            border-radius: 4px;
            padding: 0.8rem 1.2rem;
            margin-bottom: 1rem;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.78rem;
            color: #ffaa00;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.8rem;
            flex-wrap: wrap;
        }
        .weekly-check-banner .btn-action {
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            border-color: rgba(255, 140, 0, 0.5);
            background: rgba(255, 140, 0, 0.15);
            color: #ffaa00;
        }
        .weekly-check-banner .btn-action:hover {
            background: rgba(255, 140, 0, 0.3);
        }

        /* Blame modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 500;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: var(--bg-secondary, #0a0a14);
            border: 1px solid rgba(0, 170, 255, 0.3);
            border-radius: 4px;
            padding: 1.5rem;
            width: 95%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.7);
        }
        .modal h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.95rem;
            color: var(--accent-cyan);
            margin-bottom: 1rem;
            letter-spacing: 1px;
        }
        .modal label {
            display: block;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.72rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-top: 0.7rem;
            margin-bottom: 0.2rem;
        }
        .modal input, .modal textarea {
            width: 100%;
            padding: 0.45rem 0.6rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.82rem;
            outline: none;
            border-radius: 2px;
        }
        .modal input:focus, .modal textarea:focus { border-color: var(--accent-cyan); }
        .modal-actions {
            display: flex;
            gap: 0.6rem;
            margin-top: 1.2rem;
            justify-content: flex-end;
        }
        .btn-action {
            padding: 0.5rem 1.2rem;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid rgba(0, 170, 255, 0.4);
            background: rgba(0, 170, 255, 0.1);
            color: var(--accent-cyan);
            border-radius: 3px;
            transition: all 0.15s;
            letter-spacing: 0.5px;
        }
        .btn-action:hover { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); }
        .btn-action.primary { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); font-weight: 700; }
        .btn-action.primary:hover { background: rgba(0, 170, 255, 0.35); }
        .btn-action.warning { border-color: rgba(255,140,0,0.5); background: rgba(255,140,0,0.15); color: #ff8800; }
        .btn-action.warning:hover { background: rgba(255,140,0,0.3); }

        /* Blame list in modal */
        .blame-list-modal {
            margin-top: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .blame-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid rgba(0,170,255,0.06);
            font-size: 0.75rem;
            font-family: 'Share Tech Mono', monospace;
        }
        .blame-list-item .blame-info {
            flex: 1;
        }
        .blame-list-item .blame-reason {
            color: var(--text-primary);
        }
        .blame-list-item .blame-meta {
            color: var(--text-muted);
            font-size: 0.65rem;
        }
        .blame-list-item .blame-type-tag {
            font-size: 0.6rem;
            padding: 0.05rem 0.25rem;
            border-radius: 2px;
            font-weight: 700;
            margin-right: 4px;
        }
        .blame-type-viewtime {
            background: rgba(255,68,68,0.15);
            color: #ff4444;
            border: 1px solid rgba(255,68,68,0.3);
        }
        .blame-type-manual {
            background: rgba(255,170,0,0.15);
            color: #ffaa00;
            border: 1px solid rgba(255,170,0,0.3);
        }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>

    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">Viewtime ‚Äî Heures de Jeu</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT DES DONN√âES...</p>
            </div>

            <div id="mainContent" style="display:none;margin-top:1.5rem;">
                <!-- Week banner -->
                <div class="week-banner">
                    <div>Donn√©es de la semaine : <strong id="weekLabel">‚Äî</strong></div>
                    <div style="color:#ffaa00;">‚ö† Minimum requis : <strong>5h / semaine</strong></div>
                    <div>Derni√®re mise √† jour : <strong id="importDate">‚Äî</strong></div>
                </div>

                <!-- Weekly blame check banner (admin/HG only, hidden by default) -->
                <div id="weeklyCheckBanner" class="weekly-check-banner" style="display:none;">
                    <div>
                        ‚ö† <strong>V√âRIFICATION HEBDOMADAIRE</strong> ‚Äî Appliquer les bl√¢mes viewtime pour les unit√©s en d√©faut (<5h)
                        <br><span id="weeklyCheckInfo" style="font-size:0.68rem;color:var(--text-muted);"></span>
                    </div>
                    <button class="btn-action warning" id="btnWeeklyCheck" onclick="runWeeklyBlameCheck()">‚ö° APPLIQUER BL√ÇMES</button>
                </div>

                <!-- Stats -->
                <div class="vt-stats">
                    <div class="stat-box">
                        <div class="number" id="statUnits">0</div>
                        <div class="label">UNIT√âS ACTIVES</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statAvg">0h</div>
                        <div class="label">MOYENNE</div>
                    </div>
                    <div class="stat-box danger">
                        <div class="number" id="statDefaut">0</div>
                        <div class="label">EN D√âFAUT (&lt;5H)</div>
                    </div>
                    <div class="stat-box warn">
                        <div class="number" id="statAbsent">0</div>
                        <div class="label">ABSENCES</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="statPause">0</div>
                        <div class="label">EN PAUSE</div>
                    </div>
                    <div class="stat-box warn">
                        <div class="number" id="statBlames">0</div>
                        <div class="label">BL√ÇMES ACTIFS</div>
                    </div>
                </div>

                <!-- Table -->
                <div class="combine-terminal-wrapper">
                    <div class="combine-header">
                        <h2>REGISTRE VIEWTIME</h2>
                        <span class="header-code" id="vtCount">‚Äî</span>
                    </div>
                    <div class="combine-body">
                        <div class="filter-row">
                            <input type="text" id="searchInput" placeholder="Rechercher matricule, nom..." autocomplete="off">
                            <select id="complianceFilter">
                                <option value="">Tous statuts VT</option>
                                <option value="ok">‚úì Conforme (‚â•5h)</option>
                                <option value="fail">‚úó En d√©faut (&lt;5h)</option>
                                <option value="exempt">Exempt√©s (absence/pause)</option>
                            </select>
                            <select id="divisionFilter">
                                <option value="">Toutes divisions</option>
                                <optgroup label="‚îÄ Helix / Apex ‚îÄ">
                                    <option value="HELIX">HELIX</option>
                                    <option value="APEX">APEX</option>
                                </optgroup>
                                <optgroup label="‚îÄ Razor / Mace ‚îÄ">
                                    <option value="RAZOR">RAZOR</option>
                                    <option value="MACE">MACE</option>
                                </optgroup>
                                <optgroup label="‚îÄ Zone / Defender ‚îÄ">
                                    <option value="ZONE">ZONE</option>
                                    <option value="DEFENDER">DEFENDER</option>
                                </optgroup>
                                <optgroup label="‚îÄ Jury / Judge ‚îÄ">
                                    <option value="JURY">JURY</option>
                                    <option value="JUDGE">JUDGE</option>
                                </optgroup>
                                <optgroup label="‚îÄ Exogen / Hunter ‚îÄ">
                                    <option value="EXOGEN">EXOGEN</option>
                                    <option value="HUNTER">HUNTER</option>
                                </optgroup>
                                <optgroup label="‚îÄ Grid / Hammer ‚îÄ">
                                    <option value="GRID">GRID</option>
                                    <option value="HAMMER">HAMMER</option>
                                </optgroup>
                                <optgroup label="‚îÄ Spectre / Ghost ‚îÄ">
                                    <option value="SPECTRE">SPECTRE</option>
                                    <option value="GHOST">GHOST</option>
                                </optgroup>
                                <optgroup label="‚îÄ Autres ‚îÄ">
                                    <option value="UNION">UNION</option>
                                    <option value="N/A">N/A</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="table-scroll">
                            <table class="vt-table">
                                <thead>
                                    <tr>
                                        <th data-sort="matricule" onclick="sortBy('matricule')">MATRICULE</th>
                                        <th data-sort="nom_steam" onclick="sortBy('nom_steam')">NOM STEAM</th>
                                        <th data-sort="division" onclick="sortBy('division')">DIVISION</th>
                                        <th data-sort="rang" onclick="sortBy('rang')">RANG</th>
                                        <th data-sort="hours" onclick="sortBy('hours')">HEURES (MIN 5H)</th>
                                        <th data-sort="blames" onclick="sortBy('blames')">BL√ÇMES</th>
                                        <th>CONFORMIT√â</th>
                                        <th>STATUT</th>
                                    </tr>
                                </thead>
                                <tbody id="vtBody">
                                    <tr><td colspan="8" style="text-align:center;color:var(--text-muted);">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="noData" class="no-data" style="display:none;">
                <h3>AUCUNE DONN√âE DISPONIBLE</h3>
                <p>Aucun viewtime n'a encore √©t√© import√©.</p>
                <a href="index.html" style="color:var(--accent-cyan);font-size:0.85rem;">‚Üê Retour √† l'accueil</a>
            </div>
        </div>
    </main>

    <!-- Modal: Bl√¢mes d'une unit√© -->
    <div id="blameModal" class="modal-overlay">
        <div class="modal">
            <h3 id="blameModalTitle">BL√ÇMES ‚Äî ???</h3>
            <div id="blameListModal" class="blame-list-modal">
                <p style="color:var(--text-muted);font-size:0.75rem;">Aucun bl√¢me</p>
            </div>
            <hr style="border:none;border-top:1px solid rgba(0,170,255,0.1);margin:0.8rem 0;">
            <div id="blameAddSection" style="display:none;">
                <label>RAISON DU BL√ÇME</label>
                <textarea id="blameReason" rows="2" placeholder="Raison du bl√¢me..." style="resize:vertical;"></textarea>
                <div class="modal-actions" style="margin-top:0.6rem;">
                    <button class="btn-action warning" onclick="addManualBlame()">+ AJOUTER BL√ÇME</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-action" onclick="closeBlameModal()">FERMER</button>
            </div>
        </div>
    </div>

    <script type="module" src="assets/js/auth.js"></script>
    <script src="assets/js/global-nav.js?v=20260214" defer></script>
    <script src="assets/js/interactive-system.js" defer></script>
    <script src="assets/js/combine-animations.js" defer></script>

    <script type="module">
      import { auth, db } from './assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        loadUnits, loadPlaytimeHistory, loadAbsences, readJsonFile,
        loadBlames, addBlame, deleteBlame, loadBlameConfig, saveBlameConfig
      } from './assets/js/github-data.js';

      // ========== STATE ==========
      let viewData = []; // merged: unit info + hours + absence status
      let allBlames = []; // all blame documents
      let currentSort = { key: 'hours', asc: false };
      let isHG = false; // is current user admin or HG
      let currentUserMatricule = '';
      let blameModalMatricule = '';

      // ========== UTILS ==========
      function getWeekMonday(d) {
        const date = new Date(d);
        const day = date.getDay();
        const diff = day === 0 ? -6 : 1 - day;
        date.setDate(date.getDate() + diff);
        date.setHours(0, 0, 0, 0);
        return date;
      }
      function getWeekSunday(d) {
        const mon = getWeekMonday(d);
        const sun = new Date(mon);
        sun.setDate(sun.getDate() + 6);
        sun.setHours(23, 59, 59, 999);
        return sun;
      }
      function daysInWeek(debut, fin, weekStart, weekEnd) {
        const s = new Date(debut), e = new Date(fin);
        const oS = s > weekStart ? s : weekStart;
        const oE = e < weekEnd ? e : weekEnd;
        if (oS > oE) return 0;
        return Math.ceil((oE - oS) / 86400000) + 1;
      }

      function divBadge(div) {
        if (!div) return '<span class="div-badge div-NONE">‚Äî</span>';
        return `<span class="div-badge div-${div}">${div}</span>`;
      }
      function rangClass(rang) {
        if (!rang) return '';
        return 'rang-' + rang.replace('.', '');
      }

      const MIN_HOURS = 5;
      const BLAME_EXPIRY_DAYS = 30;

      function formatHours(h) {
        const hrs = Math.floor(h);
        const mins = Math.round((h - hrs) * 60);
        if (hrs === 0 && mins === 0) return '<span class="h-num">0</span><span class="h-unit">h</span>';
        let out = '';
        if (hrs > 0) out += `<span class="h-num">${hrs}</span><span class="h-unit">h</span>`;
        if (mins > 0) out += ` <span class="h-num">${mins}</span><span class="h-unit">min</span>`;
        return out;
      }
      function formatHoursText(h) {
        const hrs = Math.floor(h);
        const mins = Math.round((h - hrs) * 60);
        if (hrs === 0 && mins === 0) return '0h';
        let out = '';
        if (hrs > 0) out += hrs + 'h';
        if (mins > 0) out += (hrs > 0 ? ' ' : '') + mins + 'min';
        return out;
      }
      function hoursColor(h, absStatus) {
        if (absStatus === 'pause') return 'hours-pause';
        if (h >= 15) return 'hours-epic';
        if (h >= MIN_HOURS) return 'hours-good';
        if (h >= 3) return 'hours-low';
        return 'hours-danger';
      }
      function hoursBarColor(h, absStatus) {
        if (absStatus === 'pause') return '#00aaff';
        if (h >= 15) return '#bb44ff';
        if (h >= MIN_HOURS) return '#00cc55';
        if (h >= 3) return '#ffaa00';
        return '#ff4444';
      }

      function complianceBadge(v) {
        if (v.absStatus === 'pause') return '<span class="compliance-exempt">EXEMPT</span>';
        if (v.absStatus === 'absence') return '<span class="compliance-exempt">EXEMPT</span>';
        if (v.rang === 'MISSING') return '<span style="color:rgba(100,100,100,0.4);font-size:0.65rem;">‚Äî</span>';
        if (v.hours >= MIN_HOURS) return '<span class="compliance-ok">CONFORME</span>';
        return '<span class="compliance-fail">D√âFAUT</span>';
      }

      function getComplianceStatus(v) {
        if (v.absStatus === 'pause' || v.absStatus === 'absence') return 'exempt';
        if (v.rang === 'MISSING') return 'exempt';
        return v.hours >= MIN_HOURS ? 'ok' : 'fail';
      }

      function getAbsenceStatus(matricule, absences) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const ws = getWeekMonday(today);
        const we = getWeekSunday(today);
        for (const abs of absences) {
          if (abs.matricule !== matricule) continue;
          const debut = new Date(abs.debut);
          const fin = new Date(abs.fin);
          debut.setHours(0, 0, 0, 0);
          fin.setHours(23, 59, 59, 999);
          if (today >= debut && today <= fin) {
            const dw = daysInWeek(abs.debut, abs.fin, ws, we);
            return dw >= 3 ? 'pause' : 'absence';
          }
        }
        return null;
      }

      function statutBadge(status) {
        if (status === 'pause') return '<span class="statut-badge statut-pause">PAUSE</span>';
        if (status === 'absence') return '<span class="statut-badge statut-absence">ABSENCE</span>';
        return '<span class="statut-ok">‚Äî</span>';
      }

      // ========== BLAME HELPERS ==========
      /** Get active (non-expired) blames for a given matricule */
      function getActiveBlames(matricule) {
        const now = new Date();
        return allBlames.filter(b => {
          if (b.matricule !== matricule) return false;
          if (b.expires_at) {
            const exp = new Date(b.expires_at);
            if (exp < now) return false;
          }
          return true;
        });
      }

      /** Render blame dots HTML for a unit */
      function blameCellHTML(matricule) {
        const active = getActiveBlames(matricule);
        const count = active.length;

        let dots = '';
        active.forEach(b => {
          const typeClass = b.type === 'viewtime' ? 'viewtime' : 'manual';
          const reason = (b.raison || 'Aucune raison').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          const dateStr = b.created_at ? new Date(b.created_at).toLocaleDateString('fr-FR') : '?';
          const expStr = b.expires_at ? new Date(b.expires_at).toLocaleDateString('fr-FR') : '?';
          const delBtn = isHG ? `<span class="blame-del-btn" onclick="event.stopPropagation();removeBlame('${b._id}')" title="Supprimer">‚úó</span>` : '';
          dots += `<span class="blame-dot ${typeClass}" onclick="event.stopPropagation();openBlameModal('${matricule}')">
            <span class="blame-tooltip">${b.type === 'viewtime' ? '‚è± VIEWTIME' : 'üìù MANUEL'} ‚Äî ${reason}<br>üìÖ ${dateStr} ‚Üí expire ${expStr}</span>
          </span>${delBtn}`;
        });

        // Badge count + color
        let badge = '';
        if (count === 0) {
          badge = '<span class="blame-count-badge blame-0">0</span>';
        } else if (count === 1) {
          badge = `<span class="blame-count-badge blame-1">${count}</span>`;
        } else if (count === 2) {
          badge = `<span class="blame-count-badge blame-2">${count} ‚ö† R√âTRO</span>`;
        } else {
          badge = `<span class="blame-count-badge blame-3">${count} ‚õî EXCLU</span>`;
        }

        const addBtn = isHG ? `<button class="blame-add-btn" onclick="event.stopPropagation();openBlameModal('${matricule}')" title="G√©rer bl√¢mes">+</button>` : '';

        return `<div class="blame-dots">${dots}${badge}${addBtn}</div>`;
      }

      // ========== BLAME MODAL ==========
      window.openBlameModal = function(matricule) {
        blameModalMatricule = matricule;
        const v = viewData.find(u => u.matricule === matricule);
        document.getElementById('blameModalTitle').textContent = `BL√ÇMES ‚Äî ${matricule} ${v ? '(' + v.nom_steam + ')' : ''}`;

        // Show add section only for HG
        document.getElementById('blameAddSection').style.display = isHG ? 'block' : 'none';
        document.getElementById('blameReason').value = '';

        // List blames
        renderBlameList(matricule);
        document.getElementById('blameModal').classList.add('visible');
      };

      function renderBlameList(matricule) {
        const now = new Date();
        const blames = allBlames.filter(b => b.matricule === matricule).sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
        const container = document.getElementById('blameListModal');

        if (blames.length === 0) {
          container.innerHTML = '<p style="color:var(--text-muted);font-size:0.75rem;text-align:center;">Aucun bl√¢me pour cette unit√©</p>';
          return;
        }

        container.innerHTML = blames.map(b => {
          const isExpired = b.expires_at && new Date(b.expires_at) < now;
          const typeTag = b.type === 'viewtime'
            ? '<span class="blame-type-tag blame-type-viewtime">VIEWTIME</span>'
            : '<span class="blame-type-tag blame-type-manual">MANUEL</span>';
          const dateStr = b.created_at ? new Date(b.created_at).toLocaleDateString('fr-FR') : '?';
          const expStr = b.expires_at ? new Date(b.expires_at).toLocaleDateString('fr-FR') : '?';
          const delBtn = isHG ? `<button class="blame-add-btn" style="border-color:rgba(255,60,60,0.3);color:#ff4444;background:rgba(255,60,60,0.08);" onclick="removeBlame('${b._id}')">‚úó Suppr.</button>` : '';
          return `<div class="blame-list-item" style="${isExpired ? 'opacity:0.4;' : ''}">
            <div class="blame-info">
              ${typeTag}<span class="blame-reason">${b.raison || '-'}</span>
              <div class="blame-meta">${dateStr} ‚Üí expire ${expStr}${isExpired ? ' (EXPIR√â)' : ''} ${b.created_by ? '‚Äî par ' + b.created_by : ''}</div>
            </div>
            ${delBtn}
          </div>`;
        }).join('');
      }

      window.closeBlameModal = function() {
        document.getElementById('blameModal').classList.remove('visible');
      };
      document.getElementById('blameModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('blameModal')) closeBlameModal();
      });

      window.addManualBlame = async function() {
        const reason = document.getElementById('blameReason').value.trim();
        if (!reason) { alert('Veuillez entrer une raison.'); return; }
        if (!blameModalMatricule) return;

        const now = new Date();
        const expiresAt = new Date(now);
        expiresAt.setDate(expiresAt.getDate() + BLAME_EXPIRY_DAYS);

        const blame = {
          matricule: blameModalMatricule,
          raison: reason,
          type: 'manual',
          created_at: now.toISOString(),
          expires_at: expiresAt.toISOString(),
          created_by: currentUserMatricule || 'HG'
        };

        try {
          const saved = await addBlame(blame);
          allBlames.push(saved);
          renderBlameList(blameModalMatricule);
          renderTable();
          updateBlameStats();
          document.getElementById('blameReason').value = '';
        } catch (err) {
          alert('Erreur: ' + err.message);
        }
      };

      window.removeBlame = async function(docId) {
        if (!confirm('Supprimer ce bl√¢me ?')) return;
        try {
          await deleteBlame(docId);
          allBlames = allBlames.filter(b => b._id !== docId);
          if (blameModalMatricule) renderBlameList(blameModalMatricule);
          renderTable();
          updateBlameStats();
        } catch (err) {
          alert('Erreur suppression: ' + err.message);
        }
      };

      function updateBlameStats() {
        const now = new Date();
        const totalActive = allBlames.filter(b => !b.expires_at || new Date(b.expires_at) >= now).length;
        document.getElementById('statBlames').textContent = totalActive;
      }

      // ========== WEEKLY AUTO-CHECK ==========
      window.runWeeklyBlameCheck = async function() {
        if (!isHG) return;
        const btn = document.getElementById('btnWeeklyCheck');
        btn.disabled = true;
        btn.textContent = '‚ü≥ EN COURS...';

        try {
          const now = new Date();
          const expiresAt = new Date(now);
          expiresAt.setDate(expiresAt.getDate() + BLAME_EXPIRY_DAYS);

          let added = 0;
          for (const v of viewData) {
            // Skip exempt units
            if (getComplianceStatus(v) !== 'fail') continue;

            const blame = {
              matricule: v.matricule,
              raison: `Viewtime insuffisant : ${formatHoursText(v.hours)} (minimum ${MIN_HOURS}h)`,
              type: 'viewtime',
              created_at: now.toISOString(),
              expires_at: expiresAt.toISOString(),
              created_by: currentUserMatricule || 'AUTO',
              week_label: document.getElementById('weekLabel').textContent
            };

            const saved = await addBlame(blame);
            allBlames.push(saved);
            added++;
          }

          // Save check timestamp
          const weekMondayStr = getWeekMonday(now).toISOString().substring(0, 10);
          await saveBlameConfig({ last_weekly_check: weekMondayStr });

          btn.textContent = `‚úì ${added} BL√ÇMES APPLIQU√âS`;
          btn.style.borderColor = 'rgba(0,200,80,0.5)';
          btn.style.color = '#00cc55';
          renderTable();
          updateBlameStats();

          setTimeout(() => {
            document.getElementById('weeklyCheckBanner').style.display = 'none';
          }, 3000);
        } catch (err) {
          btn.textContent = '‚ö† ERREUR: ' + err.message;
          btn.disabled = false;
        }
      };

      // ========== CHECK AUTH FOR HG ==========
      async function checkIsHG(user) {
        if (!user) return false;
        try {
          const snap = await getDoc(doc(db, 'users', user.uid));
          if (!snap.exists()) return false;
          const data = snap.data();
          currentUserMatricule = data.matricule || '';
          return data.is_admin === true || data.is_hg === true;
        } catch (_) {
          return false;
        }
      }

      // ========== LOAD DATA ==========
      async function init() {
        try {
          // Auth check first
          const user = auth.currentUser;
          isHG = await checkIsHG(user);

          const [units, history, absences, blames] = await Promise.all([
            loadUnits(), loadPlaytimeHistory(), loadAbsences(), loadBlames()
          ]);

          allBlames = blames;

          if (!history || history.length === 0) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('noData').style.display = 'block';
            return;
          }

          const latestImport = history[0];
          const importDate = latestImport.import_date || '';
          const importEntries = latestImport.entries || [];

          const hoursMap = {};
          importEntries.forEach(e => {
            if (e.steamid64) hoursMap[e.steamid64] = parseFloat(e.heures) || 0;
          });

          const hoursByNom = {};
          importEntries.forEach(e => {
            if (e.nom) hoursByNom[e.nom.toLowerCase()] = parseFloat(e.heures) || 0;
          });

          const hautGrades = ['Ofc', 'Cmd'];
          viewData = units
            .filter(u => !hautGrades.includes(u.rang))
            .map(u => {
            let hours = 0;
            if (u.steamid64 && hoursMap[u.steamid64] !== undefined) {
              hours = hoursMap[u.steamid64];
            } else if (u.nom_steam && hoursByNom[u.nom_steam.toLowerCase()] !== undefined) {
              hours = hoursByNom[u.nom_steam.toLowerCase()];
            }
            const absStatus = getAbsenceStatus(u.matricule, absences);
            return {
              matricule: u.matricule,
              nom_steam: u.nom_steam || '',
              division: u.division || '',
              rang: u.rang || '',
              hours,
              absStatus
            };
          });

          // Week label
          const impD = new Date(importDate);
          const weekMon = getWeekMonday(impD);
          const weekSun = getWeekSunday(impD);
          const fmt = d => d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
          document.getElementById('weekLabel').textContent = `${fmt(weekMon)} ‚Üí ${fmt(weekSun)}`;
          document.getElementById('importDate').textContent = importDate;

          // Stats
          const activeUnits = viewData.filter(v => v.rang !== 'MISSING');
          const totalHours = activeUnits.reduce((s, v) => s + v.hours, 0);
          const avg = activeUnits.length ? (totalHours / activeUnits.length).toFixed(1) : 0;
          const absCount = viewData.filter(v => v.absStatus === 'absence').length;
          const pauseCount = viewData.filter(v => v.absStatus === 'pause').length;
          const defautCount = viewData.filter(v => getComplianceStatus(v) === 'fail').length;

          document.getElementById('statUnits').textContent = activeUnits.length;
          document.getElementById('statAvg').textContent = formatHoursText(parseFloat(avg));
          document.getElementById('statDefaut').textContent = defautCount;
          document.getElementById('statAbsent').textContent = absCount;
          document.getElementById('statPause').textContent = pauseCount;
          updateBlameStats();

          // Show weekly check banner if HG and not already checked this week
          if (isHG) {
            try {
              const blameConfig = await loadBlameConfig();
              const lastCheck = blameConfig.last_weekly_check || '';
              const thisWeekMonday = getWeekMonday(new Date()).toISOString().substring(0, 10);
              if (lastCheck !== thisWeekMonday && defautCount > 0) {
                const banner = document.getElementById('weeklyCheckBanner');
                banner.style.display = 'flex';
                document.getElementById('weeklyCheckInfo').textContent =
                  `${defautCount} unit√©(s) en d√©faut. Derni√®re v√©rification : ${lastCheck || 'jamais'}`;
              }
            } catch (_) {}
          }

          document.getElementById('loading').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          renderTable();
          updateSortHeaders();
        } catch (err) {
          console.error('Erreur chargement viewtime:', err);
          document.getElementById('loading').innerHTML = `<p style="color:#ff4444;font-family:'Share Tech Mono',monospace;">ERREUR: ${err.message}</p>`;
        }
      }

      function renderTable() {
        const search = (document.getElementById('searchInput').value || '').toLowerCase();
        const divFilter = document.getElementById('divisionFilter').value;
        const compFilter = document.getElementById('complianceFilter').value;

        let filtered = viewData.filter(v => {
          const matchSearch = !search ||
            (v.matricule || '').toLowerCase().includes(search) ||
            (v.nom_steam || '').toLowerCase().includes(search);
          const matchDiv = !divFilter || v.division === divFilter;
          const matchComp = !compFilter || getComplianceStatus(v) === compFilter;
          return matchSearch && matchDiv && matchComp;
        });

        // Sort
        const rangOrder = { 'DvL': 0, '.01': 1, '.02': 2, '.03': 3, '.04': 4, '.05': 5, 'RCT': 6, 'CABAL': 7, 'STBE': 8, 'STB': 9, 'MISSING': 99 };
        filtered.sort((a, b) => {
          const key = currentSort.key;

          let va, vb;
          if (key === 'hours') {
            va = a.hours;
            vb = b.hours;
          } else if (key === 'blames') {
            va = getActiveBlames(a.matricule).length;
            vb = getActiveBlames(b.matricule).length;
          } else if (key === 'rang') {
            va = rangOrder[a.rang] ?? 50;
            vb = rangOrder[b.rang] ?? 50;
          } else if (key === 'matricule') {
            va = (a.matricule || '').padStart(4, '0');
            vb = (b.matricule || '').padStart(4, '0');
          } else {
            va = (a[key] || '').toLowerCase();
            vb = (b[key] || '').toLowerCase();
          }

          let cmp = va > vb ? 1 : va < vb ? -1 : 0;
          if (!currentSort.asc) cmp = -cmp;
          if (cmp !== 0) return cmp;

          const ra = rangOrder[a.rang] ?? 50;
          const rb = rangOrder[b.rang] ?? 50;
          if (ra !== rb) return ra - rb;
          return (a.matricule || '').localeCompare(b.matricule || '');
        });

        document.getElementById('vtCount').textContent = `${filtered.length} UNIT√âS`;

        const tbody = document.getElementById('vtBody');
        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);">Aucune donn√©e</td></tr>';
          return;
        }

        const maxH = Math.max(...filtered.map(v => v.hours), MIN_HOURS);
        const thresholdPct = (MIN_HOURS / maxH) * 100;

        tbody.innerHTML = filtered.map(v => {
          const pct = Math.min(100, (v.hours / maxH) * 100);
          const hColor = hoursColor(v.hours, v.absStatus);
          const barColor = hoursBarColor(v.hours, v.absStatus);
          const circ = 2 * Math.PI * 15;
          const ringPct = Math.min(1, v.hours / MIN_HOURS);
          const offset = circ * (1 - ringPct);
          return `<tr>
            <td class="matricule-cell">${v.matricule || '-'}</td>
            <td>${v.nom_steam || '<span style="color:var(--text-muted);">-</span>'}</td>
            <td>${divBadge(v.division)}</td>
            <td><span class="rang-badge ${rangClass(v.rang)}">${v.rang || '-'}</span></td>
            <td>
              <div class="hours-cell">
                <div class="hours-ring">
                  <svg viewBox="0 0 38 38">
                    <circle class="hours-ring-bg" cx="19" cy="19" r="15"/>
                    <circle class="hours-ring-fill" cx="19" cy="19" r="15"
                      stroke="${barColor}"
                      stroke-dasharray="${circ.toFixed(1)}"
                      stroke-dashoffset="${offset.toFixed(1)}"
                      style="filter:drop-shadow(0 0 3px ${barColor});"/>
                  </svg>
                </div>
                <div class="hours-info">
                  <div class="hours-value ${hColor}">${formatHours(v.hours)}</div>
                  <div class="hours-bar-mini">
                    <div class="hours-bar-mini-fill" style="width:${pct}%;background:${barColor};"></div>
                    <div class="hours-threshold" style="left:${thresholdPct}%;" title="Minimum 5h"></div>
                  </div>
                </div>
              </div>
            </td>
            <td>${blameCellHTML(v.matricule)}</td>
            <td>${complianceBadge(v)}</td>
            <td>${statutBadge(v.absStatus)}</td>
          </tr>`;
        }).join('');
      }

      // ========== SORT ==========
      function updateSortHeaders() {
        document.querySelectorAll('.vt-table th[data-sort]').forEach(th => {
          const key = th.dataset.sort;
          const arrow = th.querySelector('.sort-arrow');
          if (arrow) arrow.remove();
          th.classList.remove('sort-active');
          if (key === currentSort.key) {
            th.classList.add('sort-active');
            const arrowEl = document.createElement('span');
            arrowEl.className = 'sort-arrow';
            arrowEl.textContent = currentSort.asc ? '‚ñ≤' : '‚ñº';
            th.appendChild(arrowEl);
          }
        });
      }

      window.sortBy = function(key) {
        if (currentSort.key === key) {
          currentSort.asc = !currentSort.asc;
        } else {
          currentSort = { key, asc: key === 'hours' || key === 'blames' ? false : true };
        }
        updateSortHeaders();
        renderTable();
      };

      // ========== FILTERS ==========
      document.getElementById('searchInput').addEventListener('input', renderTable);
      document.getElementById('divisionFilter').addEventListener('change', renderTable);
      document.getElementById('complianceFilter').addEventListener('change', renderTable);

      // ========== AUTH THEN INIT ==========
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          isHG = await checkIsHG(user);
        }
        init();
      });
    </script>
</body>
</html>
