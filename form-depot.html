<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©p√¥t d'Argent - MPF</title>
    <link rel="stylesheet" href="assets/css/main-style.css">
    <link rel="stylesheet" href="assets/css/combine-terminals.css">
    <link rel="stylesheet" href="assets/css/global-nav.css">
    <link rel="stylesheet" href="assets/css/interactive-system.css">
    <link rel="stylesheet" href="assets/css/combine-animations.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        .depot-wrapper { max-width: 600px; margin: 0 auto; }

        .user-info-bar {
            display: flex; align-items: center; gap: 1rem;
            padding: 0.8rem 1rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.15);
            border-radius: 4px; margin-bottom: 1.5rem;
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
        }
        .user-info-bar .user-avatar {
            width: 42px; height: 42px;
            background: rgba(0, 170, 255, 0.15);
            border: 1px solid var(--accent-cyan); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron', sans-serif; font-size: 0.85rem;
            color: var(--accent-cyan); font-weight: 700; flex-shrink: 0;
        }
        .user-info-bar .user-details { flex: 1; }
        .user-info-bar .user-matricule {
            font-family: 'Orbitron', sans-serif; font-size: 0.82rem;
            color: var(--accent-cyan); font-weight: 700;
        }
        .user-info-bar .user-status {
            font-size: 0.68rem; padding: 0.15rem 0.5rem; border-radius: 2px;
            background: rgba(0, 200, 80, 0.1); border: 1px solid rgba(0, 200, 80, 0.3); color: #00cc55;
        }

        .form-group { margin-bottom: 1.2rem; }
        .form-group label {
            display: block; font-family: 'Share Tech Mono', monospace;
            font-size: 0.72rem; color: var(--text-muted);
            letter-spacing: 1px; margin-bottom: 0.3rem;
        }
        .form-group label .req { color: #ff4444; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 0.5rem 0.7rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace; font-size: 0.82rem;
            outline: none; border-radius: 2px;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--accent-cyan);
        }
        .form-group select { cursor: pointer; }
        .form-group select option { background: #0a1628; color: var(--text-primary); }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .form-group .hint {
            font-size: 0.68rem; color: var(--text-muted); margin-top: 0.2rem;
            font-family: 'Share Tech Mono', monospace;
        }
        .form-group.error input, .form-group.error textarea, .form-group.error select { border-color: #ff4444; }
        .form-group .error-msg {
            font-size: 0.7rem; color: #ff4444; margin-top: 0.2rem;
            font-family: 'Share Tech Mono', monospace; display: none;
        }
        .form-group.error .error-msg { display: block; }

        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (max-width: 500px) { .row-2 { grid-template-columns: 1fr; } }

        .form-actions {
            display: flex; gap: 0.8rem; margin-top: 1.5rem; justify-content: flex-end;
        }
        .btn-action {
            padding: 0.5rem 1.2rem; font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem; cursor: pointer;
            border: 1px solid rgba(0, 170, 255, 0.4);
            background: rgba(0, 170, 255, 0.1); color: var(--accent-cyan);
            border-radius: 3px; transition: all 0.15s; letter-spacing: 0.5px;
        }
        .btn-action:hover { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); }
        .btn-action.primary { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); font-weight: 700; }
        .btn-action.primary:hover { background: rgba(0, 170, 255, 0.35); }
        .btn-action:disabled { opacity: 0.4; cursor: not-allowed; }

        .alert-msg {
            padding: 0.6rem 1rem; border-radius: 3px; margin-bottom: 1rem;
            font-size: 0.8rem; font-family: 'Share Tech Mono', monospace; display: none;
        }
        .alert-msg.success { display: block; background: rgba(0, 200, 80, 0.1); border: 1px solid rgba(0, 200, 80, 0.3); color: #00cc55; }
        .alert-msg.error { display: block; background: rgba(255, 60, 60, 0.1); border: 1px solid rgba(255, 60, 60, 0.3); color: #ff4444; }

        .my-deposits-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .my-deposits-table th {
            text-align: left; padding: 0.5rem 0.4rem;
            color: var(--accent-cyan); font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem; letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.2);
        }
        .my-deposits-table td {
            padding: 0.4rem; color: var(--text-primary);
            border-bottom: 1px solid rgba(0, 170, 255, 0.06); vertical-align: middle;
        }
        .my-deposits-table tr:hover { background: rgba(0, 170, 255, 0.03); }
        .motif-badge {
            display: inline-block; padding: 0.1rem 0.4rem; border-radius: 2px;
            font-family: 'Share Tech Mono', monospace; font-size: 0.68rem;
            font-weight: 700; letter-spacing: 0.5px;
            background: rgba(255, 200, 0, 0.15); color: #ffcc00;
            border: 1px solid rgba(255, 200, 0, 0.3);
        }
        .montant-value {
            font-family: 'Orbitron', sans-serif; font-size: 0.82rem;
            font-weight: 700; color: #00cc55;
        }

        .sync-indicator {
            position: fixed; bottom: 1rem; right: 1rem;
            padding: 0.4rem 0.8rem; border-radius: 3px;
            font-family: 'Share Tech Mono', monospace; font-size: 0.72rem;
            z-index: 999; transition: all 0.3s; pointer-events: none; opacity: 0;
        }
        .sync-indicator.syncing { opacity: 1; background: rgba(255, 200, 0, 0.15); border: 1px solid rgba(255, 200, 0, 0.4); color: #ffc800; }
        .sync-indicator.synced { opacity: 1; background: rgba(0, 200, 80, 0.15); border: 1px solid rgba(0, 200, 80, 0.4); color: #00cc55; }
        .sync-indicator.error { opacity: 1; background: rgba(255, 60, 60, 0.15); border: 1px solid rgba(255, 60, 60, 0.4); color: #ff4444; }
        .sync-indicator.hidden { opacity: 0; }
        @keyframes spin-sync { to { transform: rotate(360deg); } }
        .sync-spinner { display: inline-block; animation: spin-sync 1s linear infinite; }

        #access-denied, #notApproved { display: none; text-align: center; padding: 3rem; }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>

    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">D√©p√¥t d'Argent</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p>
            </div>
            <div id="access-denied">
                <h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">CONNEXION REQUISE</h2>
                <p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.5rem;">Vous devez √™tre connect√© pour d√©clarer un d√©p√¥t.</p>
                <a href="login.html" style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;display:inline-block;margin-top:1rem;">‚Üí SE CONNECTER</a>
            </div>
            <div id="notApproved">
                <h2 style="color:#ffaa00;font-family:'Orbitron',sans-serif;">EN ATTENTE D'APPROBATION</h2>
                <p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.5rem;">Votre compte n'a pas encore √©t√© approuv√©.</p>
            </div>

            <div id="mainContent" style="display:none;">
                <div class="depot-wrapper">

                    <div class="user-info-bar">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-details">
                            <div class="user-matricule" id="userIdentification">---</div>
                            <div id="userAccreditation" style="font-size:0.7rem;color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.15rem;"></div>
                        </div>
                        <div class="user-status">CONNECT√â</div>
                    </div>

                    <div id="alertMsg" class="alert-msg"></div>

                    <div class="combine-terminal-wrapper">
                        <div class="combine-header">
                            <h2>üí∞ D√âCLARATION DE D√âP√îT</h2>
                            <span class="header-code">FORM-02</span>
                        </div>
                        <div class="combine-body">

                            <div class="row-2">
                                <div class="form-group" id="grpMontant">
                                    <label>MONTANT (TOKENS) <span class="req">*</span></label>
                                    <input type="number" id="fMontant" min="1" step="1" pattern="[0-9]*" placeholder="Ex: 500" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                                    <div class="hint">Nombre entier uniquement</div>
                                    <div class="error-msg" id="errMontant"></div>
                                </div>
                                <div class="form-group" id="grpMotif">
                                    <label>SOURCE <span class="req">*</span></label>
                                    <select id="fMotif" onchange="onSourceChange()">
                                        <option value="">‚Äî S√©lectionner ‚Äî</option>
                                        <option value="Caution">Caution</option>
                                        <option value="Transfert de fond (donation)">Transfert de fond (donation)</option>
                                        <option value="Saisie sur corps">Saisie sur corps</option>
                                        <option value="Sanction Unit√©s">Sanction Unit√©s</option>
                                        <option value="Remboursement">Remboursement</option>
                                        <option value="B√©n√©fice">B√©n√©fice</option>
                                        <option value="Conscription">Conscription</option>
                                    </select>
                                    <div class="error-msg" id="errMotif"></div>
                                </div>
                            </div>

                            <div class="form-group" id="grpBenefice" style="display:none;">
                                <label>TYPE DE B√âN√âFICE <span class="req">*</span></label>
                                <select id="fBeneficeType">
                                    <option value="">‚Äî S√©lectionner ‚Äî</option>
                                    <option value="B√©n√©fice Unit√©">B√©n√©fice Unit√©</option>
                                    <option value="B√©n√©fice Divisionnaire">B√©n√©fice Divisionnaire</option>
                                </select>
                                <div class="error-msg" id="errBenefice"></div>
                            </div>

                            <div class="form-group">
                                <label>D√âTAILS / NOTES</label>
                                <textarea id="fNotes" rows="2" placeholder="Pr√©cisions sur le d√©p√¥t (optionnel)"></textarea>
                            </div>

                            <div class="form-actions">
                                <button class="btn-action" onclick="resetForm()">R√âINITIALISER</button>
                                <button class="btn-action primary" id="btnSubmit" onclick="submitDeposit()">‚ü© D√âCLARER LE D√âP√îT</button>
                            </div>
                        </div>
                    </div>

                    <div class="combine-terminal-wrapper" style="margin-top: 1.5rem;">
                        <div class="combine-header">
                            <h2>MES D√âP√îTS</h2>
                            <span class="header-code" id="myDepositCount">0</span>
                        </div>
                        <div class="combine-body">
                            <div style="overflow-x:auto;">
                                <table class="my-deposits-table">
                                    <thead>
                                        <tr>
                                            <th>DATE</th>
                                            <th>MONTANT</th>
                                            <th>MOTIF</th>
                                            <th>NOTES</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myDepositsBody">
                                        <tr><td colspan="4" style="text-align:center;color:var(--text-muted);">Aucun d√©p√¥t d√©clar√©</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script type="module" src="assets/js/auth.js"></script>
    <script src="assets/js/global-nav.js"></script>
    <script src="assets/js/interactive-system.js"></script>
    <script src="assets/js/combine-animations.js"></script>

    <script type="module">
      import { auth, db } from './assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { loadDeposits as ghLoadDeposits, addDeposit as ghAddDeposit, loadUnits as ghLoadUnits, onSyncStatus } from './assets/js/github-data.js';

      function getAccreditation(r) {
        if (r==='RCT') return 'Recrue';
        if (['.05','.04','.03','STB'].includes(r)) return 'MPF';
        if (['.02','.01','DvL','STBE','CABAL'].includes(r)) return 'MPEF';
        if (['Ofc','Cmd'].includes(r)) return 'HautGrad√©';
        return '';
      }

      { const i=document.createElement('div');i.id='syncIndicator';i.className='sync-indicator hidden';document.body.appendChild(i);let t=null;
        onSyncStatus(s=>{clearTimeout(t);if(s==='syncing'){i.innerHTML='<span class="sync-spinner">‚ü≥</span> Synchronisation...';i.className='sync-indicator syncing';}else if(s==='synced'){i.innerHTML='‚úì Synchronis√©';i.className='sync-indicator synced';t=setTimeout(()=>i.className='sync-indicator hidden',2500);}else{i.innerHTML='‚ö† Erreur sync';i.className='sync-indicator error';t=setTimeout(()=>i.className='sync-indicator hidden',6000);}});
      }

      let currentUser=null, allDeposits=[];

      function showAlert(t,type='success'){const e=document.getElementById('alertMsg');e.style.display='block';e.className='alert-msg '+type;e.textContent=t;setTimeout(()=>e.style.display='none',6000);}
      function fmtDate(d){if(!d)return'-';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d;}

      window.onSourceChange = function() {
        const v = document.getElementById('fMotif').value;
        document.getElementById('grpBenefice').style.display = (v === 'B√©n√©fice') ? '' : 'none';
        if (v !== 'B√©n√©fice') document.getElementById('fBeneficeType').value = '';
      };

      window.submitDeposit = async function() {
        if(!currentUser){showAlert('Erreur: utilisateur non identifi√©','error');return;}
        let ok=true;
        ['grpMontant','grpMotif','grpBenefice'].forEach(id=>document.getElementById(id).classList.remove('error'));
        const montant=parseInt(document.getElementById('fMontant').value);
        if(!montant||montant<1){document.getElementById('grpMontant').classList.add('error');document.getElementById('errMontant').textContent='Montant invalide';ok=false;}
        const source=document.getElementById('fMotif').value;
        if(!source){document.getElementById('grpMotif').classList.add('error');document.getElementById('errMotif').textContent='S√©lectionnez une source';ok=false;}
        if(source==='B√©n√©fice'&&!document.getElementById('fBeneficeType').value){document.getElementById('grpBenefice').classList.add('error');document.getElementById('errBenefice').textContent='S√©lectionnez le type de b√©n√©fice';ok=false;}
        if(!ok)return;

        const motifFinal = source === 'B√©n√©fice' ? document.getElementById('fBeneficeType').value : source;

        const btn=document.getElementById('btnSubmit');btn.disabled=true;btn.textContent='‚è≥ ENVOI...';
        const dep={
          matricule:currentUser.matricule, nom_steam:currentUser.nom_steam||'',
          montant, motif:motifFinal,
          notes:document.getElementById('fNotes').value.trim(),
          created_at:new Date().toISOString().substring(0,10)
        };
        allDeposits.push(dep);
        try {
          const saved = await ghAddDeposit(dep);
          allDeposits[allDeposits.length - 1] = saved;
          showAlert('‚úì D√©p√¥t d√©clar√© avec succ√®s !','success');
          resetForm(); renderMyDeposits();
        }catch(e){allDeposits.pop();showAlert('‚úó Erreur: '+e.message,'error');}
        finally{btn.disabled=false;btn.textContent='‚ü© D√âCLARER LE D√âP√îT';}
      };

      window.resetForm=function(){
        document.getElementById('fMontant').value='';
        document.getElementById('fMotif').value='';
        document.getElementById('fBeneficeType').value='';
        document.getElementById('grpBenefice').style.display='none';
        document.getElementById('fNotes').value='';
        ['grpMontant','grpMotif','grpBenefice'].forEach(id=>document.getElementById(id).classList.remove('error'));
      };

      function renderMyDeposits(){
        if(!currentUser)return;
        const mine=allDeposits.filter(d=>d.matricule===currentUser.matricule).sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||''));
        document.getElementById('myDepositCount').textContent=`${mine.length} D√âP√îT${mine.length>1?'S':''}`;
        const tb=document.getElementById('myDepositsBody');
        if(!mine.length){tb.innerHTML='<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">Aucun d√©p√¥t d√©clar√©</td></tr>';return;}
        tb.innerHTML=mine.map(d=>`<tr>
          <td style="font-size:0.75rem;">${fmtDate(d.created_at)}</td>
          <td><span class="montant-value">${d.montant} tks</span></td>
          <td><span class="motif-badge">${d.motif}</span></td>
          <td style="font-size:0.75rem;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(d.notes||'').replace(/"/g,'&quot;')}">${d.notes||'-'}</td>
        </tr>`).join('');
      }

      onAuthStateChanged(auth,async(user)=>{
        if(!user){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
        try{
          const s=await getDoc(doc(db,'users',user.uid));
          if(!s.exists()){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
          const ud=s.data();
          if(!ud.approved){document.getElementById('loading').style.display='none';document.getElementById('notApproved').style.display='block';return;}
          currentUser={matricule:ud.matricule||'???',nom_steam:ud.nom_steam||'',steamid64:ud.steamid64||''};
          let ui=null;try{const u=await ghLoadUnits();ui=u.find(x=>x.matricule===currentUser.matricule)||null;}catch(_){}
          const rg=ui?(ui.rang||''):'';const isHG=rg==='Ofc'||rg==='Cmd';const dv=ui&&!isHG?(ui.division||''):'';
          const acc=getAccreditation(rg);
          document.getElementById('userIdentification').textContent='Identification : '+[rg,dv,currentUser.matricule].filter(Boolean).join(' ');
          document.getElementById('userAvatar').textContent=currentUser.matricule.substring(0,3);
          if(acc){let l='Accr√©ditation : '+acc;if(ui&&ui.formateur)l+=' ‚Äî '+((acc==='MPF'||acc==='Recrue')?'Unit√© Formatrice MPF':'Unit√© Formatrice MPEF');document.getElementById('userAccreditation').textContent=l;}
          document.getElementById('loading').style.display='none';document.getElementById('mainContent').style.display='block';
          try{allDeposits=await ghLoadDeposits();}catch(_){allDeposits=[];}
          renderMyDeposits();
        }catch(e){console.error(e);document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';}
      });
    </script>
</body>
</html>
