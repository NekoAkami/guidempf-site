*<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payes & Gains - MPF</title>
    <link rel="stylesheet" href="assets/css/main-style.css">
    <link rel="stylesheet" href="assets/css/combine-terminals.css">
    <link rel="stylesheet" href="assets/css/global-nav.css">
    <link rel="stylesheet" href="assets/css/interactive-system.css">
    <link rel="stylesheet" href="assets/css/combine-animations.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        .payes-wrapper { max-width: 1100px; margin: 0 auto; }

        .tabs-bar {
            display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;
        }
        .tab-btn {
            padding: 0.5rem 1rem; border-radius: 3px; cursor: pointer;
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
            border: 1px solid rgba(0, 170, 255, 0.3);
            background: rgba(0, 170, 255, 0.05); color: var(--accent-cyan);
            transition: all 0.15s; font-weight: 700; letter-spacing: 0.5px;
        }
        .tab-btn:hover { background: rgba(0, 170, 255, 0.15); }
        .tab-btn.active { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.8rem; margin-bottom: 1.2rem; }
        .stat-card { padding: 0.8rem; text-align: center; background: rgba(0,170,255,0.03); border: 1px solid rgba(0,170,255,0.1); border-radius: 4px; }
        .stat-card .stat-number { font-family: 'Orbitron', sans-serif; font-size: 1.3rem; color: var(--accent-cyan); font-weight: 700; }
        .stat-card .stat-label { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 0.2rem; }
        .stat-card.green .stat-number { color: var(--accent-green); }
        .stat-card.green { border-color: rgba(0,204,102,0.15); }
        .stat-card.yellow .stat-number { color: var(--accent-yellow); }
        .stat-card.yellow { border-color: rgba(204,170,0,0.15); }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-family: 'Share Tech Mono', monospace; font-size: 0.72rem; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 0.3rem; }
        .form-group label .req { color: #ff4444; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem 0.7rem; background: rgba(0,170,255,0.04); border: 1px solid rgba(0,170,255,0.2); color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.82rem; outline: none; border-radius: 2px; }
        .form-group input:focus { border-color: var(--accent-cyan); }
        .form-group select option { background: #0a1628; }

        .config-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .config-table th { text-align: left; padding: 0.5rem; color: var(--accent-cyan); font-family: 'Share Tech Mono', monospace; font-size: 0.68rem; letter-spacing: 1px; border-bottom: 2px solid rgba(0,170,255,0.2); }
        .config-table td { padding: 0.4rem 0.5rem; color: var(--text-primary); border-bottom: 1px solid rgba(0,170,255,0.06); font-family: 'Share Tech Mono', monospace; vertical-align: middle; }
        .config-table tr:hover { background: rgba(0,170,255,0.03); }
        .config-table input[type="number"] { width: 80px; padding: 0.3rem; background: rgba(0,170,255,0.06); border: 1px solid rgba(0,170,255,0.2); color: var(--accent-cyan); font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; text-align: right; outline: none; border-radius: 2px; }
        .config-table input[type="number"]:focus { border-color: var(--accent-cyan); }

        .payroll-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .payroll-table th { text-align: left; padding: 0.5rem 0.4rem; color: var(--accent-cyan); font-family: 'Share Tech Mono', monospace; font-size: 0.68rem; letter-spacing: 1px; border-bottom: 2px solid rgba(0,170,255,0.2); cursor: pointer; user-select: none; }
        .payroll-table th:hover { color: #fff; }
        .payroll-table td { padding: 0.4rem; color: var(--text-primary); border-bottom: 1px solid rgba(0,170,255,0.06); font-family: 'Share Tech Mono', monospace; vertical-align: middle; }
        .payroll-table tr:hover { background: rgba(0,170,255,0.03); }
        .payroll-table .pay-amount { color: var(--accent-green); font-weight: 700; }

        .btn-action { padding: 0.5rem 1.2rem; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; cursor: pointer; border: 1px solid rgba(0,170,255,0.4); background: rgba(0,170,255,0.1); color: var(--accent-cyan); border-radius: 3px; transition: all 0.15s; letter-spacing: 0.5px; }
        .btn-action:hover { background: rgba(0,170,255,0.2); border-color: var(--accent-cyan); }
        .btn-action.primary { background: rgba(0,170,255,0.2); border-color: var(--accent-cyan); font-weight: 700; }
        .btn-action.primary:hover { background: rgba(0,170,255,0.35); }
        .btn-action.green { border-color: rgba(0,204,102,0.4); background: rgba(0,204,102,0.1); color: var(--accent-green); }
        .btn-action.green:hover { background: rgba(0,204,102,0.2); }
        .btn-action.danger { border-color: rgba(255,68,68,0.4); background: rgba(255,68,68,0.08); color: #ff6666; }
        .btn-action.danger:hover { background: rgba(255,68,68,0.15); }
        .btn-action:disabled { opacity: 0.4; cursor: not-allowed; }

        .alert-msg { padding: 0.6rem 1rem; border-radius: 3px; margin-bottom: 1rem; font-size: 0.8rem; font-family: 'Share Tech Mono', monospace; display: none; }
        .alert-msg.success { display: block; background: rgba(0,200,80,0.1); border: 1px solid rgba(0,200,80,0.3); color: #00cc55; }
        .alert-msg.error { display: block; background: rgba(255,60,60,0.1); border: 1px solid rgba(255,60,60,0.3); color: #ff4444; }

        .earnings-list { margin-top: 1rem; }
        .earning-row { display: flex; align-items: center; gap: 0.8rem; padding: 0.5rem 0.8rem; border-bottom: 1px solid rgba(0,170,255,0.06); font-family: 'Share Tech Mono', monospace; font-size: 0.82rem; }
        .earning-row:hover { background: rgba(0,170,255,0.03); }
        .earning-row .earning-date { color: var(--text-muted); min-width: 90px; }
        .earning-row .earning-desc { flex: 1; color: var(--text-primary); }
        .earning-row .earning-amount { color: var(--accent-green); font-weight: 700; min-width: 80px; text-align: right; }
        .earning-row .earning-delete { color: #ff6666; cursor: pointer; font-size: 0.7rem; padding: 0.2rem 0.4rem; border: 1px solid rgba(255,68,68,0.2); background: rgba(255,68,68,0.05); border-radius: 2px; }
        .earning-row .earning-delete:hover { background: rgba(255,68,68,0.15); }

        .archive-card { margin-bottom: 1rem; background: rgba(0,170,255,0.02); border: 1px solid rgba(0,170,255,0.1); border-radius: 4px; padding: 1rem; }
        .archive-card h3 { color: var(--accent-cyan); font-family: 'Orbitron', sans-serif; font-size: 0.85rem; margin-bottom: 0.5rem; }
        .archive-card .archive-meta { color: var(--text-muted); font-family: 'Share Tech Mono', monospace; font-size: 0.72rem; margin-bottom: 0.8rem; }

        .search-bar { margin-bottom: 1rem; }
        .search-bar input { width: 100%; padding: 0.45rem 0.7rem; background: rgba(0,170,255,0.04); border: 1px solid rgba(0,170,255,0.2); color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; outline: none; border-radius: 2px; }
        .search-bar input:focus { border-color: var(--accent-cyan); }

        .sync-indicator { position: fixed; bottom: 1rem; right: 1rem; padding: 0.4rem 0.8rem; border-radius: 3px; font-family: 'Share Tech Mono', monospace; font-size: 0.72rem; z-index: 999; transition: all 0.3s; pointer-events: none; opacity: 0; }
        .sync-indicator.syncing { opacity: 1; background: rgba(255,200,0,0.15); border: 1px solid rgba(255,200,0,0.4); color: #ffc800; }
        .sync-indicator.synced { opacity: 1; background: rgba(0,200,80,0.15); border: 1px solid rgba(0,200,80,0.4); color: #00cc55; }
        .sync-indicator.error { opacity: 1; background: rgba(255,60,60,0.15); border: 1px solid rgba(255,60,60,0.4); color: #ff4444; }
        .sync-indicator.hidden { opacity: 0; }

        .confirm-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.75); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .confirm-box { background: #0a1628; border: 1px solid rgba(0,170,255,0.3); padding: 1.5rem; border-radius: 6px; max-width: 500px; width: 90%; text-align: center; }
        .confirm-box p { color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; margin-bottom: 1rem; }
        .confirm-box .confirm-btns { display: flex; gap: 0.8rem; justify-content: center; }

        .hg-only { display: none; }
        .hg-only.visible { display: block; }

        #access-denied { display: none; text-align: center; padding: 3rem; }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>

    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">Payes & Gains de la Milice</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p>
            </div>
            <div id="access-denied">
                <h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">CONNEXION REQUISE</h2>
                <a href="login.html" style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;display:inline-block;margin-top:1rem;">‚Üí SE CONNECTER</a>
            </div>

            <div id="mainContent" style="display:none;">
                <div class="payes-wrapper">

                    <!-- Onglets principaux -->
                    <div class="tabs-bar">
                        <button class="tab-btn active" onclick="switchTab('payes')">üí∞ PAYES</button>
                        <button class="tab-btn" onclick="switchTab('gains')">üìä GAINS MILICE</button>
                        <button class="tab-btn" onclick="switchTab('config')" id="tabConfig" style="display:none;">‚öô CONFIGURATION</button>
                        <button class="tab-btn" onclick="switchTab('archives')">üìÅ ARCHIVES</button>
                    </div>

                    <div id="alertMsg" class="alert-msg"></div>

                    <!-- ===== ONGLET PAYES ===== -->
                    <div class="tab-content active" id="tab-payes">
                        <!-- Infos semaine -->
                        <div class="stat-cards">
                            <div class="stat-card"><div class="stat-number" id="payWeekLabel">-</div><div class="stat-label">SEMAINE EN COURS</div></div>
                            <div class="stat-card green"><div class="stat-number" id="payTotalGains">0</div><div class="stat-label">GAINS SEMAINE (TOKENS)</div></div>
                            <div class="stat-card"><div class="stat-number" id="payTotalDistrib">0</div><div class="stat-label">TOTAL DISTRIBU√â (%)</div></div>
                            <div class="stat-card yellow"><div class="stat-number" id="payUnitCount">0</div><div class="stat-label">UNIT√âS PAY√âES</div></div>
                        </div>

                        <!-- Bouton finaliser (HG seulement) -->
                        <div class="hg-only" id="hgPayActions" style="margin-bottom:1rem;display:none;">
                            <button class="btn-action green" onclick="confirmFinalize()">‚ü© FINALISER LES PAYES DE LA SEMAINE</button>
                        </div>

                        <!-- Tableau des payes -->
                        <div class="combine-terminal-wrapper animate-fadeInUp">
                            <div class="combine-header">
                                <h2>PAYES DE LA SEMAINE</h2>
                                <span class="header-code" id="payCountLabel">0 UNIT√âS</span>
                            </div>
                            <div class="combine-body">
                                <div class="search-bar">
                                    <input type="text" id="paySearch" placeholder="Rechercher une unit√©..." oninput="renderPayroll()">
                                </div>
                                <div style="overflow-x:auto;">
                                    <table class="payroll-table">
                                        <thead>
                                            <tr>
                                                <th onclick="sortPayBy('matricule')">MATRICULE</th>
                                                <th onclick="sortPayBy('nom_steam')">NOM</th>
                                                <th onclick="sortPayBy('total_reports')">RAPPORTS</th>
                                                <th onclick="sortPayBy('total_pct')">% TOTAL</th>
                                                <th onclick="sortPayBy('pay')">PAYE (TOKENS)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="payrollBody">
                                            <tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Chargement...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Derni√®re paye archiv√©e visible -->
                        <div id="lastArchivedPay" style="margin-top:1.5rem;"></div>
                    </div>

                    <!-- ===== ONGLET GAINS ===== -->
                    <div class="tab-content" id="tab-gains">
                        <div class="stat-cards">
                            <div class="stat-card green"><div class="stat-number" id="gainsTotal">0</div><div class="stat-label">GAINS SEMAINE (TOKENS)</div></div>
                            <div class="stat-card"><div class="stat-number" id="gainsCount">0</div><div class="stat-label">ENTR√âES CETTE SEMAINE</div></div>
                        </div>

                        <!-- Ajouter un gain (HG only) -->
                        <div class="hg-only" id="hgGainsForm" style="display:none;">
                            <div class="combine-terminal-wrapper" style="margin-bottom:1.5rem;">
                                <div class="combine-header">
                                    <h2>AJOUTER UN GAIN</h2>
                                    <span class="header-code">HG ONLY</span>
                                </div>
                                <div class="combine-body">
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                                        <div class="form-group">
                                            <label>MONTANT (TOKENS) <span class="req">*</span></label>
                                            <input type="number" id="gainAmount" min="0" placeholder="Ex: 5000">
                                        </div>
                                        <div class="form-group">
                                            <label>DESCRIPTION <span class="req">*</span></label>
                                            <input type="text" id="gainDesc" placeholder="Ex: Confiscation contrebande">
                                        </div>
                                    </div>
                                    <div style="text-align:right;margin-top:0.5rem;">
                                        <button class="btn-action primary" onclick="addGain()">‚ü© AJOUTER</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Liste des gains -->
                        <div class="combine-terminal-wrapper animate-fadeInUp">
                            <div class="combine-header">
                                <h2>GAINS DE LA SEMAINE</h2>
                                <span class="header-code" id="gainsListLabel">0 ENTR√âES</span>
                            </div>
                            <div class="combine-body">
                                <div class="earnings-list" id="earningsList">
                                    <p style="text-align:center;color:var(--text-muted);padding:1rem;">Aucun gain enregistr√© cette semaine</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== ONGLET CONFIGURATION (HG only) ===== -->
                    <div class="tab-content" id="tab-config">
                        <div class="combine-terminal-wrapper animate-fadeInUp">
                            <div class="combine-header">
                                <h2>VALEURS DES RAPPORTS</h2>
                                <span class="header-code">% DES GAINS HEBDO PAR RAPPORT</span>
                            </div>
                            <div class="combine-body">
                                <p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;font-size:0.78rem;margin-bottom:1rem;">
                                    Chaque rapport d'une unit√© lui donne droit √† un pourcentage des gains hebdomadaires de la milice.
                                    Modifiez les valeurs ci-dessous pour ajuster la r√©mun√©ration par type de rapport.
                                </p>
                                <table class="config-table">
                                    <thead>
                                        <tr>
                                            <th>TYPE DE RAPPORT</th>
                                            <th>% PAR RAPPORT</th>
                                        </tr>
                                    </thead>
                                    <tbody id="configBody"></tbody>
                                </table>
                                <div style="text-align:right;margin-top:1rem;">
                                    <button class="btn-action primary" onclick="saveConfig()">‚ü© SAUVEGARDER LA CONFIGURATION</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== ONGLET ARCHIVES ===== -->
                    <div class="tab-content" id="tab-archives">
                        <div class="combine-terminal-wrapper animate-fadeInUp">
                            <div class="combine-header">
                                <h2>ARCHIVES DES PAYES</h2>
                                <span class="header-code" id="archiveCountLabel">0 SEMAINES</span>
                            </div>
                            <div class="combine-body" id="archivesContainer">
                                <p style="text-align:center;color:var(--text-muted);padding:1rem;">Aucune archive disponible</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script type="module" src="assets/js/auth.js"></script>
    <script src="assets/js/global-nav.js"></script>
    <script src="assets/js/interactive-system.js"></script>
    <script src="assets/js/combine-animations.js"></script>

    <script type="module">
      import { auth, db } from './assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { loadReports, loadUnits, loadPayrollConfig, savePayrollConfig, loadPayrollArchives, addPayrollArchive, loadEarnings, addEarning, deleteEarning, onSyncStatus } from './assets/js/github-data.js';

      // Sync indicator
      { const i=document.createElement('div');i.id='syncIndicator';i.className='sync-indicator hidden';document.body.appendChild(i);let t=null;
        onSyncStatus(s=>{clearTimeout(t);if(s==='syncing'){i.innerHTML='<span style="display:inline-block;animation:spin 1s linear infinite;">‚ü≥</span> Synchronisation...';i.className='sync-indicator syncing';}else if(s==='synced'){i.innerHTML='‚úì Synchronis√©';i.className='sync-indicator synced';t=setTimeout(()=>i.className='sync-indicator hidden',2500);}else{i.innerHTML='‚ö† Erreur';i.className='sync-indicator error';t=setTimeout(()=>i.className='sync-indicator hidden',6000);}});
      }

      let currentUser = null, isHG = false;
      let allReports = [], allUnits = [], payrollConfig = {}, allEarnings = [], allArchives = [];
      let payrollData = [], paySortField = 'pay', paySortDir = 'desc';

      function fmtDate(d) { if(!d) return '-'; const p=d.split('-'); return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d; }
      function showAlert(t, type='success') { const e=document.getElementById('alertMsg'); e.style.display='block'; e.className='alert-msg '+type; e.textContent=t; setTimeout(()=>e.style.display='none',6000); }

      function getWeekBounds(date) {
        const d = date ? new Date(date) : new Date();
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(d); monday.setDate(diff); monday.setHours(0,0,0,0);
        const sunday = new Date(monday); sunday.setDate(sunday.getDate() + 6); sunday.setHours(23,59,59,999);
        return { start: monday.toISOString().substring(0,10), end: sunday.toISOString().substring(0,10) };
      }

      function getWeekReports() {
        const w = getWeekBounds();
        return allReports.filter(r => (r.type_rapport || 'unit√©') === 'unit√©' && r.created_at >= w.start && r.created_at <= w.end);
      }

      function getWeekEarnings() {
        const w = getWeekBounds();
        return allEarnings.filter(e => e.created_at >= w.start && e.created_at <= w.end);
      }

      function getTotalWeekGains() {
        return getWeekEarnings().reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
      }

      // ===== ONGLETS =====
      window.switchTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
      };

      // ===== CONFIGURATION =====
      function renderConfig() {
        const vals = payrollConfig.report_values || {};
        const types = ['Patrouille','Op√©ration','Fouille mineur','Fouille majeur','Point Passage','Protection VIP','Distribution ration','Formation','Conscription','Session de travail','D√©blayage','Interrogatoire','Test de loyaut√©','Autre'];
        const tb = document.getElementById('configBody');
        tb.innerHTML = types.map(t => {
          const v = vals[t] !== undefined ? vals[t] : 1.0;
          return `<tr>
            <td>${t}</td>
            <td><input type="number" step="0.1" min="0" value="${v}" data-type="${t}"></td>
          </tr>`;
        }).join('');
      }

      window.saveConfig = async function() {
        const inputs = document.querySelectorAll('#configBody input[type="number"]');
        const values = {};
        inputs.forEach(inp => { values[inp.dataset.type] = parseFloat(inp.value) || 0; });
        payrollConfig.report_values = values;
        payrollConfig.updated_by = currentUser?.matricule || '';
        try {
          await savePayrollConfig(payrollConfig);
          showAlert('‚úì Configuration sauvegard√©e', 'success');
          calculatePayroll();
        } catch(e) { showAlert('‚úó Erreur: ' + e.message, 'error'); }
      };

      // ===== GAINS =====
      function renderEarnings() {
        const weekEarnings = getWeekEarnings();
        const total = getTotalWeekGains();
        document.getElementById('gainsTotal').textContent = total.toLocaleString('fr-FR');
        document.getElementById('gainsCount').textContent = weekEarnings.length;
        document.getElementById('gainsListLabel').textContent = weekEarnings.length + ' ENTR√âE' + (weekEarnings.length > 1 ? 'S' : '');

        const container = document.getElementById('earningsList');
        if (!weekEarnings.length) {
          container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:1rem;">Aucun gain enregistr√© cette semaine</p>';
          return;
        }
        container.innerHTML = weekEarnings.sort((a,b) => (b.created_at||'').localeCompare(a.created_at||'')).map(e => `
          <div class="earning-row">
            <span class="earning-date">${fmtDate(e.created_at)}</span>
            <span class="earning-desc">${e.description || '-'}</span>
            <span class="earning-amount">+${(parseFloat(e.amount)||0).toLocaleString('fr-FR')}</span>
            ${isHG ? `<button class="earning-delete" onclick="removeGain('${e._id}')">‚úï</button>` : ''}
          </div>
        `).join('');
      }

      window.addGain = async function() {
        const amount = parseFloat(document.getElementById('gainAmount').value);
        const desc = document.getElementById('gainDesc').value.trim();
        if (!amount || amount <= 0) { showAlert('Montant invalide', 'error'); return; }
        if (!desc) { showAlert('Description requise', 'error'); return; }
        const earning = {
          amount, description: desc,
          created_at: new Date().toISOString().substring(0,10),
          added_by: currentUser?.matricule || ''
        };
        try {
          const saved = await addEarning(earning);
          allEarnings.push(saved);
          document.getElementById('gainAmount').value = '';
          document.getElementById('gainDesc').value = '';
          showAlert('‚úì Gain ajout√©', 'success');
          renderEarnings();
          calculatePayroll();
        } catch(e) { showAlert('‚úó Erreur: ' + e.message, 'error'); }
      };

      window.removeGain = async function(id) {
        try {
          await deleteEarning(id);
          allEarnings = allEarnings.filter(e => e._id !== id);
          showAlert('‚úì Gain supprim√©', 'success');
          renderEarnings();
          calculatePayroll();
        } catch(e) { showAlert('‚úó Erreur: ' + e.message, 'error'); }
      };

      // ===== CALCUL DES PAYES =====
      function calculatePayroll() {
        const weekReports = getWeekReports();
        const totalGains = getTotalWeekGains();
        const values = payrollConfig.report_values || {};

        // Agr√©ger par unit√©
        const unitMap = {};
        weekReports.forEach(r => {
          const mat = r.matricule;
          if (!mat) return;
          if (!unitMap[mat]) unitMap[mat] = { matricule: mat, nom_steam: r.nom_steam || '', reports: {}, total_reports: 0, total_pct: 0 };
          const baseType = getBaseType(r.type);
          unitMap[mat].reports[baseType] = (unitMap[mat].reports[baseType] || 0) + 1;
          unitMap[mat].total_reports++;
          unitMap[mat].total_pct += (values[baseType] || values[r.type] || 1.0);
        });

        // Enrichir avec les unit√©s connues
        allUnits.forEach(u => {
          if (unitMap[u.matricule]) {
            unitMap[u.matricule].nom_steam = u.nom_steam || unitMap[u.matricule].nom_steam;
          }
        });

        // Calculer la paye
        payrollData = Object.values(unitMap).map(u => {
          u.pay = totalGains > 0 ? Math.round((u.total_pct / 100) * totalGains) : 0;
          return u;
        });

        // Stats
        const w = getWeekBounds();
        document.getElementById('payWeekLabel').textContent = fmtDate(w.start) + ' ‚Äî ' + fmtDate(w.end);
        document.getElementById('payTotalGains').textContent = totalGains.toLocaleString('fr-FR');
        const totalDistrib = payrollData.reduce((s, u) => s + u.total_pct, 0);
        document.getElementById('payTotalDistrib').textContent = totalDistrib.toFixed(1) + '%';
        document.getElementById('payUnitCount').textContent = payrollData.length;

        renderPayroll();
      }

      function getBaseType(type) {
        // Normaliser les types pour matcher la config
        if (!type) return 'Autre';
        if (type.includes('Fouille mineur')) return 'Fouille mineur';
        if (type.includes('Fouille majeur')) return 'Fouille majeur';
        if (type.includes('Conscription')) return 'Conscription';
        if (type.includes('Session de travail')) return 'Session de travail';
        return type;
      }

      window.renderPayroll = function() {
        const q = (document.getElementById('paySearch')?.value || '').toLowerCase();
        let data = payrollData;
        if (q) data = data.filter(u => `${u.matricule} ${u.nom_steam}`.toLowerCase().includes(q));

        data.sort((a, b) => {
          if (paySortField === 'pay' || paySortField === 'total_reports' || paySortField === 'total_pct') {
            return paySortDir === 'asc' ? a[paySortField] - b[paySortField] : b[paySortField] - a[paySortField];
          }
          const va = (a[paySortField]||'').toLowerCase(), vb = (b[paySortField]||'').toLowerCase();
          return paySortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
        });

        document.getElementById('payCountLabel').textContent = data.length + ' UNIT√â' + (data.length > 1 ? 'S' : '');
        const tb = document.getElementById('payrollBody');
        if (!data.length) {
          tb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Aucune paye √† afficher</td></tr>';
          return;
        }
        tb.innerHTML = data.map(u => {
          const typesStr = Object.entries(u.reports).map(([t,c]) => `${t}: ${c}`).join(', ');
          return `<tr>
            <td>${u.matricule}</td>
            <td style="font-size:0.75rem;">${u.nom_steam || '-'}</td>
            <td title="${typesStr}">${u.total_reports}</td>
            <td>${u.total_pct.toFixed(1)}%</td>
            <td class="pay-amount">${u.pay.toLocaleString('fr-FR')} T</td>
          </tr>`;
        }).join('');
      };

      window.sortPayBy = function(field) {
        if (paySortField === field) paySortDir = paySortDir === 'asc' ? 'desc' : 'asc';
        else { paySortField = field; paySortDir = 'desc'; }
        renderPayroll();
      };

      // ===== FINALISER LES PAYES =====
      window.confirmFinalize = function() {
        if (!payrollData.length) { showAlert('Aucune paye √† finaliser', 'error'); return; }
        const w = getWeekBounds();
        const totalGains = getTotalWeekGains();
        const overlay = document.createElement('div'); overlay.className = 'confirm-overlay';
        overlay.innerHTML = `<div class="confirm-box">
          <p>‚ö† Finaliser les payes de la semaine du ${fmtDate(w.start)} au ${fmtDate(w.end)} ?<br>
          <span style="font-size:0.75rem;color:var(--text-muted);">Gains: ${totalGains.toLocaleString('fr-FR')} T ‚Äî ${payrollData.length} unit√©s pay√©es<br>
          Cette action archivera les payes et elles resteront visibles la semaine suivante.</span></p>
          <div class="confirm-btns">
            <button class="btn-action" onclick="this.closest('.confirm-overlay').remove()">ANNULER</button>
            <button class="btn-action green" onclick="executeFinalize()">FINALISER</button>
          </div>
        </div>`;
        document.body.appendChild(overlay);
        overlay.addEventListener('click', e => { if(e.target===overlay) overlay.remove(); });
      };

      window.executeFinalize = async function() {
        document.querySelector('.confirm-overlay')?.remove();
        const w = getWeekBounds();
        const totalGains = getTotalWeekGains();
        const archive = {
          week_start: w.start,
          week_end: w.end,
          total_earnings: totalGains,
          payroll: payrollData.map(u => ({
            matricule: u.matricule,
            nom_steam: u.nom_steam,
            reports: u.reports,
            total_reports: u.total_reports,
            total_pct: u.total_pct,
            pay: u.pay
          })),
          status: 'finalized',
          finalized_at: new Date().toISOString(),
          finalized_by: currentUser?.matricule || ''
        };
        try {
          const saved = await addPayrollArchive(archive);
          allArchives.unshift(saved);
          showAlert('‚úì Payes finalis√©es et archiv√©es !', 'success');
          renderArchives();
        } catch(e) { showAlert('‚úó Erreur: ' + e.message, 'error'); }
      };

      // ===== ARCHIVES =====
      function renderArchives() {
        const container = document.getElementById('archivesContainer');
        document.getElementById('archiveCountLabel').textContent = allArchives.length + ' SEMAINE' + (allArchives.length > 1 ? 'S' : '');
        if (!allArchives.length) {
          container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:1rem;">Aucune archive disponible</p>';
          return;
        }
        container.innerHTML = allArchives.sort((a,b) => (b.week_end||'').localeCompare(a.week_end||'')).map(arch => {
          const payroll = arch.payroll || [];
          const rows = payroll.sort((a,b) => b.pay - a.pay).map(u => `<tr>
            <td>${u.matricule}</td>
            <td style="font-size:0.75rem;">${u.nom_steam || '-'}</td>
            <td>${u.total_reports}</td>
            <td>${u.total_pct.toFixed(1)}%</td>
            <td class="pay-amount">${u.pay.toLocaleString('fr-FR')} T</td>
          </tr>`).join('');
          return `<div class="archive-card">
            <h3>SEMAINE ${fmtDate(arch.week_start)} ‚Äî ${fmtDate(arch.week_end)}</h3>
            <div class="archive-meta">Gains: ${(arch.total_earnings||0).toLocaleString('fr-FR')} T ‚Äî ${payroll.length} unit√©s ‚Äî Finalis√© le ${arch.finalized_at ? new Date(arch.finalized_at).toLocaleString('fr-FR') : '-'} par ${arch.finalized_by || '-'}</div>
            <div style="overflow-x:auto;">
              <table class="payroll-table">
                <thead><tr><th>MATRICULE</th><th>NOM</th><th>RAPPORTS</th><th>%</th><th>PAYE</th></tr></thead>
                <tbody>${rows || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">Vide</td></tr>'}</tbody>
              </table>
            </div>
          </div>`;
        }).join('');

        // Montrer la derni√®re paye finalis√©e sur l'onglet payes
        renderLastArchived();
      }

      function renderLastArchived() {
        const container = document.getElementById('lastArchivedPay');
        // Trouver l'archive de la semaine pr√©c√©dente (ou celle qui est encore visible)
        const now = new Date();
        const lastWeek = getWeekBounds(new Date(now.getTime() - 7 * 86400000));
        const currentWeek = getWeekBounds();
        // Chercher une archive dont la semaine est termin√©e mais encore consultable
        const recentArchive = allArchives.find(a => a.week_end >= lastWeek.start && a.week_end < currentWeek.start);
        if (!recentArchive) {
          container.innerHTML = '';
          return;
        }
        const payroll = recentArchive.payroll || [];
        const rows = payroll.sort((a,b) => b.pay - a.pay).map(u => `<tr>
          <td>${u.matricule}</td>
          <td style="font-size:0.75rem;">${u.nom_steam || '-'}</td>
          <td>${u.total_reports}</td>
          <td>${u.total_pct.toFixed(1)}%</td>
          <td class="pay-amount">${u.pay.toLocaleString('fr-FR')} T</td>
        </tr>`).join('');
        container.innerHTML = `<div class="combine-terminal-wrapper" style="border-color:rgba(0,204,102,0.15);">
          <div class="combine-header" style="border-color:rgba(0,204,102,0.1);">
            <h2 style="color:var(--accent-green);">DERNI√àRE PAYE ‚Äî ${fmtDate(recentArchive.week_start)} au ${fmtDate(recentArchive.week_end)}</h2>
            <span class="header-code" style="color:var(--accent-green);">ARCHIV√âE</span>
          </div>
          <div class="combine-body">
            <div class="archive-meta" style="margin-bottom:0.5rem;">Gains: ${(recentArchive.total_earnings||0).toLocaleString('fr-FR')} T ‚Äî ${payroll.length} unit√©s</div>
            <div style="overflow-x:auto;">
              <table class="payroll-table"><thead><tr><th>MATRICULE</th><th>NOM</th><th>RAPPORTS</th><th>%</th><th>PAYE</th></tr></thead>
              <tbody>${rows}</tbody></table>
            </div>
          </div>
        </div>`;
      }

      // ===== INIT =====
      onAuthStateChanged(auth, async(user) => {
        if(!user){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
        try {
          const s = await getDoc(doc(db,'users',user.uid));
          if(!s.exists()||!s.data().approved){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
          const ud = s.data();
          currentUser = { matricule: ud.matricule||'???', nom_steam: ud.nom_steam||'' };
          let units = []; try { units = await loadUnits(); } catch(_){}
          allUnits = units;
          const ui = units.find(x => x.matricule === currentUser.matricule);
          const rg = ui?(ui.rang||''):'';
          isHG = rg === 'Ofc' || rg === 'Cmd';

          if (isHG) {
            document.getElementById('tabConfig').style.display = '';
            document.getElementById('hgPayActions').style.display = '';
            document.getElementById('hgPayActions').classList.add('visible');
            document.getElementById('hgGainsForm').style.display = '';
            document.getElementById('hgGainsForm').classList.add('visible');
          }

          document.getElementById('loading').style.display='none';
          document.getElementById('mainContent').style.display='block';

          // Charger les donn√©es
          try { allReports = await loadReports(); } catch(_) { allReports = []; }
          try { payrollConfig = await loadPayrollConfig(); } catch(_) { payrollConfig = { report_values: {} }; }
          try { allEarnings = await loadEarnings(); } catch(_) { allEarnings = []; }
          try { allArchives = await loadPayrollArchives(); } catch(_) { allArchives = []; }

          renderConfig();
          renderEarnings();
          calculatePayroll();
          renderArchives();
        } catch(e) { console.error(e); document.getElementById('loading').style.display='none'; document.getElementById('access-denied').style.display='block'; }
      });
    </script>
</body>
</html>
