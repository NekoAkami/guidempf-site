<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des Rapports - MPF</title>
    <link rel="stylesheet" href="assets/css/main-style.css">
    <link rel="stylesheet" href="assets/css/combine-terminals.css">
    <link rel="stylesheet" href="assets/css/global-nav.css">
    <link rel="stylesheet" href="assets/css/interactive-system.css">
    <link rel="stylesheet" href="assets/css/combine-animations.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        .rapports-wrapper { max-width: 1100px; margin: 0 auto; }
        .search-filter-bar {
            display: flex; gap: 0.8rem; align-items: center; flex-wrap: wrap;
            margin-bottom: 1.2rem; padding: 0.8rem;
            background: rgba(0, 170, 255, 0.03);
            border: 1px solid rgba(0, 170, 255, 0.1);
            border-radius: 4px;
        }
        .search-filter-bar input, .search-filter-bar select {
            padding: 0.45rem 0.7rem;
            background: rgba(0, 170, 255, 0.04);
            border: 1px solid rgba(0, 170, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
            outline: none; border-radius: 2px;
        }
        .search-filter-bar input:focus, .search-filter-bar select:focus {
            border-color: var(--accent-cyan);
        }
        .search-filter-bar input { flex: 1; min-width: 200px; }
        .search-filter-bar select { cursor: pointer; min-width: 140px; }
        .search-filter-bar select option { background: #0a1628; color: var(--text-primary); }
        .search-filter-bar label {
            font-family: 'Share Tech Mono', monospace; font-size: 0.7rem;
            color: var(--text-muted); letter-spacing: 1px;
        }

        .rapports-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .rapports-table th {
            text-align: left; padding: 0.5rem 0.4rem;
            color: var(--accent-cyan); font-family: 'Share Tech Mono', monospace;
            font-size: 0.68rem; letter-spacing: 1px;
            border-bottom: 2px solid rgba(0, 170, 255, 0.2);
            cursor: pointer; user-select: none;
        }
        .rapports-table th:hover { color: #fff; }
        .rapports-table th .sort-icon { font-size: 0.6rem; margin-left: 0.3rem; }
        .rapports-table td {
            padding: 0.4rem; color: var(--text-primary);
            border-bottom: 1px solid rgba(0, 170, 255, 0.06);
            vertical-align: middle; font-family: 'Share Tech Mono', monospace;
        }
        .rapports-table tr:hover { background: rgba(0, 170, 255, 0.03); }
        .rapports-table tr.divisionnaire { border-left: 3px solid var(--accent-purple); }

        .type-badge {
            display: inline-block; padding: 0.1rem 0.4rem; border-radius: 2px;
            font-family: 'Share Tech Mono', monospace; font-size: 0.68rem;
            font-weight: 700; letter-spacing: 0.5px;
            background: rgba(0, 170, 255, 0.15); color: var(--accent-cyan);
            border: 1px solid rgba(0, 170, 255, 0.3);
        }
        .type-badge.div { background: rgba(102, 68, 170, 0.15); color: var(--accent-purple); border-color: rgba(102, 68, 170, 0.3); }

        .pagination {
            display: flex; gap: 0.5rem; justify-content: center; align-items: center;
            margin-top: 1rem; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
        }
        .pagination button {
            padding: 0.3rem 0.7rem;
            background: rgba(0, 170, 255, 0.08);
            border: 1px solid rgba(0, 170, 255, 0.3);
            color: var(--accent-cyan); cursor: pointer;
            font-family: 'Share Tech Mono', monospace; font-size: 0.75rem;
            border-radius: 2px; transition: all 0.15s;
        }
        .pagination button:hover { background: rgba(0, 170, 255, 0.2); }
        .pagination button:disabled { opacity: 0.3; cursor: not-allowed; }
        .pagination button.active { background: rgba(0, 170, 255, 0.25); border-color: var(--accent-cyan); font-weight: 700; }
        .pagination .page-info { color: var(--text-muted); }

        .stat-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem; margin-bottom: 1.2rem;
        }
        .stat-card {
            padding: 0.8rem; text-align: center;
            background: rgba(0, 170, 255, 0.03);
            border: 1px solid rgba(0, 170, 255, 0.1);
            border-radius: 4px;
        }
        .stat-card .stat-number {
            font-family: 'Orbitron', sans-serif; font-size: 1.3rem;
            color: var(--accent-cyan); font-weight: 700;
        }
        .stat-card .stat-label {
            font-family: 'Share Tech Mono', monospace; font-size: 0.65rem;
            color: var(--text-muted); letter-spacing: 1px; margin-top: 0.2rem;
        }

        .btn-action {
            padding: 0.5rem 1.2rem; font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem; cursor: pointer;
            border: 1px solid rgba(0, 170, 255, 0.4);
            background: rgba(0, 170, 255, 0.1); color: var(--accent-cyan);
            border-radius: 3px; transition: all 0.15s; letter-spacing: 0.5px;
            text-decoration: none; display: inline-block;
        }
        .btn-action:hover { background: rgba(0, 170, 255, 0.2); border-color: var(--accent-cyan); }
        .btn-action.purple { border-color: rgba(102, 68, 170, 0.4); background: rgba(102, 68, 170, 0.1); color: var(--accent-purple); }
        .btn-action.purple:hover { background: rgba(102, 68, 170, 0.2); border-color: var(--accent-purple); }

        .hg-actions { display: none; gap: 0.8rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .hg-actions.visible { display: flex; }

        .report-detail-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.75); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .report-detail-box {
            background: #0a1628; border: 1px solid rgba(0, 170, 255, 0.3);
            padding: 1.5rem; border-radius: 6px; max-width: 600px; width: 90%;
            max-height: 80vh; overflow-y: auto;
        }
        .report-detail-box h3 {
            color: var(--accent-cyan); font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem; margin-bottom: 1rem;
        }
        .report-detail-box .detail-row {
            display: flex; gap: 0.5rem; margin-bottom: 0.5rem;
            font-family: 'Share Tech Mono', monospace; font-size: 0.82rem;
        }
        .report-detail-box .detail-label { color: var(--text-muted); min-width: 120px; }
        .report-detail-box .detail-value { color: var(--text-primary); flex: 1; }
        .report-detail-box .close-btn {
            margin-top: 1rem; padding: 0.4rem 1rem;
            border: 1px solid rgba(0, 170, 255, 0.3);
            background: rgba(0, 170, 255, 0.08); color: var(--accent-cyan);
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
            cursor: pointer; border-radius: 3px; display: block; margin-left: auto;
        }
        .report-detail-box .close-btn:hover { background: rgba(0, 170, 255, 0.15); }

        #access-denied, #notApproved { display: none; text-align: center; padding: 3rem; }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>

    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div>
                        <h1 class="logo">MPF</h1>
                        <p class="logo-subtitle">Liste des Rapports</p>
                    </div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;">
                <p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p>
            </div>
            <div id="access-denied">
                <h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">CONNEXION REQUISE</h2>
                <p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.5rem;">Vous devez être connecté pour consulter les rapports.</p>
                <a href="login.html" style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;display:inline-block;margin-top:1rem;">→ SE CONNECTER</a>
            </div>
            <div id="notApproved">
                <h2 style="color:#ffaa00;font-family:'Orbitron',sans-serif;">EN ATTENTE D'APPROBATION</h2>
            </div>

            <div id="mainContent" style="display:none;">
                <div class="rapports-wrapper">

                    <!-- Stats -->
                    <div class="stat-cards" id="statCards">
                        <div class="stat-card"><div class="stat-number" id="statTotal">0</div><div class="stat-label">TOTAL RAPPORTS</div></div>
                        <div class="stat-card"><div class="stat-number" id="statSemaine">0</div><div class="stat-label">CETTE SEMAINE</div></div>
                        <div class="stat-card"><div class="stat-number" id="statUnites">0</div><div class="stat-label">RAPPORTS UNITÉ</div></div>
                        <div class="stat-card"><div class="stat-number" id="statDiv">0</div><div class="stat-label">RAP. DIVISIONNAIRES</div></div>
                    </div>

                    <!-- Actions HG -->
                    <div class="hg-actions" id="hgActions">
                        <a href="rapports-divisionnaires.html" class="btn-action purple">⟩ RAPPORTS DIVISIONNAIRES</a>
                        <a href="activite-milice.html" class="btn-action">⟩ ACTIVITÉ MILICE</a>
                        <a href="payes.html" class="btn-action">⟩ PAYES</a>
                    </div>

                    <!-- Recherche et filtres -->
                    <div class="combine-terminal-wrapper animate-fadeInUp">
                        <div class="combine-header">
                            <h2>REGISTRE DES RAPPORTS</h2>
                            <span class="header-code" id="reportCountLabel">0 RAPPORTS</span>
                        </div>
                        <div class="combine-body">
                            <div class="search-filter-bar">
                                <input type="text" id="searchInput" placeholder="Rechercher (matricule, nom, type, résumé...)" oninput="applyFilters()">
                                <select id="filterType" onchange="applyFilters()">
                                    <option value="">Tous types</option>
                                    <option value="Patrouille">Patrouille</option>
                                    <option value="Opération">Opération</option>
                                    <option value="Fouille">Fouille</option>
                                    <option value="Point Passage">Point Passage</option>
                                    <option value="Protection VIP">Protection VIP</option>
                                    <option value="Distribution ration">Distribution ration</option>
                                    <option value="Formation">Formation</option>
                                    <option value="Conscription">Conscription</option>
                                    <option value="Session de travail">Session de travail</option>
                                    <option value="Déblayage">Déblayage</option>
                                    <option value="Interrogatoire">Interrogatoire</option>
                                    <option value="Test de loyauté">Test de loyauté</option>
                                    <option value="Autre">Autre</option>
                                </select>
                                <select id="filterPeriod" onchange="applyFilters()">
                                    <option value="">Toutes périodes</option>
                                    <option value="today">Aujourd'hui</option>
                                    <option value="week">Cette semaine</option>
                                    <option value="month">Ce mois</option>
                                </select>
                                <select id="filterRapportType" onchange="applyFilters()">
                                    <option value="">Tous</option>
                                    <option value="unite">Rapport Unité</option>
                                    <option value="divisionnaire">Rapport Divisionnaire</option>
                                </select>
                            </div>

                            <div style="overflow-x:auto;">
                                <table class="rapports-table">
                                    <thead>
                                        <tr>
                                            <th onclick="sortBy('created_at')">DATE <span class="sort-icon" id="sort-created_at">▼</span></th>
                                            <th onclick="sortBy('matricule')">MATRICULE <span class="sort-icon" id="sort-matricule"></span></th>
                                            <th onclick="sortBy('nom_steam')">NOM <span class="sort-icon" id="sort-nom_steam"></span></th>
                                            <th onclick="sortBy('type')">TYPE <span class="sort-icon" id="sort-type"></span></th>
                                            <th>CATÉGORIE</th>
                                            <th onclick="sortBy('secteur')">SECTEUR <span class="sort-icon" id="sort-secteur"></span></th>
                                            <th>RÉSUMÉ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportsBody">
                                        <tr><td colspan="7" style="text-align:center;color:var(--text-muted);">Chargement...</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="pagination" id="pagination"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module" src="assets/js/auth.js"></script>
    <script src="assets/js/global-nav.js"></script>
    <script src="assets/js/interactive-system.js"></script>
    <script src="assets/js/combine-animations.js"></script>

    <script type="module">
      import { auth, db } from './assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { loadReports, loadUnits } from './assets/js/github-data.js';

      function getAccreditation(r) {
        if (r === 'RCT') return 'Recrue';
        if (['.05','.04','.03','STB'].includes(r)) return 'MPF';
        if (['.02','.01','DvL','STBE','CABAL'].includes(r)) return 'MPEF';
        if (['Ofc','Cmd'].includes(r)) return 'HautGradé';
        return '';
      }

      let allReports = [], filteredReports = [], currentUser = null, isHG = false;
      let currentPage = 1, perPage = 25;
      let sortField = 'created_at', sortDir = 'desc';

      function fmtDate(d) { if(!d) return '-'; const p=d.split('-'); return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d; }

      function getWeekBounds() {
        const now = new Date();
        const day = now.getDay();
        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(now);
        monday.setDate(diff);
        monday.setHours(0,0,0,0);
        const sunday = new Date(monday);
        sunday.setDate(sunday.getDate() + 6);
        sunday.setHours(23,59,59,999);
        return { start: monday.toISOString().substring(0,10), end: sunday.toISOString().substring(0,10) };
      }

      window.applyFilters = function() {
        const q = (document.getElementById('searchInput').value || '').toLowerCase();
        const filterType = document.getElementById('filterType').value;
        const filterPeriod = document.getElementById('filterPeriod').value;
        const filterRType = document.getElementById('filterRapportType').value;
        const today = new Date().toISOString().substring(0,10);
        const week = getWeekBounds();
        const month = today.substring(0, 7);

        filteredReports = allReports.filter(r => {
          // Visibilité : non-HG ne voient que les rapports unité
          if (!isHG && r.type_rapport === 'divisionnaire') return false;
          // Filtre texte
          if (q) {
            const txt = `${r.matricule} ${r.nom_steam||''} ${r.type||''} ${r.secteur||''} ${r.resume||''} ${r.division||''}`.toLowerCase();
            if (!txt.includes(q)) return false;
          }
          // Filtre type activité
          if (filterType && !(r.type||'').includes(filterType)) return false;
          // Filtre période
          if (filterPeriod === 'today' && r.created_at !== today) return false;
          if (filterPeriod === 'week' && (r.created_at < week.start || r.created_at > week.end)) return false;
          if (filterPeriod === 'month' && !r.created_at?.startsWith(month)) return false;
          // Filtre type rapport
          if (filterRType && (r.type_rapport || 'unite') !== filterRType) return false;
          return true;
        });

        // Tri
        filteredReports.sort((a, b) => {
          const va = (a[sortField] || '').toString().toLowerCase();
          const vb = (b[sortField] || '').toString().toLowerCase();
          return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
        });

        currentPage = 1;
        renderTable();
        updateStats();
      };

      window.sortBy = function(field) {
        if (sortField === field) {
          sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          sortField = field;
          sortDir = 'desc';
        }
        document.querySelectorAll('.sort-icon').forEach(el => el.textContent = '');
        const icon = document.getElementById('sort-' + field);
        if (icon) icon.textContent = sortDir === 'asc' ? '▲' : '▼';
        applyFilters();
      };

      function updateStats() {
        const today = new Date().toISOString().substring(0,10);
        const week = getWeekBounds();
        const visible = isHG ? allReports : allReports.filter(r => r.type_rapport !== 'divisionnaire');
        document.getElementById('statTotal').textContent = visible.length;
        document.getElementById('statSemaine').textContent = visible.filter(r => r.created_at >= week.start && r.created_at <= week.end).length;
        document.getElementById('statUnites').textContent = visible.filter(r => (r.type_rapport || 'unite') === 'unite').length;
        document.getElementById('statDiv').textContent = allReports.filter(r => r.type_rapport === 'divisionnaire').length;
        document.getElementById('reportCountLabel').textContent = filteredReports.length + ' RAPPORT' + (filteredReports.length > 1 ? 'S' : '');
      }

      function renderTable() {
        const start = (currentPage - 1) * perPage;
        const pageReports = filteredReports.slice(start, start + perPage);
        const tb = document.getElementById('reportsBody');
        if (!pageReports.length) {
          tb.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);">Aucun rapport trouvé</td></tr>';
        } else {
          tb.innerHTML = pageReports.map(r => {
            const isDiv = r.type_rapport === 'divisionnaire';
            return `<tr class="${isDiv ? 'divisionnaire' : ''}" style="cursor:pointer;" onclick="showDetail('${r._id}')">
              <td style="font-size:0.75rem;">${fmtDate(r.created_at)}</td>
              <td>${r.matricule || '-'}</td>
              <td style="font-size:0.75rem;">${r.nom_steam || '-'}</td>
              <td><span class="type-badge">${r.type || '-'}</span></td>
              <td><span class="type-badge ${isDiv ? 'div' : ''}">${isDiv ? 'DIV' : 'UNITÉ'}</span></td>
              <td style="font-size:0.75rem;">${r.secteur || '-'}</td>
              <td style="font-size:0.75rem;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(r.resume||'').replace(/"/g,'&quot;')}">${r.resume || '-'}</td>
            </tr>`;
          }).join('');
        }
        renderPagination();
      }

      function renderPagination() {
        const totalPages = Math.ceil(filteredReports.length / perPage) || 1;
        const pag = document.getElementById('pagination');
        let html = `<button onclick="goPage(1)" ${currentPage===1?'disabled':''}>«</button>`;
        html += `<button onclick="goPage(${currentPage-1})" ${currentPage===1?'disabled':''}>‹</button>`;
        const startP = Math.max(1, currentPage - 2);
        const endP = Math.min(totalPages, currentPage + 2);
        for (let i = startP; i <= endP; i++) {
          html += `<button onclick="goPage(${i})" class="${i===currentPage?'active':''}">${i}</button>`;
        }
        html += `<button onclick="goPage(${currentPage+1})" ${currentPage===totalPages?'disabled':''}>›</button>`;
        html += `<button onclick="goPage(${totalPages})" ${currentPage===totalPages?'disabled':''}>»</button>`;
        html += `<span class="page-info">${currentPage}/${totalPages}</span>`;
        pag.innerHTML = html;
      }

      window.goPage = function(p) {
        const totalPages = Math.ceil(filteredReports.length / perPage) || 1;
        currentPage = Math.max(1, Math.min(totalPages, p));
        renderTable();
      };

      window.showDetail = function(id) {
        const r = allReports.find(x => x._id === id);
        if (!r) return;
        const overlay = document.createElement('div');
        overlay.className = 'report-detail-overlay';
        overlay.innerHTML = `<div class="report-detail-box">
          <h3>DÉTAIL DU RAPPORT</h3>
          <div class="detail-row"><span class="detail-label">DATE</span><span class="detail-value">${fmtDate(r.created_at)}</span></div>
          <div class="detail-row"><span class="detail-label">MATRICULE</span><span class="detail-value">${r.matricule || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">NOM</span><span class="detail-value">${r.nom_steam || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">TYPE</span><span class="detail-value">${r.type || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">CATÉGORIE</span><span class="detail-value">${(r.type_rapport||'unite')==='divisionnaire'?'Divisionnaire':'Unité'}</span></div>
          <div class="detail-row"><span class="detail-label">DIVISION</span><span class="detail-value">${r.division || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">SECTEUR</span><span class="detail-value">${r.secteur || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">UNITÉS</span><span class="detail-value">${r.unites || '-'}</span></div>
          <div class="detail-row"><span class="detail-label">RÉSUMÉ</span><span class="detail-value">${r.resume || '-'}</span></div>
          ${r.notes ? `<div class="detail-row"><span class="detail-label">NOTES</span><span class="detail-value">${r.notes}</span></div>` : ''}
          ${r.nb_citoyens !== undefined ? `<div class="detail-row"><span class="detail-label">CITOYENS</span><span class="detail-value">${r.nb_citoyens}</span></div>` : ''}
          <button class="close-btn" onclick="this.closest('.report-detail-overlay').remove()">FERMER</button>
        </div>`;
        document.body.appendChild(overlay);
        overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
      };

      onAuthStateChanged(auth, async(user) => {
        if(!user){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
        try {
          const s = await getDoc(doc(db,'users',user.uid));
          if(!s.exists()){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
          const ud = s.data();
          if(!ud.approved){document.getElementById('loading').style.display='none';document.getElementById('notApproved').style.display='block';return;}

          currentUser = { matricule: ud.matricule||'???', nom_steam: ud.nom_steam||'', division: '' };
          let units = [];
          try { units = await loadUnits(); } catch(_){}
          const ui = units.find(x => x.matricule === currentUser.matricule);
          const rg = ui ? (ui.rang || '') : '';
          isHG = rg === 'Ofc' || rg === 'Cmd';
          currentUser.division = ui ? (ui.division || '') : '';

          if (isHG) document.getElementById('hgActions').classList.add('visible');

          document.getElementById('loading').style.display='none';
          document.getElementById('mainContent').style.display='block';

          try { allReports = await loadReports(); } catch(_) { allReports = []; }
          applyFilters();
        } catch(e) {
          console.error(e);
          document.getElementById('loading').style.display='none';
          document.getElementById('access-denied').style.display='block';
        }
      });
    </script>
</body>
</html>
