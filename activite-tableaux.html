<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Semaine - MPF Documentation</title>
    <link rel="stylesheet" href="assets/css/bundle.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        /* ===== LAYOUT 3 COLONNES ===== */
        .planning-layout{display:flex;gap:0.8rem;align-items:flex-start;max-width:1600px;margin:0 auto;}
        .planning-main{flex:1;min-width:0;}
        .side-panel{width:260px;flex-shrink:0;position:sticky;top:80px;max-height:calc(100vh - 100px);overflow-y:auto;transition:all 0.3s;scrollbar-width:thin;scrollbar-color:rgba(0,170,255,0.2) transparent;}
        .side-panel.collapsed{width:36px;overflow:hidden;}
        .side-panel .panel-header{display:flex;align-items:center;justify-content:space-between;padding:0.5rem 0.6rem;background:rgba(0,170,255,0.08);border-bottom:1px solid rgba(0,170,255,0.2);cursor:pointer;user-select:none;}
        .side-panel .panel-header h3{font-family:'Orbitron',sans-serif;font-size:0.65rem;color:var(--accent-cyan);letter-spacing:1px;margin:0;white-space:nowrap;}
        .side-panel .panel-toggle{font-size:0.7rem;color:var(--accent-cyan);cursor:pointer;opacity:0.7;transition:opacity 0.15s;}
        .side-panel .panel-toggle:hover{opacity:1;}
        .side-panel .panel-body{padding:0.5rem;overflow-y:auto;}
        .side-panel.collapsed .panel-body{display:none;}
        .side-panel.collapsed .panel-header h3{writing-mode:vertical-rl;text-orientation:mixed;font-size:0.6rem;padding:0.3rem 0;}
        .side-panel-border{border:1px solid rgba(0,170,255,0.15);border-radius:4px;background:rgba(0,10,30,0.5);overflow:hidden;}

        /* ===== PLANNING DU JOUR (droite) ===== */
        .today-event{padding:0.4rem 0.5rem;margin-bottom:0.4rem;border-radius:3px;font-family:'Share Tech Mono',monospace;font-size:0.7rem;border-left:3px solid;}
        .today-event .ev-time{font-weight:700;font-size:0.72rem;}
        .today-event .ev-type{opacity:0.8;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.5px;}
        .today-event .ev-desc{color:var(--text-muted);font-size:0.65rem;margin-top:0.1rem;}
        .today-event.type-formation{background:rgba(0,170,255,0.08);border-color:var(--accent-cyan);color:var(--accent-cyan);}
        .today-event.type-test{background:rgba(255,200,0,0.08);border-color:#ffc800;color:#ffc800;}
        .today-event.type-recrutement{background:rgba(0,200,80,0.08);border-color:#00cc55;color:#00cc55;}
        .today-event.type-operation{background:rgba(255,100,60,0.08);border-color:#ff6644;color:#ff6644;}
        .today-event.type-patrouille{background:rgba(100,200,255,0.08);border-color:#64c8ff;color:#64c8ff;}
        .today-event.type-autre{background:rgba(200,100,255,0.08);border-color:#c864ff;color:#c864ff;}
        .no-events{text-align:center;padding:1rem 0.5rem;color:var(--text-muted);font-family:'Share Tech Mono',monospace;font-size:0.7rem;opacity:0.6;}

        /* ===== BLOC-NOTES (gauche) ===== */
        .notepad-textarea{width:100%;min-height:200px;max-height:400px;resize:vertical;background:rgba(0,0,0,0.3);border:1px solid rgba(0,170,255,0.15);color:var(--text-primary);font-family:'Share Tech Mono',monospace;font-size:0.75rem;padding:0.5rem;outline:none;border-radius:2px;line-height:1.5;}
        .notepad-textarea:focus{border-color:rgba(0,170,255,0.4);}
        .notepad-footer{display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0;font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:var(--text-muted);}
        .notepad-clear{padding:0.2rem 0.5rem;background:rgba(255,60,60,0.08);border:1px solid rgba(255,60,60,0.25);color:#ff6666;font-family:'Share Tech Mono',monospace;font-size:0.62rem;cursor:pointer;border-radius:2px;transition:all 0.15s;}
        .notepad-clear:hover{background:rgba(255,60,60,0.2);}

        /* ===== PLANNING GRID ===== */
        .planning-wrapper{max-width:100%;}
        .week-nav{display:flex;align-items:center;justify-content:center;gap:1rem;margin-bottom:1.2rem;font-family:'Orbitron',sans-serif;}
        .week-nav button{padding:0.4rem 0.8rem;background:rgba(0,170,255,0.08);border:1px solid rgba(0,170,255,0.3);color:var(--accent-cyan);cursor:pointer;border-radius:3px;font-family:'Share Tech Mono',monospace;font-size:0.8rem;transition:all 0.15s;}
        .week-nav button:hover{background:rgba(0,170,255,0.2);}
        .week-nav .week-label{font-size:0.9rem;color:var(--accent-cyan);min-width:280px;text-align:center;}
        .planning-grid{display:grid;grid-template-columns:80px repeat(7,1fr);border:1px solid rgba(0,170,255,0.15);border-radius:4px;overflow:hidden;font-family:'Share Tech Mono',monospace;font-size:0.75rem;}
        .planning-grid .day-header{padding:0.5rem 0.3rem;text-align:center;background:rgba(0,170,255,0.08);border-bottom:2px solid rgba(0,170,255,0.2);color:var(--accent-cyan);font-family:'Orbitron',sans-serif;font-size:0.65rem;letter-spacing:1px;font-weight:700;}
        .planning-grid .day-header.today{background:rgba(0,170,255,0.15);color:#fff;}
        .planning-grid .time-header{padding:0.5rem 0.3rem;text-align:center;background:rgba(0,170,255,0.08);border-bottom:2px solid rgba(0,170,255,0.2);color:var(--accent-cyan);font-family:'Orbitron',sans-serif;font-size:0.65rem;letter-spacing:1px;font-weight:700;}
        .planning-grid .time-cell{padding:0.3rem;text-align:center;background:rgba(0,170,255,0.02);border-right:1px solid rgba(0,170,255,0.06);border-bottom:1px solid rgba(0,170,255,0.06);color:var(--text-muted);font-size:0.7rem;display:flex;align-items:center;justify-content:center;}
        .planning-grid .slot-cell{padding:0.2rem;border-right:1px solid rgba(0,170,255,0.06);border-bottom:1px solid rgba(0,170,255,0.06);min-height:38px;cursor:pointer;transition:background 0.1s;position:relative;}
        .slot-cell:hover{background:rgba(0,170,255,0.06);}
        .slot-entry{padding:0.15rem 0.3rem;border-radius:2px;font-size:0.62rem;margin-bottom:1px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.4;}
        .slot-entry.type-formation{background:rgba(0,170,255,0.15);border-left:2px solid var(--accent-cyan);color:var(--accent-cyan);}
        .slot-entry.type-test{background:rgba(255,200,0,0.15);border-left:2px solid #ffc800;color:#ffc800;}
        .slot-entry.type-recrutement{background:rgba(0,200,80,0.15);border-left:2px solid #00cc55;color:#00cc55;}
        .slot-entry.type-autre{background:rgba(200,100,255,0.15);border-left:2px solid #c864ff;color:#c864ff;}
        .slot-entry.type-operation{background:rgba(255,100,60,0.15);border-left:2px solid #ff6644;color:#ff6644;}
        .slot-entry.type-patrouille{background:rgba(100,200,255,0.15);border-left:2px solid #64c8ff;color:#64c8ff;}
        /* Multi-slot entries spanning multiple rows */
        .slot-entry.multi-slot{position:relative;}
        .slot-add{position:absolute;top:0;right:0;width:14px;height:14px;background:rgba(0,170,255,0.15);border:1px solid rgba(0,170,255,0.3);border-radius:2px;color:var(--accent-cyan);display:none;align-items:center;justify-content:center;font-size:0.6rem;cursor:pointer;z-index:2;}
        .slot-cell:hover .slot-add{display:flex;}
        .legend{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;font-family:'Share Tech Mono',monospace;font-size:0.7rem;}
        .legend-item{display:flex;align-items:center;gap:0.3rem;}
        .legend-dot{width:10px;height:10px;border-radius:2px;}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);z-index:1000;display:flex;align-items:center;justify-content:center;}
        .modal-box{background:#0a1628;border:1px solid rgba(0,170,255,0.3);padding:1.5rem;border-radius:6px;max-width:450px;width:90%;}
        .modal-box h3{color:var(--accent-cyan);font-family:'Orbitron',sans-serif;font-size:0.85rem;margin-bottom:1rem;}
        .modal-box .form-group{margin-bottom:0.8rem;}
        .modal-box .form-group label{display:block;font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:var(--text-muted);letter-spacing:1px;margin-bottom:0.2rem;}
        .modal-box .form-group input,.modal-box .form-group select,.modal-box .form-group textarea{width:100%;padding:0.4rem 0.6rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.2);color:var(--text-primary);font-family:'Share Tech Mono',monospace;font-size:0.8rem;outline:none;border-radius:2px;box-sizing:border-box;}
        .modal-box .form-group select option{background:#0a1628;}
        .modal-box .form-group .time-range{display:flex;gap:0.5rem;align-items:center;}
        .modal-box .form-group .time-range span{color:var(--text-muted);font-family:'Share Tech Mono',monospace;font-size:0.75rem;}
        .modal-box .form-group .time-range select{width:auto;flex:1;}
        .modal-box .modal-actions{display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1rem;}
        .modal-box .modal-actions button{padding:0.4rem 1rem;font-family:'Share Tech Mono',monospace;font-size:0.78rem;cursor:pointer;border-radius:3px;transition:all 0.15s;}
        .btn-cancel{border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:#fff;}
        .btn-save{border:1px solid rgba(0,170,255,0.4);background:rgba(0,170,255,0.15);color:var(--accent-cyan);font-weight:700;}
        .btn-save:hover{background:rgba(0,170,255,0.3);}
        .btn-delete{border:1px solid rgba(255,68,68,0.4);background:rgba(255,68,68,0.08);color:#ff6666;}
        .btn-delete:hover{background:rgba(255,68,68,0.15);}
        .alert-msg{padding:0.6rem 1rem;border-radius:3px;margin-bottom:1rem;font-size:0.8rem;font-family:'Share Tech Mono',monospace;display:none;}
        .alert-msg.success{display:block;background:rgba(0,200,80,0.08);border:1px solid rgba(0,200,80,0.3);color:#00cc55;}
        .alert-msg.error{display:block;background:rgba(255,60,60,0.1);border:1px solid rgba(255,60,60,0.3);color:#ff4444;}
        .sync-indicator{position:fixed;bottom:1rem;right:1rem;padding:0.4rem 0.8rem;border-radius:3px;font-family:'Share Tech Mono',monospace;font-size:0.72rem;z-index:999;transition:all 0.3s;pointer-events:none;opacity:0;}
        .sync-indicator.syncing{opacity:1;background:rgba(255,200,0,0.15);border:1px solid rgba(255,200,0,0.4);color:#ffc800;}
        .sync-indicator.synced{opacity:1;background:rgba(0,200,80,0.15);border:1px solid rgba(0,200,80,0.4);color:#00cc55;}
        .sync-indicator.error{opacity:1;background:rgba(255,60,60,0.15);border:1px solid rgba(255,60,60,0.4);color:#ff4444;}
        .sync-indicator.hidden{opacity:0;}
        #access-denied,#notApproved{display:none;text-align:center;padding:3rem;}
        @media(max-width:1100px){.side-panel{width:220px;}.planning-layout{flex-wrap:wrap;}.side-panel{width:100%;position:static;max-height:none;}.side-panel.collapsed{width:100%;}.side-panel.collapsed .panel-header h3{writing-mode:horizontal-tb;}}
        @media(max-width:900px){.planning-grid{font-size:0.6rem;}.planning-grid .day-header,.planning-grid .time-header{font-size:0.55rem;}.slot-entry{font-size:0.55rem;}}
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div><h1 class="logo">MPF</h1><p class="logo-subtitle">Planning Hebdomadaire</p></div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;"><p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p></div>
            <div id="access-denied"><h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">CONNEXION REQUISE</h2><a href="login.html" style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;display:inline-block;margin-top:1rem;">‚Üí SE CONNECTER</a></div>
            <div id="notApproved"><h2 style="color:#ffaa00;font-family:'Orbitron',sans-serif;">EN ATTENTE D'APPROBATION</h2></div>
            <div id="mainContent" style="display:none;">

                <div class="planning-layout">
                    <!-- BLOC-NOTES PERSONNEL (gauche) -->
                    <div class="side-panel side-panel-border" id="notepadPanel">
                        <div class="panel-header" onclick="togglePanel('notepadPanel')">
                            <h3>üìù BLOC-NOTES</h3>
                            <span class="panel-toggle" id="notepadToggle">‚óÑ</span>
                        </div>
                        <div class="panel-body">
                            <textarea class="notepad-textarea" id="notepadText" placeholder="Notes personnelles...&#10;Sauvegard√© automatiquement."></textarea>
                            <div class="notepad-footer">
                                <span id="notepadStatus">Sauvegard√©</span>
                                <button class="notepad-clear" onclick="clearNotepad()">üóë TOUT SUPPRIMER</button>
                            </div>
                        </div>
                    </div>

                    <!-- PLANNING PRINCIPAL (centre) -->
                    <div class="planning-main">
                        <div class="planning-wrapper">
                            <div id="alertMsg" class="alert-msg"></div>
                            <div class="week-nav">
                                <button onclick="changeWeek(-1)">‚óÑ SEMAINE PR√âC.</button>
                                <span class="week-label" id="weekLabel">---</span>
                                <button onclick="changeWeek(1)">SEMAINE SUIV. ‚ñ∫</button>
                            </div>
                            <div class="legend">
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(0,170,255,0.4);"></div><span>Formation</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(255,200,0,0.4);"></div><span>Test</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(0,200,80,0.4);"></div><span>Recrutement</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(255,100,60,0.4);"></div><span>Op√©ration</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(100,200,255,0.4);"></div><span>Patrouille</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(200,100,255,0.4);"></div><span>Autre</span></div>
                            </div>
                            <div class="combine-terminal-wrapper animate-fadeInUp">
                                <div class="combine-header"><h2>üìÖ PLANNING DE LA SEMAINE</h2><span class="header-code" id="entryCount">0 ENTR√âES</span></div>
                                <div class="combine-body" style="padding:0;overflow-x:auto;">
                                    <div class="planning-grid" id="planningGrid"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PLANNING DU JOUR (droite) -->
                    <div class="side-panel side-panel-border" id="todayPanel">
                        <div class="panel-header" onclick="togglePanel('todayPanel')">
                            <h3>üìã PLANNING DU JOUR</h3>
                            <span class="panel-toggle" id="todayToggle">‚ñ∫</span>
                        </div>
                        <div class="panel-body" id="todayBody">
                            <div id="todayEvents"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>
    <script type="module" src="assets/js/auth.js"></script>
    <script src="assets/js/global-nav.js" defer></script>
    <script src="assets/js/interactive-system.js" defer></script>
    <script src="assets/js/combine-animations.js" defer></script>
    <script type="module">
      import { auth, db } from './assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { loadUnits, loadPlanning, addPlanningEntry, updatePlanningEntry, deletePlanningEntry, onSyncStatus } from './assets/js/github-data.js';

      let currentUser=null, isHG=false, canEdit=false, userMatricule='';
      let allEntries=[], weekOffset=0;
      const DAYS=['LUN','MAR','MER','JEU','VEN','SAM','DIM'];
      // Cr√©neaux de 14h √† 00h (minuit)
      const SLOTS=['14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30','18:00','18:30','19:00','19:30','20:00','20:30','21:00','21:30','22:00','22:30','23:00','23:30','00:00'];
      const TYPES=['Formation','Test','Recrutement','Op√©ration','Patrouille','Autre'];

      function showAlert(t,type='success'){const e=document.getElementById('alertMsg');e.style.display='block';e.className='alert-msg '+type;e.textContent=t;setTimeout(()=>e.style.display='none',5000);}
      function fmtDate(d){if(!d)return'-';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d;}

      // Sync indicator
      {const i=document.createElement('div');i.id='syncIndicator';i.className='sync-indicator hidden';document.body.appendChild(i);let t=null;onSyncStatus(s=>{clearTimeout(t);if(s==='syncing'){i.innerHTML='<span style="display:inline-block;animation:spin 1s linear infinite;">‚ü≥</span> Sync...';i.className='sync-indicator syncing';}else if(s==='synced'){i.innerHTML='‚úì Sync';i.className='sync-indicator synced';t=setTimeout(()=>i.className='sync-indicator hidden',2500);}else{i.innerHTML='‚ö† Erreur';i.className='sync-indicator error';t=setTimeout(()=>i.className='sync-indicator hidden',6000);}});}

      // ===== WEEK HELPERS =====
      function getWeekDates(offset=0){
        const now=new Date();now.setDate(now.getDate()+offset*7);
        const day=now.getDay();const diff=now.getDate()-day+(day===0?-6:1);
        const mon=new Date(now);mon.setDate(diff);mon.setHours(0,0,0,0);
        const dates=[];for(let i=0;i<7;i++){const d=new Date(mon);d.setDate(mon.getDate()+i);dates.push(d.toISOString().substring(0,10));}
        return dates;
      }

      function getTypeClass(type){
        const t=(type||'').toLowerCase();
        if(t.includes('formation'))return'type-formation';
        if(t.includes('test'))return'type-test';
        if(t.includes('recrutement'))return'type-recrutement';
        if(t.includes('op√©ration')||t.includes('operation'))return'type-operation';
        if(t.includes('patrouille'))return'type-patrouille';
        return'type-autre';
      }

      // Compare slot times: returns true if slotA <= slotB
      function slotLte(a,b){
        const toMin=s=>{const[h,m]=s.split(':').map(Number);return(h===0?24:h)*60+m;};
        return toMin(a)<=toMin(b);
      }
      function slotInRange(slot, from, to){
        const toMin=s=>{const[h,m]=s.split(':').map(Number);return(h===0?24:h)*60+m;};
        const sv=toMin(slot),fv=toMin(from),tv=toMin(to);
        return sv>=fv&&sv<tv; // slot is within [from, to)
      }

      // ===== RENDER PLANNING GRID =====
      function renderPlanning(){
        const dates=getWeekDates(weekOffset);
        const today=new Date().toISOString().substring(0,10);
        document.getElementById('weekLabel').textContent=fmtDate(dates[0])+' ‚Äî '+fmtDate(dates[6]);

        const weekEntries=allEntries.filter(e=>dates.includes(e.date));
        document.getElementById('entryCount').textContent=weekEntries.length+' ENTR√âE'+(weekEntries.length>1?'S':'');

        const grid=document.getElementById('planningGrid');
        let html='<div class="time-header">HEURE</div>';
        DAYS.forEach((d,i)=>{html+=`<div class="day-header${dates[i]===today?' today':''}">${d}<br><span style="font-size:0.55rem;opacity:0.7;">${dates[i].substring(8)}</span></div>`;});

        SLOTS.forEach(slot=>{
          html+=`<div class="time-cell">${slot}</div>`;
          dates.forEach((date,di)=>{
            // Show entries that START at this slot OR span across this slot
            const cellEntries=weekEntries.filter(e=>{
              if(e.date!==date)return false;
              if(!e.slot_end||e.slot_end===e.slot){
                return e.slot===slot; // single slot
              }
              return slotInRange(slot,e.slot,e.slot_end);
            });
            // For multi-slot, only show the label on the first slot
            const visibleEntries=cellEntries.filter(e=>{
              if(!e.slot_end||e.slot_end===e.slot)return true;
              return e.slot===slot;
            });
            const bgEntries=cellEntries.filter(e=>e.slot_end&&e.slot_end!==e.slot&&e.slot!==slot);
            const bgClass=bgEntries.length>0?` style="background:${getBgForType(bgEntries[0].type)}"`:'';
            const entriesHtml=visibleEntries.map(e=>{
              const span=e.slot_end&&e.slot_end!==e.slot?` [${e.slot}‚Üí${e.slot_end}]`:'';
              return`<div class="slot-entry ${getTypeClass(e.type)}" onclick="event.stopPropagation();showEntryDetail('${e._id}')" title="${e.type}${span} ‚Äî ${e.description||''} (${e.matricule})">${e.type.substring(0,4)} ${e.matricule||''}${span?'‚Ä¶':''}</div>`;
            }).join('');
            const addBtn=canEdit?`<div class="slot-add" onclick="event.stopPropagation();openAddModal('${date}','${slot}')">+</div>`:'';
            html+=`<div class="slot-cell"${bgClass} onclick="openAddModal('${date}','${slot}')">${entriesHtml}${addBtn}</div>`;
          });
        });
        grid.innerHTML=html;
        renderTodayPanel();
      }

      function getBgForType(type){
        const t=(type||'').toLowerCase();
        if(t.includes('formation'))return'rgba(0,170,255,0.04)';
        if(t.includes('test'))return'rgba(255,200,0,0.04)';
        if(t.includes('recrutement'))return'rgba(0,200,80,0.04)';
        if(t.includes('op√©ration')||t.includes('operation'))return'rgba(255,100,60,0.04)';
        if(t.includes('patrouille'))return'rgba(100,200,255,0.04)';
        return'rgba(200,100,255,0.04)';
      }

      // ===== PLANNING DU JOUR (panneau droit) =====
      function renderTodayPanel(){
        const today=new Date().toISOString().substring(0,10);
        const todayEntries=allEntries.filter(e=>e.date===today);
        // Sort by slot start time
        todayEntries.sort((a,b)=>{
          const toMin=s=>{const[h,m]=s.split(':').map(Number);return(h===0?24:h)*60+m;};
          return toMin(a.slot)-toMin(b.slot);
        });
        const container=document.getElementById('todayEvents');
        if(todayEntries.length===0){
          container.innerHTML='<div class="no-events">Aucun √©v√©nement pr√©vu aujourd\'hui</div>';
          return;
        }
        container.innerHTML=todayEntries.map(e=>{
          const timeLabel=e.slot_end&&e.slot_end!==e.slot?`${e.slot} ‚Üí ${e.slot_end}`:e.slot;
          return`<div class="today-event ${getTypeClass(e.type)}" onclick="showEntryDetail('${e._id}')" style="cursor:pointer;">
            <div class="ev-time">${timeLabel}</div>
            <div class="ev-type">${e.type}</div>
            ${e.description?`<div class="ev-desc">${e.description}</div>`:''}
            <div class="ev-desc">Par: ${e.matricule||'?'}</div>
          </div>`;
        }).join('');
      }

      // ===== PANELS TOGGLE =====
      window.togglePanel=function(id){
        const panel=document.getElementById(id);
        panel.classList.toggle('collapsed');
        const toggleIcon=panel.querySelector('.panel-toggle');
        if(id==='notepadPanel'){
          toggleIcon.textContent=panel.classList.contains('collapsed')?'‚ñ∫':'‚óÑ';
          localStorage.setItem('mpf_notepad_collapsed',panel.classList.contains('collapsed')?'1':'0');
        } else {
          toggleIcon.textContent=panel.classList.contains('collapsed')?'‚óÑ':'‚ñ∫';
          localStorage.setItem('mpf_today_collapsed',panel.classList.contains('collapsed')?'1':'0');
        }
      };

      // ===== BLOC-NOTES PERSONNEL (localStorage) =====
      function initNotepad(){
        const textarea=document.getElementById('notepadText');
        const saved=localStorage.getItem('mpf_notepad_content')||'';
        textarea.value=saved;
        let saveTimeout=null;
        textarea.addEventListener('input',()=>{
          clearTimeout(saveTimeout);
          document.getElementById('notepadStatus').textContent='Enregistrement...';
          saveTimeout=setTimeout(()=>{
            localStorage.setItem('mpf_notepad_content',textarea.value);
            document.getElementById('notepadStatus').textContent='Sauvegard√© ‚úì';
          },500);
        });
        // Restore panel states
        if(localStorage.getItem('mpf_notepad_collapsed')==='1'){
          document.getElementById('notepadPanel').classList.add('collapsed');
          document.getElementById('notepadToggle').textContent='‚ñ∫';
        }
        if(localStorage.getItem('mpf_today_collapsed')==='1'){
          document.getElementById('todayPanel').classList.add('collapsed');
          document.getElementById('todayToggle').textContent='‚óÑ';
        }
      }

      window.clearNotepad=function(){
        if(!confirm('Supprimer toutes les notes ?\nCette action est irr√©versible.'))return;
        document.getElementById('notepadText').value='';
        localStorage.removeItem('mpf_notepad_content');
        document.getElementById('notepadStatus').textContent='Notes supprim√©es';
      };

      // ===== WEEK NAVIGATION =====
      window.changeWeek=function(dir){weekOffset+=dir;renderPlanning();};

      // ===== ADD ENTRY MODAL (with time range) =====
      window.openAddModal=function(date,slot){
        if(!canEdit){return;}
        // Build slot options
        const slotOpts=SLOTS.map(s=>`<option value="${s}"${s===slot?' selected':''}>${s}</option>`).join('');
        // Default end slot = next slot
        const sIdx=SLOTS.indexOf(slot);
        const defaultEnd=sIdx<SLOTS.length-1?SLOTS[sIdx+1]:SLOTS[SLOTS.length-1];
        const endOpts=SLOTS.map(s=>`<option value="${s}"${s===defaultEnd?' selected':''}>${s}</option>`).join('');

        const o=document.createElement('div');o.className='modal-overlay';
        o.innerHTML=`<div class="modal-box">
          <h3>AJOUTER UNE ENTR√âE</h3>
          <div class="form-group"><label>DATE</label><input type="date" id="mDate" value="${date}"></div>
          <div class="form-group">
            <label>CR√âNEAU HORAIRE</label>
            <div class="time-range">
              <select id="mSlotStart">${slotOpts}</select>
              <span>‚Üí</span>
              <select id="mSlotEnd">${endOpts}</select>
            </div>
          </div>
          <div class="form-group"><label>TYPE</label><select id="mType">${TYPES.map(t=>`<option value="${t}">${t}</option>`).join('')}</select></div>
          <div class="form-group"><label>DESCRIPTION</label><input type="text" id="mDesc" placeholder="D√©tails (optionnel)"></div>
          <div class="modal-actions">
            <button class="btn-cancel" onclick="this.closest('.modal-overlay').remove()">ANNULER</button>
            <button class="btn-save" onclick="saveEntry()">AJOUTER</button>
          </div>
        </div>`;
        document.body.appendChild(o);
        o.addEventListener('click',e=>{if(e.target===o)o.remove();});

        // Auto-adjust end slot when start changes
        document.getElementById('mSlotStart').addEventListener('change',function(){
          const startIdx=SLOTS.indexOf(this.value);
          const endSel=document.getElementById('mSlotEnd');
          const endIdx=SLOTS.indexOf(endSel.value);
          if(startIdx>=endIdx&&startIdx<SLOTS.length-1){
            endSel.value=SLOTS[startIdx+1];
          }
        });
      };

      window.saveEntry=async function(){
        const date=document.getElementById('mDate').value;
        const slotStart=document.getElementById('mSlotStart').value;
        const slotEnd=document.getElementById('mSlotEnd').value;
        const type=document.getElementById('mType').value;
        const desc=document.getElementById('mDesc').value.trim();
        if(!date||!slotStart||!type){showAlert('Champs requis','error');return;}
        // Validate: end must be after start
        const toMin=s=>{const[h,m]=s.split(':').map(Number);return(h===0?24:h)*60+m;};
        if(toMin(slotEnd)<=toMin(slotStart)){showAlert('L\'heure de fin doit √™tre apr√®s l\'heure de d√©but','error');return;}
        const entry={date,slot:slotStart,slot_end:slotEnd,type,description:desc,matricule:userMatricule,created_at:new Date().toISOString().substring(0,10)};
        try{const saved=await addPlanningEntry(entry);allEntries.push(saved);document.querySelector('.modal-overlay')?.remove();showAlert('‚úì Entr√©e ajout√©e');renderPlanning();}catch(e){showAlert('‚úó '+e.message,'error');}
      };

      // ===== ENTRY DETAIL MODAL =====
      window.showEntryDetail=function(id){
        const e=allEntries.find(x=>x._id===id);if(!e)return;
        const canModify=isHG||(canEdit&&e.matricule===userMatricule);
        const timeDisplay=e.slot_end&&e.slot_end!==e.slot?`${e.slot} ‚Üí ${e.slot_end}`:e.slot;
        const o=document.createElement('div');o.className='modal-overlay';
        o.innerHTML=`<div class="modal-box">
          <h3>${e.type}</h3>
          <div class="form-group"><label>DATE</label><input type="text" value="${fmtDate(e.date)}" readonly style="opacity:0.6;"></div>
          <div class="form-group"><label>CR√âNEAU</label><input type="text" value="${timeDisplay}" readonly style="opacity:0.6;"></div>
          <div class="form-group"><label>MATRICULE</label><input type="text" value="${e.matricule||'-'}" readonly style="opacity:0.6;"></div>
          <div class="form-group"><label>DESCRIPTION</label><input type="text" value="${e.description||'-'}" readonly style="opacity:0.6;"></div>
          <div class="modal-actions">
            ${canModify?`<button class="btn-delete" onclick="deleteEntry('${e._id}')">SUPPRIMER</button>`:''}
            <button class="btn-cancel" onclick="this.closest('.modal-overlay').remove()">FERMER</button>
          </div>
        </div>`;
        document.body.appendChild(o);o.addEventListener('click',ev=>{if(ev.target===o)o.remove();});
      };

      window.deleteEntry=async function(id){
        try{await deletePlanningEntry(id);allEntries=allEntries.filter(e=>e._id!==id);document.querySelector('.modal-overlay')?.remove();showAlert('‚úì Entr√©e supprim√©e');renderPlanning();}catch(e){showAlert('‚úó '+e.message,'error');}
      };

      // ===== AUTH + INIT =====
      onAuthStateChanged(auth, async(user)=>{
        if(!user){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
        try{
          const s=await getDoc(doc(db,'users',user.uid));
          if(!s.exists()||!s.data().approved){
            document.getElementById('loading').style.display='none';
            if(!s.exists())document.getElementById('access-denied').style.display='block';
            else document.getElementById('notApproved').style.display='block';
            return;
          }
          const ud=s.data();userMatricule=ud.matricule||'???';currentUser=ud;
          let units=[];try{units=await loadUnits();}catch(_){}
          const ui=units.find(x=>x.matricule===userMatricule);
          const rang=ui?(ui.rang||''):'';
          isHG=rang==='Ofc'||rang==='Cmd';
          const rankOrder=['RCT','.05','.04','.03','STB','.02','.01','DvL','STBE','CABAL','Ofc','Cmd'];
          const ri=rankOrder.indexOf(rang);
          canEdit=isHG||ri>=2;

          document.getElementById('loading').style.display='none';
          document.getElementById('mainContent').style.display='block';

          initNotepad();
          try{allEntries=await loadPlanning();}catch(_){allEntries=[];}
          renderPlanning();
        }catch(e){console.error(e);document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';}
      });
    </script>
</body>
</html>
