<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Semaine - MPF Documentation</title>
    <link rel="stylesheet" href="assets/css/bundle.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        /* ===== PLANNING GRID ===== */
        .planning-wrapper{max-width:1400px;margin:0 auto;}
        .planning-wrapper{max-width:100%;}
        .week-nav{display:flex;align-items:center;justify-content:center;gap:1rem;margin-bottom:1.2rem;font-family:'Orbitron',sans-serif;}
        .week-nav button{padding:0.4rem 0.8rem;background:rgba(0,170,255,0.08);border:1px solid rgba(0,170,255,0.3);color:var(--accent-cyan);cursor:pointer;border-radius:3px;font-family:'Share Tech Mono',monospace;font-size:0.8rem;transition:all 0.15s;}
        .week-nav button:hover{background:rgba(0,170,255,0.2);}
        .week-nav .week-label{font-size:0.9rem;color:var(--accent-cyan);min-width:280px;text-align:center;}
        .planning-grid{display:grid;grid-template-columns:80px repeat(7,1fr);border:1px solid rgba(0,170,255,0.15);border-radius:4px;overflow:hidden;font-family:'Share Tech Mono',monospace;font-size:0.75rem;}
        .planning-grid .day-header{padding:0.5rem 0.3rem;text-align:center;background:rgba(0,170,255,0.08);border-bottom:2px solid rgba(0,170,255,0.2);color:var(--accent-cyan);font-family:'Orbitron',sans-serif;font-size:0.65rem;letter-spacing:1px;font-weight:700;}
        .planning-grid .day-header.today{background:rgba(0,170,255,0.15);color:#fff;}
        .planning-grid .time-header{padding:0.5rem 0.3rem;text-align:center;background:rgba(0,170,255,0.08);border-bottom:2px solid rgba(0,170,255,0.2);color:var(--accent-cyan);font-family:'Orbitron',sans-serif;font-size:0.65rem;letter-spacing:1px;font-weight:700;}
        .planning-grid .time-cell{padding:0.3rem;text-align:center;background:rgba(0,170,255,0.02);border-right:1px solid rgba(0,170,255,0.06);border-bottom:1px solid rgba(0,170,255,0.06);color:var(--text-muted);font-size:0.7rem;display:flex;align-items:center;justify-content:center;}
        .planning-grid .slot-cell{padding:0.2rem;border-right:1px solid rgba(0,170,255,0.06);border-bottom:1px solid rgba(0,170,255,0.06);min-height:48px;cursor:pointer;transition:background 0.1s;position:relative;}
        .slot-cell:hover{background:rgba(0,170,255,0.06);}
        .slot-entry{padding:0.25rem 0.4rem;border-radius:3px;font-size:0.65rem;margin-bottom:2px;cursor:pointer;overflow:hidden;line-height:1.3;transition:transform 0.1s,box-shadow 0.15s;}
        .slot-entry:hover{transform:scale(1.03);box-shadow:0 0 8px rgba(0,170,255,0.3);z-index:5;position:relative;}
        .slot-entry .entry-time{font-size:0.58rem;opacity:0.8;margin-bottom:1px;letter-spacing:0.5px;}
        .slot-entry .entry-type{font-weight:700;font-size:0.68rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .slot-entry .entry-who{font-size:0.55rem;opacity:0.7;margin-top:1px;}
        .slot-entry.type-formation{background:rgba(0,170,255,0.15);border-left:2px solid var(--accent-cyan);color:var(--accent-cyan);}
        .slot-entry.type-test{background:rgba(255,200,0,0.15);border-left:2px solid #ffc800;color:#ffc800;}
        .slot-entry.type-recrutement{background:rgba(0,200,80,0.15);border-left:2px solid #00cc55;color:#00cc55;}
        .slot-entry.type-autre{background:rgba(200,100,255,0.15);border-left:2px solid #c864ff;color:#c864ff;}
        .slot-entry.type-operation{background:rgba(255,100,60,0.15);border-left:2px solid #ff6644;color:#ff6644;}
        .slot-entry.type-patrouille{background:rgba(100,200,255,0.15);border-left:2px solid #64c8ff;color:#64c8ff;}
        /* Multi-slot entries spanning multiple rows */
        .slot-entry.multi-slot{position:relative;}
        .slot-add{position:absolute;top:0;right:0;width:14px;height:14px;background:rgba(0,170,255,0.15);border:1px solid rgba(0,170,255,0.3);border-radius:2px;color:var(--accent-cyan);display:none;align-items:center;justify-content:center;font-size:0.6rem;cursor:pointer;z-index:2;}
        .slot-cell:hover .slot-add{display:flex;}
        .legend{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;font-family:'Share Tech Mono',monospace;font-size:0.7rem;}
        .legend-item{display:flex;align-items:center;gap:0.3rem;}
        .legend-dot{width:10px;height:10px;border-radius:2px;}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);z-index:1000;display:flex;align-items:center;justify-content:center;}
        .modal-box{background:#0a1628;border:1px solid rgba(0,170,255,0.3);padding:1.5rem;border-radius:6px;max-width:450px;width:90%;}
        .modal-box h3{color:var(--accent-cyan);font-family:'Orbitron',sans-serif;font-size:0.85rem;margin-bottom:1rem;}
        .modal-box .form-group{margin-bottom:0.8rem;}
        .modal-box .form-group label{display:block;font-family:'Share Tech Mono',monospace;font-size:0.7rem;color:var(--text-muted);letter-spacing:1px;margin-bottom:0.2rem;}
        .modal-box .form-group input,.modal-box .form-group select,.modal-box .form-group textarea{width:100%;padding:0.4rem 0.6rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.2);color:var(--text-primary);font-family:'Share Tech Mono',monospace;font-size:0.8rem;outline:none;border-radius:2px;box-sizing:border-box;}
        .modal-box .form-group select option{background:#0a1628;}
        .modal-box .form-group .time-range{display:flex;gap:0.5rem;align-items:center;}
        .modal-box .form-group .time-range span{color:var(--text-muted);font-family:'Share Tech Mono',monospace;font-size:0.75rem;}
        .modal-box .form-group .time-range select{width:auto;flex:1;}
        .modal-box .modal-actions{display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1rem;}
        .modal-box .modal-actions button{padding:0.4rem 1rem;font-family:'Share Tech Mono',monospace;font-size:0.78rem;cursor:pointer;border-radius:3px;transition:all 0.15s;}
        .btn-cancel{border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.05);color:#fff;}
        .btn-save{border:1px solid rgba(0,170,255,0.4);background:rgba(0,170,255,0.15);color:var(--accent-cyan);font-weight:700;}
        .btn-save:hover{background:rgba(0,170,255,0.3);}
        .btn-delete{border:1px solid rgba(255,68,68,0.4);background:rgba(255,68,68,0.08);color:#ff6666;}
        .btn-delete:hover{background:rgba(255,68,68,0.15);}
        .alert-msg{padding:0.6rem 1rem;border-radius:3px;margin-bottom:1rem;font-size:0.8rem;font-family:'Share Tech Mono',monospace;display:none;}
        .alert-msg.success{display:block;background:rgba(0,200,80,0.08);border:1px solid rgba(0,200,80,0.3);color:#00cc55;}
        .alert-msg.error{display:block;background:rgba(255,60,60,0.1);border:1px solid rgba(255,60,60,0.3);color:#ff4444;}
        .sync-indicator{position:fixed;bottom:1rem;right:1rem;padding:0.4rem 0.8rem;border-radius:3px;font-family:'Share Tech Mono',monospace;font-size:0.72rem;z-index:999;transition:all 0.3s;pointer-events:none;opacity:0;}
        .sync-indicator.syncing{opacity:1;background:rgba(255,200,0,0.15);border:1px solid rgba(255,200,0,0.4);color:#ffc800;}
        .sync-indicator.synced{opacity:1;background:rgba(0,200,80,0.15);border:1px solid rgba(0,200,80,0.4);color:#00cc55;}
        .sync-indicator.error{opacity:1;background:rgba(255,60,60,0.15);border:1px solid rgba(255,60,60,0.4);color:#ff4444;}
        .sync-indicator.hidden{opacity:0;}
        #access-denied,#notApproved{display:none;text-align:center;padding:3rem;}
        @media(max-width:900px){.planning-grid{font-size:0.6rem;}.planning-grid .day-header,.planning-grid .time-header{font-size:0.55rem;}.slot-entry{font-size:0.55rem;}}
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div><h1 class="logo">MPF</h1><p class="logo-subtitle">Planning Hebdomadaire</p></div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;"><p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p></div>
            <div id="access-denied"><h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">CONNEXION REQUISE</h2><a href="login.html" style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;display:inline-block;margin-top:1rem;">â†’ SE CONNECTER</a></div>
            <div id="notApproved"><h2 style="color:#ffaa00;font-family:'Orbitron',sans-serif;">EN ATTENTE D'APPROBATION</h2></div>
            <div id="mainContent" style="display:none;">
                    <div class="planning-wrapper">
                            <div id="alertMsg" class="alert-msg"></div>
                            <div class="week-nav">
                                <button onclick="changeWeek(-1)">â—„ SEMAINE PRÃ‰C.</button>
                                <span class="week-label" id="weekLabel">---</span>
                                <button onclick="changeWeek(1)">SEMAINE SUIV. â–º</button>
                            </div>
                            <div class="legend">
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(0,170,255,0.4);"></div><span>Formation</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(255,200,0,0.4);"></div><span>Test</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(0,200,80,0.4);"></div><span>Recrutement</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(255,100,60,0.4);"></div><span>OpÃ©ration</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(100,200,255,0.4);"></div><span>Patrouille</span></div>
                                <div class="legend-item"><div class="legend-dot" style="background:rgba(200,100,255,0.4);"></div><span>Autre</span></div>
                            </div>
                            <div class="combine-terminal-wrapper animate-fadeInUp">
                                <div class="combine-header"><h2>ðŸ“… PLANNING DE LA SEMAINE</h2><span class="header-code" id="entryCount">0 ENTRÃ‰ES</span></div>
                                <div class="combine-body" style="padding:0;overflow-x:auto;">
                                    <div class="planning-grid" id="planningGrid"></div>
                                </div>
                            </div>
                    </div>
            </div>
        </div>
    </main>
    <script type="module" src="assets/js/auth.js"></script>
    <script src="assets/js/global-nav.js?v=20260214" defer></script>
    <script src="assets/js/interactive-system.js" defer></script>
    <script src="assets/js/combine-animations.js" defer></script>
    <script type="module">
      import { auth, db } from './assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { loadUnits, loadPlanning, addPlanningEntry, updatePlanningEntry, deletePlanningEntry, onSyncStatus } from './assets/js/github-data.js';

      let currentUser=null, isHG=false, canEdit=false, userMatricule='';
      let allEntries=[], weekOffset=0;
      const DAYS=['LUN','MAR','MER','JEU','VEN','SAM','DIM'];
      // CrÃ©neaux de 14h Ã  00h (minuit)
      const SLOTS=['14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30','18:00','18:30','19:00','19:30','20:00','20:30','21:00','21:30','22:00','22:30','23:00','23:30','00:00'];
      const TYPES=['Formation','Test','Recrutement','OpÃ©ration','Patrouille','Autre'];

      function showAlert(t,type='success'){const e=document.getElementById('alertMsg');e.style.display='block';e.className='alert-msg '+type;e.textContent=t;setTimeout(()=>e.style.display='none',5000);}
      function fmtDate(d){if(!d)return'-';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d;}

      // Sync indicator
      {const i=document.createElement('div');i.id='syncIndicator';i.className='sync-indicator hidden';document.body.appendChild(i);let t=null;onSyncStatus(s=>{clearTimeout(t);if(s==='syncing'){i.innerHTML='<span style="display:inline-block;animation:spin 1s linear infinite;">âŸ³</span> Sync...';i.className='sync-indicator syncing';}else if(s==='synced'){i.innerHTML='âœ“ Sync';i.className='sync-indicator synced';t=setTimeout(()=>i.className='sync-indicator hidden',2500);}else{i.innerHTML='âš  Erreur';i.className='sync-indicator error';t=setTimeout(()=>i.className='sync-indicator hidden',6000);}});}

      // ===== WEEK HELPERS =====
      function localDateStr(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return`${y}-${m}-${dd}`;}
      function getWeekDates(offset=0){
        const now=new Date();now.setDate(now.getDate()+offset*7);
        const day=now.getDay();const diff=now.getDate()-day+(day===0?-6:1);
        const mon=new Date(now);mon.setDate(diff);mon.setHours(0,0,0,0);
        const dates=[];for(let i=0;i<7;i++){const d=new Date(mon);d.setDate(mon.getDate()+i);dates.push(localDateStr(d));}
        return dates;
      }

      function getTypeClass(type){
        const t=(type||'').toLowerCase();
        if(t.includes('formation'))return'type-formation';
        if(t.includes('test'))return'type-test';
        if(t.includes('recrutement'))return'type-recrutement';
        if(t.includes('opÃ©ration')||t.includes('operation'))return'type-operation';
        if(t.includes('patrouille'))return'type-patrouille';
        return'type-autre';
      }

      // Compare slot times: returns true if slotA <= slotB
      function slotLte(a,b){
        const toMin=s=>{const[h,m]=s.split(':').map(Number);return(h===0?24:h)*60+m;};
        return toMin(a)<=toMin(b);
      }
      function slotInRange(slot, from, to){
        const toMin=s=>{const[h,m]=s.split(':').map(Number);return(h===0?24:h)*60+m;};
        const sv=toMin(slot),fv=toMin(from),tv=toMin(to);
        return sv>=fv&&sv<tv; // slot is within [from, to)
      }

      // ===== RENDER PLANNING GRID =====
      function renderPlanning(){
        const dates=getWeekDates(weekOffset);
        const today=localDateStr(new Date());
        document.getElementById('weekLabel').textContent=fmtDate(dates[0])+' â€” '+fmtDate(dates[6]);

        const weekEntries=allEntries.filter(e=>dates.includes(e.date));
        document.getElementById('entryCount').textContent=weekEntries.length+' ENTRÃ‰E'+(weekEntries.length>1?'S':'');

        const grid=document.getElementById('planningGrid');
        let html='<div class="time-header">HEURE</div>';
        DAYS.forEach((d,i)=>{html+=`<div class="day-header${dates[i]===today?' today':''}">${d}<br><span style="font-size:0.55rem;opacity:0.7;">${dates[i].substring(8)}</span></div>`;});

        SLOTS.forEach(slot=>{
          html+=`<div class="time-cell">${slot}</div>`;
          dates.forEach((date,di)=>{
            // Show entries that START at this slot OR span across this slot
            const cellEntries=weekEntries.filter(e=>{
              if(e.date!==date)return false;
              if(!e.slot_end||e.slot_end===e.slot){
                return e.slot===slot; // single slot
              }
              return slotInRange(slot,e.slot,e.slot_end);
            });
            // For multi-slot, only show the label on the first slot
            const visibleEntries=cellEntries.filter(e=>{
              if(!e.slot_end||e.slot_end===e.slot)return true;
              return e.slot===slot;
            });
            const bgEntries=cellEntries.filter(e=>e.slot_end&&e.slot_end!==e.slot&&e.slot!==slot);
            const bgClass=bgEntries.length>0?` style="background:${getBgForType(bgEntries[0].type)}"`:'';
            const entriesHtml=visibleEntries.map(e=>{
              const hasRange=e.slot_end&&e.slot_end!==e.slot;
              const timeLabel=hasRange?`${e.slot} â†’ ${e.slot_end}`:e.slot;
              return`<div class="slot-entry ${getTypeClass(e.type)}${hasRange?' multi-slot':''}" onclick="event.stopPropagation();showEntryDetail('${e._id}')" title="${e.type} â€” ${timeLabel}${e.description?' â€” '+e.description:''} (${e.matricule})">`+
                `<div class="entry-time">${timeLabel}</div>`+
                `<div class="entry-type">${e.type}</div>`+
                (e.matricule?`<div class="entry-who">${e.matricule}</div>`:'')+
              `</div>`;
            }).join('');
            const addBtn=canEdit?`<div class="slot-add" onclick="event.stopPropagation();openAddModal('${date}','${slot}')">+</div>`:'';
            html+=`<div class="slot-cell"${bgClass} onclick="openAddModal('${date}','${slot}')">${entriesHtml}${addBtn}</div>`;
          });
        });
        grid.innerHTML=html;
      }

      function getBgForType(type){
        const t=(type||'').toLowerCase();
        if(t.includes('formation'))return'rgba(0,170,255,0.04)';
        if(t.includes('test'))return'rgba(255,200,0,0.04)';
        if(t.includes('recrutement'))return'rgba(0,200,80,0.04)';
        if(t.includes('opÃ©ration')||t.includes('operation'))return'rgba(255,100,60,0.04)';
        if(t.includes('patrouille'))return'rgba(100,200,255,0.04)';
        return'rgba(200,100,255,0.04)';
      }

      // ===== WEEK NAVIGATION =====
      window.changeWeek=function(dir){weekOffset+=dir;renderPlanning();};

      // ===== ADD ENTRY MODAL (with time range) =====
      window.openAddModal=function(date,slot){
        if(!canEdit){return;}
        // Build slot options
        const slotOpts=SLOTS.map(s=>`<option value="${s}"${s===slot?' selected':''}>${s}</option>`).join('');
        // Default end slot = next slot
        const sIdx=SLOTS.indexOf(slot);
        const defaultEnd=sIdx<SLOTS.length-1?SLOTS[sIdx+1]:SLOTS[SLOTS.length-1];
        const endOpts=SLOTS.map(s=>`<option value="${s}"${s===defaultEnd?' selected':''}>${s}</option>`).join('');

        const o=document.createElement('div');o.className='modal-overlay';
        o.innerHTML=`<div class="modal-box">
          <h3>AJOUTER UNE ENTRÃ‰E</h3>
          <div class="form-group"><label>DATE</label><input type="date" id="mDate" value="${date}"></div>
          <div class="form-group">
            <label>CRÃ‰NEAU HORAIRE</label>
            <div class="time-range">
              <select id="mSlotStart">${slotOpts}</select>
              <span>â†’</span>
              <select id="mSlotEnd">${endOpts}</select>
            </div>
          </div>
          <div class="form-group"><label>TYPE</label><select id="mType">${TYPES.map(t=>`<option value="${t}">${t}</option>`).join('')}</select></div>
          <div class="form-group"><label>DESCRIPTION</label><input type="text" id="mDesc" placeholder="DÃ©tails (optionnel)"></div>
          <div class="modal-actions">
            <button class="btn-cancel" onclick="this.closest('.modal-overlay').remove()">ANNULER</button>
            <button class="btn-save" onclick="saveEntry()">AJOUTER</button>
          </div>
        </div>`;
        document.body.appendChild(o);
        o.addEventListener('click',e=>{if(e.target===o)o.remove();});

        // Auto-adjust end slot when start changes
        document.getElementById('mSlotStart').addEventListener('change',function(){
          const startIdx=SLOTS.indexOf(this.value);
          const endSel=document.getElementById('mSlotEnd');
          const endIdx=SLOTS.indexOf(endSel.value);
          if(startIdx>=endIdx&&startIdx<SLOTS.length-1){
            endSel.value=SLOTS[startIdx+1];
          }
        });
      };

      window.saveEntry=async function(){
        const date=document.getElementById('mDate').value;
        const slotStart=document.getElementById('mSlotStart').value;
        const slotEnd=document.getElementById('mSlotEnd').value;
        const type=document.getElementById('mType').value;
        const desc=document.getElementById('mDesc').value.trim();
        if(!date||!slotStart||!type){showAlert('Champs requis','error');return;}
        // Validate: end must be after start
        const toMin=s=>{const[h,m]=s.split(':').map(Number);return(h===0?24:h)*60+m;};
        if(toMin(slotEnd)<=toMin(slotStart)){showAlert('L\'heure de fin doit Ãªtre aprÃ¨s l\'heure de dÃ©but','error');return;}
        const entry={date,slot:slotStart,slot_end:slotEnd,type,description:desc,matricule:userMatricule,created_at:new Date().toISOString().substring(0,10)};
        try{const saved=await addPlanningEntry(entry);allEntries.push(saved);document.querySelector('.modal-overlay')?.remove();showAlert('âœ“ EntrÃ©e ajoutÃ©e');renderPlanning();}catch(e){showAlert('âœ— '+e.message,'error');}
      };

      // ===== ENTRY DETAIL MODAL =====
      window.showEntryDetail=function(id){
        const e=allEntries.find(x=>x._id===id);if(!e)return;
        const canModify=isHG||(canEdit&&e.matricule===userMatricule);
        const timeDisplay=e.slot_end&&e.slot_end!==e.slot?`${e.slot} â†’ ${e.slot_end}`:e.slot;
        const o=document.createElement('div');o.className='modal-overlay';
        o.innerHTML=`<div class="modal-box">
          <h3>${e.type}</h3>
          <div class="form-group"><label>DATE</label><input type="text" value="${fmtDate(e.date)}" readonly style="opacity:0.6;"></div>
          <div class="form-group"><label>CRÃ‰NEAU</label><input type="text" value="${timeDisplay}" readonly style="opacity:0.6;"></div>
          <div class="form-group"><label>MATRICULE</label><input type="text" value="${e.matricule||'-'}" readonly style="opacity:0.6;"></div>
          <div class="form-group"><label>DESCRIPTION</label><input type="text" value="${e.description||'-'}" readonly style="opacity:0.6;"></div>
          <div class="modal-actions">
            ${canModify?`<button class="btn-delete" onclick="deleteEntry('${e._id}')">SUPPRIMER</button>`:''}
            <button class="btn-cancel" onclick="this.closest('.modal-overlay').remove()">FERMER</button>
          </div>
        </div>`;
        document.body.appendChild(o);o.addEventListener('click',ev=>{if(ev.target===o)o.remove();});
      };

      window.deleteEntry=async function(id){
        try{await deletePlanningEntry(id);allEntries=allEntries.filter(e=>e._id!==id);document.querySelector('.modal-overlay')?.remove();showAlert('âœ“ EntrÃ©e supprimÃ©e');renderPlanning();}catch(e){showAlert('âœ— '+e.message,'error');}
      };

      // ===== AUTH + INIT =====
      onAuthStateChanged(auth, async(user)=>{
        if(!user){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
        try{
          const s=await getDoc(doc(db,'users',user.uid));
          if(!s.exists()||!s.data().approved){
            document.getElementById('loading').style.display='none';
            if(!s.exists())document.getElementById('access-denied').style.display='block';
            else document.getElementById('notApproved').style.display='block';
            return;
          }
          const ud=s.data();userMatricule=ud.matricule||'???';currentUser=ud;
          let units=[];try{units=await loadUnits();}catch(_){}
          const ui=units.find(x=>x.matricule===userMatricule);
          const rang=ui?(ui.rang||''):'';
          isHG=rang==='Ofc'||rang==='Cmd';
          const isAdmin=!!ud.is_admin;
          if(isAdmin)isHG=true;
          const rankOrder=['RCT','.05','.04','.03','STB','.02','.01','DvL','STBE','CABAL','Ofc','Cmd'];
          const ri=rankOrder.indexOf(rang);
          canEdit=isHG||ri>=2;

          document.getElementById('loading').style.display='none';
          document.getElementById('mainContent').style.display='block';

          try{allEntries=await loadPlanning();}catch(_){allEntries=[];}
          renderPlanning();
        }catch(e){console.error(e);document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';}
      });
    </script>
</body>
</html>
