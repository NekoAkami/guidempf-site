<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire Test - MPF Documentation</title>
    <link rel="stylesheet" href="assets/css/bundle.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        .test-wrapper { max-width: 700px; margin: 0 auto; }
        .user-info-bar { display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1rem; background: rgba(0,170,255,0.04); border: 1px solid rgba(0,170,255,0.15); border-radius: 4px; margin-bottom: 1.5rem; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; }
        .user-info-bar .user-avatar { width: 42px; height: 42px; background: rgba(0,170,255,0.15); border: 1px solid var(--accent-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: var(--accent-cyan); font-weight: 700; flex-shrink: 0; }
        .user-info-bar .user-details { flex: 1; }
        .user-info-bar .user-matricule { font-family: 'Orbitron', sans-serif; font-size: 0.82rem; color: var(--accent-cyan); font-weight: 700; }
        .user-info-bar .user-status { font-size: 0.68rem; padding: 0.15rem 0.5rem; border-radius: 2px; background: rgba(0,200,80,0.1); border: 1px solid rgba(0,200,80,0.3); color: #00cc55; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; font-family: 'Share Tech Mono', monospace; font-size: 0.72rem; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 0.3rem; }
        .form-group label .req { color: #ff4444; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.5rem 0.7rem; background: rgba(0,170,255,0.04); border: 1px solid rgba(0,170,255,0.2); color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.82rem; outline: none; border-radius: 2px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent-cyan); }
        .form-group select { cursor: pointer; }
        .form-group select option { background: #0a1628; color: var(--text-primary); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group .hint { font-size: 0.68rem; color: var(--text-muted); margin-top: 0.2rem; font-family: 'Share Tech Mono', monospace; }
        .form-group.error input, .form-group.error textarea, .form-group.error select { border-color: #ff4444; }
        .form-group .error-msg { font-size: 0.7rem; color: #ff4444; margin-top: 0.2rem; font-family: 'Share Tech Mono', monospace; display: none; }
        .form-group.error .error-msg { display: block; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .rating-group { margin-bottom: 1.2rem; }
        .rating-group label { display: block; font-family: 'Share Tech Mono', monospace; font-size: 0.72rem; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 0.5rem; }
        .rating-scale { display: flex; gap: 0.5rem; }
        .rating-option { flex: 1; text-align: center; padding: 0.6rem 0.3rem; background: rgba(0,170,255,0.04); border: 1px solid rgba(0,170,255,0.15); border-radius: 3px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 0.9rem; color: var(--text-muted); transition: all 0.15s; }
        .rating-option:hover { background: rgba(0,170,255,0.1); border-color: rgba(0,170,255,0.3); }
        .rating-option.selected { background: rgba(0,170,255,0.2); border-color: var(--accent-cyan); color: var(--accent-cyan); font-weight: 700; }
        .rating-option .rating-label { display: block; font-size: 0.6rem; margin-top: 0.2rem; font-family: 'Share Tech Mono', monospace; opacity: 0.7; }
        .rating-group.error .rating-scale { border: 1px solid #ff4444; border-radius: 3px; padding: 2px; }
        .rating-group .error-msg { font-size: 0.7rem; color: #ff4444; margin-top: 0.2rem; font-family: 'Share Tech Mono', monospace; display: none; }
        .rating-group.error .error-msg { display: block; }
        .section-divider { margin: 1.5rem 0; padding: 0.5rem 0.8rem; background: rgba(0,170,255,0.04); border-left: 3px solid var(--accent-cyan); font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: var(--accent-cyan); letter-spacing: 1px; }
        .form-actions { display: flex; gap: 0.8rem; margin-top: 1.5rem; justify-content: flex-end; }
        .btn-action { padding: 0.5rem 1.2rem; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; cursor: pointer; border: 1px solid rgba(0,170,255,0.4); background: rgba(0,170,255,0.1); color: var(--accent-cyan); border-radius: 3px; transition: all 0.15s; letter-spacing: 0.5px; }
        .btn-action:hover { background: rgba(0,170,255,0.2); border-color: var(--accent-cyan); }
        .btn-action.primary { background: rgba(0,170,255,0.2); border-color: var(--accent-cyan); font-weight: 700; }
        .btn-action.primary:hover { background: rgba(0,170,255,0.35); }
        .btn-action:disabled { opacity: 0.4; cursor: not-allowed; }
        .alert-msg { padding: 0.6rem 1rem; border-radius: 3px; margin-bottom: 1rem; font-size: 0.8rem; font-family: 'Share Tech Mono', monospace; display: none; }
        .alert-msg.success { display: block; background: rgba(0,200,80,0.08); border: 1px solid rgba(0,200,80,0.3); color: #00cc55; }
        .alert-msg.error { display: block; background: rgba(255,60,60,0.1); border: 1px solid rgba(255,60,60,0.3); color: #ff4444; }
        .tab-bar { display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(0,170,255,0.15); }
        .tab-btn { padding: 0.5rem 1.2rem; font-family: 'Orbitron', sans-serif; font-size: 0.72rem; color: var(--text-muted); background: transparent; border: none; cursor: pointer; letter-spacing: 1px; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
        .tab-btn:hover { color: var(--accent-cyan); }
        .tab-btn.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .archives-table { width: 100%; border-collapse: collapse; font-family: 'Share Tech Mono', monospace; }
        .archives-table th { text-align: left; padding: 0.5rem 0.4rem; color: var(--accent-cyan); font-size: 0.68rem; letter-spacing: 1px; border-bottom: 2px solid rgba(0,170,255,0.2); }
        .archives-table td { padding: 0.4rem; color: var(--text-primary); border-bottom: 1px solid rgba(0,170,255,0.06); vertical-align: middle; font-size: 0.78rem; }
        .archives-table tr:hover { background: rgba(0,170,255,0.03); cursor: pointer; }
        .status-badge { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 2px; font-size: 0.68rem; font-weight: 700; }
        .status-badge.pending { background: rgba(255,200,0,0.15); color: #ffc800; border: 1px solid rgba(255,200,0,0.3); }
        .status-badge.validated { background: rgba(0,200,80,0.15); color: #00cc55; border: 1px solid rgba(0,200,80,0.3); }
        .status-badge.rejected { background: rgba(255,60,60,0.15); color: #ff4444; border: 1px solid rgba(255,60,60,0.3); }
        .avg-score { font-family: 'Orbitron', sans-serif; font-weight: 700; }
        .detail-overlay { position: fixed; top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);z-index:1000;display:flex;align-items:center;justify-content:center; }
        .detail-box { background:#0a1628;border:1px solid rgba(0,170,255,0.2);padding:1.5rem;border-radius:6px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto; }
        .detail-box h3 { color:#fff;font-family:'Orbitron',sans-serif;font-size:0.9rem;margin-bottom:1rem; }
        .detail-box .detail-row { display:flex;gap:0.5rem;margin-bottom:0.5rem;font-family:'Share Tech Mono',monospace;font-size:0.82rem; }
        .detail-box .detail-label { color:var(--text-muted);min-width:160px; }
        .detail-box .detail-value { color:var(--text-primary);flex:1; }
        .detail-box .close-btn { margin-top:1rem;padding:0.4rem 1rem;border:1px solid rgba(0,170,255,0.2);background:rgba(0,170,255,0.05);color:#fff;font-family:'Share Tech Mono',monospace;font-size:0.8rem;cursor:pointer;border-radius:3px;display:block;margin-left:auto; }
        .sync-indicator { position: fixed; bottom: 1rem; right: 1rem; padding: 0.4rem 0.8rem; border-radius: 3px; font-family: 'Share Tech Mono', monospace; font-size: 0.72rem; z-index: 999; transition: all 0.3s; pointer-events: none; opacity: 0; }
        .sync-indicator.syncing { opacity: 1; background: rgba(255,200,0,0.15); border: 1px solid rgba(255,200,0,0.4); color: #ffc800; }
        .sync-indicator.synced { opacity: 1; background: rgba(0,200,80,0.15); border: 1px solid rgba(0,200,80,0.4); color: #00cc55; }
        .sync-indicator.error { opacity: 1; background: rgba(255,60,60,0.15); border: 1px solid rgba(255,60,60,0.4); color: #ff4444; }
        .sync-indicator.hidden { opacity: 0; }
        @keyframes spin-sync { to { transform: rotate(360deg); } }
        .sync-spinner { display: inline-block; animation: spin-sync 1s linear infinite; }
        /* S√©lection unit√© */
        .units-selector { position: relative; }
        .units-input-row { display: flex; align-items: center; gap: 0; }
        .units-input-row input { flex: 1; border-radius: 2px 0 0 2px !important; }
        .units-toggle-btn { padding: 0.5rem 0.6rem; background: rgba(0,170,255,0.12); border: 1px solid rgba(0,170,255,0.2); border-left: none; color: var(--accent-cyan); cursor: pointer; font-size: 0.9rem; font-family: 'Share Tech Mono', monospace; border-radius: 0 2px 2px 0; transition: background 0.15s, border-color 0.15s; display: flex; align-items: center; justify-content: center; min-width: 32px; }
        .units-toggle-btn:hover { background: rgba(0,170,255,0.25); border-color: var(--accent-cyan); }
        .units-toggle-btn.active { background: rgba(0,170,255,0.2); border-color: var(--accent-cyan); }
        .units-dropdown { display: none; position: absolute; left: 0; right: 0; top: 100%; background: #0a1628; border: 1px solid rgba(0,170,255,0.3); border-top: none; max-height: 200px; overflow-y: auto; z-index: 50; border-radius: 0 0 4px 4px; }
        .units-dropdown.open { display: block; }
        .units-dropdown-search { width: 100%; padding: 0.4rem 0.6rem; background: rgba(0,170,255,0.06); border: none; border-bottom: 1px solid rgba(0,170,255,0.15); color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; outline: none; }
        .units-dropdown-item { padding: 0.35rem 0.6rem; font-family: 'Share Tech Mono', monospace; font-size: 0.78rem; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background 0.1s; }
        .units-dropdown-item:hover { background: rgba(0,170,255,0.1); }
        .units-dropdown-item.selected { background: rgba(0,170,255,0.15); }
        #access-denied, #notApproved, #noAccess { display: none; text-align: center; padding: 3rem; }
    </style>
</head>
<body>
    <div class="scanline-overlay"></div>
    <div class="particles-bg"></div>
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">M</div>
                    <div><h1 class="logo">MPF</h1><p class="logo-subtitle">Formulaire de Test</p></div>
                </div>
                <div id="authBtn" class="header-auth"></div>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <div id="loading" style="text-align:center;padding:3rem;"><p style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;">CHARGEMENT...</p></div>
            <div id="access-denied"><h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">CONNEXION REQUISE</h2><p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.5rem;">Vous devez √™tre connect√©.</p><a href="login.html" style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;display:inline-block;margin-top:1rem;">‚Üí SE CONNECTER</a></div>
            <div id="notApproved"><h2 style="color:#ffaa00;font-family:'Orbitron',sans-serif;">EN ATTENTE D'APPROBATION</h2><p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.5rem;">Votre compte n'a pas encore √©t√© approuv√©.</p></div>
            <div id="noAccess"><h2 style="color:#ff4444;font-family:'Orbitron',sans-serif;">ACC√àS RESTREINT</h2><p style="color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.5rem;">Ce formulaire est r√©serv√© aux <span style="color:var(--accent-cyan);font-weight:700;">Unit√©s Formatrices</span> et <span style="color:var(--accent-cyan);font-weight:700;">HautGrad√©s</span>.</p><a href="formulaires.html" style="color:var(--accent-cyan);font-family:'Share Tech Mono',monospace;display:inline-block;margin-top:1rem;">‚Üê RETOUR AUX FORMULAIRES</a></div>
            <div id="mainContent" style="display:none;">
                <div class="test-wrapper">
                    <div class="user-info-bar">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-details"><div class="user-matricule" id="userIdentification">---</div><div id="userAccreditation" style="font-size:0.7rem;color:var(--text-muted);font-family:'Share Tech Mono',monospace;margin-top:0.15rem;"></div></div>
                        <div class="user-status">CONNECT√â</div>
                    </div>
                    <div class="tab-bar">
                        <button class="tab-btn active" onclick="switchTab('form')">FORMULAIRE DE TEST</button>
                        <button class="tab-btn" onclick="switchTab('archives')">ARCHIVES</button>
                    </div>
                    <div id="alertMsg" class="alert-msg"></div>
                    <!-- TAB: Formulaire -->
                    <div id="tabForm" class="tab-content active">
                        <div class="combine-terminal-wrapper">
                            <div class="combine-header"><h2>üìù √âVALUATION D'UNIT√â</h2><span class="header-code">FORM-04</span></div>
                            <div class="combine-body">
                                <div class="row-2">
                                    <div class="form-group" id="grpMatricule"><label>MATRICULE DE L'UNIT√â TEST√âE <span class="req">*</span></label><div class="units-selector" id="unitsSelectorWrapper"><div class="units-input-row"><input type="text" id="fMatricule" placeholder="Ex: 123" maxlength="3" pattern="\d{3}"><button type="button" class="units-toggle-btn" id="unitsToggleBtn" onclick="toggleUnitsDropdown()" title="Liste des unit√©s">‚ñº</button></div><div class="units-dropdown" id="unitsDropdown"><input type="text" class="units-dropdown-search" id="unitsDropdownSearch" placeholder="Rechercher..." oninput="filterUnitsDropdown()"><div id="unitsDropdownList"></div></div></div><div class="hint">Saisissez le matricule ou utilisez ‚ñº pour s√©lectionner</div><div class="error-msg" id="errMatricule"></div></div>
                                    <div class="form-group" id="grpGrade"><label>GRADE ACTUEL <span class="req">*</span></label><select id="fGrade"><option value="">‚Äî S√©lectionner ‚Äî</option><option value="RCT">RCT (Recrue)</option><option value=".05">.05</option><option value=".04">.04</option><option value=".03">.03</option><option value="STB">STB</option><option value=".02">.02</option><option value=".01">.01</option><option value="DvL">DvL</option><option value="STBE">STBE</option><option value="CABAL">CABAL</option><option value="Ofc">Ofc</option><option value="Cmd">Cmd</option></select><div class="error-msg" id="errGrade"></div></div>
                                </div>
                                <div class="section-divider">‚ñ∏ R√âSULTATS ‚Äî La note la plus basse est 1, la meilleure est 4</div>
                                <div class="rating-group" id="grpSaluts"><label>NOTE SUR LES SALUTS <span class="req">*</span></label><div class="rating-scale" data-field="noteSaluts"><div class="rating-option" data-value="1" onclick="selectRating('noteSaluts',1)">1<span class="rating-label">Faible</span></div><div class="rating-option" data-value="2" onclick="selectRating('noteSaluts',2)">2<span class="rating-label">Moyen</span></div><div class="rating-option" data-value="3" onclick="selectRating('noteSaluts',3)">3<span class="rating-label">Bon</span></div><div class="rating-option" data-value="4" onclick="selectRating('noteSaluts',4)">4<span class="rating-label">Excellent</span></div></div><div class="error-msg" id="errSaluts"></div></div>
                                <div class="rating-group" id="grpSociostatus"><label>NOTE SUR LES SOCIOSTATUS <span class="req">*</span></label><div class="rating-scale" data-field="noteSociostatus"><div class="rating-option" data-value="1" onclick="selectRating('noteSociostatus',1)">1<span class="rating-label">Faible</span></div><div class="rating-option" data-value="2" onclick="selectRating('noteSociostatus',2)">2<span class="rating-label">Moyen</span></div><div class="rating-option" data-value="3" onclick="selectRating('noteSociostatus',3)">3<span class="rating-label">Bon</span></div><div class="rating-option" data-value="4" onclick="selectRating('noteSociostatus',4)">4<span class="rating-label">Excellent</span></div></div><div class="error-msg" id="errSociostatus"></div></div>
                                <div class="rating-group" id="grpVerdicts"><label>NOTE SUR LES VERDICTS 1 √Ä 5 <span class="req">*</span></label><div class="rating-scale" data-field="noteVerdicts"><div class="rating-option" data-value="1" onclick="selectRating('noteVerdicts',1)">1<span class="rating-label">Faible</span></div><div class="rating-option" data-value="2" onclick="selectRating('noteVerdicts',2)">2<span class="rating-label">Moyen</span></div><div class="rating-option" data-value="3" onclick="selectRating('noteVerdicts',3)">3<span class="rating-label">Bon</span></div><div class="rating-option" data-value="4" onclick="selectRating('noteVerdicts',4)">4<span class="rating-label">Excellent</span></div></div><div class="error-msg" id="errVerdicts"></div></div>
                                <div class="rating-group" id="grpProcedures"><label>NOTE SUR LES PROC√âDURES BASIQUES <span class="req">*</span></label><div class="rating-scale" data-field="noteProcedures"><div class="rating-option" data-value="1" onclick="selectRating('noteProcedures',1)">1<span class="rating-label">Faible</span></div><div class="rating-option" data-value="2" onclick="selectRating('noteProcedures',2)">2<span class="rating-label">Moyen</span></div><div class="rating-option" data-value="3" onclick="selectRating('noteProcedures',3)">3<span class="rating-label">Bon</span></div><div class="rating-option" data-value="4" onclick="selectRating('noteProcedures',4)">4<span class="rating-label">Excellent</span></div></div><div class="error-msg" id="errProcedures"></div></div>
                                <div class="section-divider">‚ñ∏ INFORMATIONS COMPL√âMENTAIRES</div>
                                <div class="row-2">
                                    <div class="form-group" id="grpFormationArmement"><label>FORMATION ARMEMENT ? <span class="req">*</span></label><select id="fFormationArmement"><option value="">‚Äî S√©lectionner ‚Äî</option><option value="Oui">Oui</option><option value="Non">Non</option></select><div class="error-msg" id="errFormationArmement"></div></div>
                                    <div class="form-group" id="grpCodes"><label>CODES COMPLET MENTIONN√â ? <span class="req">*</span></label><select id="fCodes"><option value="">‚Äî S√©lectionner ‚Äî</option><option value="Oui">Oui</option><option value="Non">Non</option></select><div class="hint" style="color:#ff4444;">‚ö† ERREUR MAJEURE si "Non"</div><div class="error-msg" id="errCodes"></div></div>
                                </div>
                                <div class="form-group" id="grpReforme"><label>TEST R√âALIS√â EN R√âFORME ? <span class="req">*</span></label><select id="fReforme"><option value="">‚Äî S√©lectionner ‚Äî</option><option value="Oui">Oui</option><option value="Non">Non</option></select><div class="error-msg" id="errReforme"></div></div>
                                <div class="form-group"><label>COMMENTAIRES</label><textarea id="fCommentaires" rows="4" placeholder="Observations, remarques, points d'am√©lioration... (optionnel)"></textarea></div>
                                <div class="form-actions"><button class="btn-action" onclick="resetTest()">R√âINITIALISER</button><button class="btn-action primary" id="btnSubmit" onclick="submitTest()">‚ü© SOUMETTRE LE TEST</button></div>
                            </div>
                        </div>
                    </div>
                    <!-- TAB: Archives -->
                    <div id="tabArchives" class="tab-content">
                        <div class="combine-terminal-wrapper">
                            <div class="combine-header"><h2>üìã ARCHIVES DES TESTS</h2><span class="header-code" id="archiveCount">0</span></div>
                            <div class="combine-body">
                                <div style="overflow-x:auto;">
                                    <table class="archives-table"><thead><tr><th>DATE</th><th>UNIT√â</th><th>GRADE</th><th>MOYENNE</th><th>√âVALUATEUR</th><th>STATUT</th></tr></thead><tbody id="archivesBody"><tr><td colspan="6" style="text-align:center;color:var(--text-muted);">Aucun test enregistr√©</td></tr></tbody></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script type="module" src="assets/js/auth.js"></script>
    <script src="assets/js/global-nav.js?v=20260214" defer></script>
    <script src="assets/js/interactive-system.js" defer></script>
    <script src="assets/js/combine-animations.js" defer></script>
    <script type="module">
      import { auth, db } from './assets/js/auth.js';
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { loadUnits as ghLoadUnits, loadUnitTests as ghLoadUnitTests, addUnitTest as ghAddUnitTest, addReport as ghAddReport, onSyncStatus } from './assets/js/github-data.js';

      let currentUser = null, allTests = [], ratings = {}, allUnitsData = [];
      function showAlert(t, type='success') { const e=document.getElementById('alertMsg'); e.style.display='block'; e.className='alert-msg '+type; e.textContent=t; setTimeout(()=>e.style.display='none',6000); }
      function fmtDate(d) { if(!d)return'-'; const p=d.split('-'); return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d; }
      function getAccreditation(r) { if(r==='RCT')return'Recrue';if(['.05','.04','.03','STB'].includes(r))return'MPF';if(['.02','.01','DvL','STBE','CABAL'].includes(r))return'MPEF';if(['Ofc','Cmd'].includes(r))return'HautGrad√©';return''; }
      { const i=document.createElement('div');i.id='syncIndicator';i.className='sync-indicator hidden';document.body.appendChild(i);let t=null;onSyncStatus(s=>{clearTimeout(t);if(s==='syncing'){i.innerHTML='<span class="sync-spinner">‚ü≥</span> Synchronisation...';i.className='sync-indicator syncing';}else if(s==='synced'){i.innerHTML='‚úì Synchronis√©';i.className='sync-indicator synced';t=setTimeout(()=>i.className='sync-indicator hidden',2500);}else{i.innerHTML='‚ö† Erreur sync';i.className='sync-indicator error';t=setTimeout(()=>i.className='sync-indicator hidden',6000);}}); }

      window.switchTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        if(tab==='form'){document.querySelectorAll('.tab-btn')[0].classList.add('active');document.getElementById('tabForm').classList.add('active');}
        else{document.querySelectorAll('.tab-btn')[1].classList.add('active');document.getElementById('tabArchives').classList.add('active');renderArchives();}
      };
      window.selectRating = function(field, value) {
        ratings[field]=value;
        document.querySelectorAll(`.rating-scale[data-field="${field}"] .rating-option`).forEach(el=>{el.classList.toggle('selected',parseInt(el.dataset.value)===value);});
      };
      /* === Dropdown s√©lection unit√© === */
      window.toggleUnitsDropdown = function() {
        const dd=document.getElementById('unitsDropdown'),btn=document.getElementById('unitsToggleBtn');
        if(dd.classList.contains('open')){dd.classList.remove('open');btn.classList.remove('active');btn.textContent='‚ñº';}
        else{dd.classList.add('open');btn.classList.add('active');btn.textContent='‚ñ≤';document.getElementById('unitsDropdownSearch').value='';filterUnitsDropdown();document.getElementById('unitsDropdownSearch').focus();}
      };
      document.addEventListener('click',function(e){const w=document.getElementById('unitsSelectorWrapper');if(w&&!w.contains(e.target)){const dd=document.getElementById('unitsDropdown'),btn=document.getElementById('unitsToggleBtn');if(dd&&dd.classList.contains('open')){dd.classList.remove('open');btn.classList.remove('active');btn.textContent='‚ñº';}}});
      window.filterUnitsDropdown = function() {
        const q=(document.getElementById('unitsDropdownSearch')?.value||'').toLowerCase();
        const list=document.getElementById('unitsDropdownList');if(!list)return;
        const cur=document.getElementById('fMatricule').value.trim();
        const filtered=allUnitsData.filter(u=>`${u.matricule} ${u.nom_steam||''} ${u.division||''} ${u.rang||''}`.toLowerCase().includes(q));
        list.innerHTML=filtered.length?filtered.map(u=>{
          const sel=u.matricule===cur?' selected':'';
          const divL=u.division?` <span style="color:var(--text-muted);font-size:0.7rem;">[${u.division}]</span>`:'';
          const rangL=u.rang?` <span style="color:var(--accent-cyan);font-size:0.7rem;">${u.rang}</span>`:'';
          return`<div class="units-dropdown-item${sel}" onclick="selectUnit('${u.matricule}')"><span>${u.matricule} ‚Äî ${u.nom_steam||'Inconnu'}${rangL}${divL}</span></div>`;
        }).join(''):'<div style="padding:0.5rem;color:var(--text-muted);font-size:0.78rem;text-align:center;">Aucune unit√© trouv√©e</div>';
      };
      window.selectUnit = function(mat) {
        document.getElementById('fMatricule').value=mat;
        const u=allUnitsData.find(x=>x.matricule===mat);
        if(u&&u.rang){const gs=document.getElementById('fGrade');for(let o of gs.options){if(o.value===u.rang){gs.value=u.rang;break;}}}
        toggleUnitsDropdown();
      };
      window.submitTest = async function() {
        if(!currentUser){showAlert('Erreur: utilisateur non identifi√©','error');return;}
        let ok=true;
        ['grpMatricule','grpGrade','grpFormationArmement','grpCodes','grpReforme'].forEach(id=>document.getElementById(id).classList.remove('error'));
        ['grpSaluts','grpSociostatus','grpVerdicts','grpProcedures'].forEach(id=>document.getElementById(id).classList.remove('error'));
        const matricule=document.getElementById('fMatricule').value.trim();
        if(!matricule){document.getElementById('grpMatricule').classList.add('error');document.getElementById('errMatricule').textContent='Matricule requis';ok=false;}
        const grade=document.getElementById('fGrade').value;
        if(!grade){document.getElementById('grpGrade').classList.add('error');document.getElementById('errGrade').textContent='Grade requis';ok=false;}
        if(!ratings.noteSaluts){document.getElementById('grpSaluts').classList.add('error');document.getElementById('errSaluts').textContent='Note requise';ok=false;}
        if(!ratings.noteSociostatus){document.getElementById('grpSociostatus').classList.add('error');document.getElementById('errSociostatus').textContent='Note requise';ok=false;}
        if(!ratings.noteVerdicts){document.getElementById('grpVerdicts').classList.add('error');document.getElementById('errVerdicts').textContent='Note requise';ok=false;}
        if(!ratings.noteProcedures){document.getElementById('grpProcedures').classList.add('error');document.getElementById('errProcedures').textContent='Note requise';ok=false;}
        const formationArmement=document.getElementById('fFormationArmement').value;
        if(!formationArmement){document.getElementById('grpFormationArmement').classList.add('error');document.getElementById('errFormationArmement').textContent='Requis';ok=false;}
        const codes=document.getElementById('fCodes').value;
        if(!codes){document.getElementById('grpCodes').classList.add('error');document.getElementById('errCodes').textContent='Requis';ok=false;}
        const reforme=document.getElementById('fReforme').value;
        if(!reforme){document.getElementById('grpReforme').classList.add('error');document.getElementById('errReforme').textContent='Requis';ok=false;}
        if(!ok)return;
        const btn=document.getElementById('btnSubmit');btn.disabled=true;btn.textContent='‚è≥ ENVOI...';
        const avg=((ratings.noteSaluts+ratings.noteSociostatus+ratings.noteVerdicts+ratings.noteProcedures)/4).toFixed(2);
        const test={unite_matricule:matricule,unite_grade:grade,note_saluts:ratings.noteSaluts,note_sociostatus:ratings.noteSociostatus,note_verdicts:ratings.noteVerdicts,note_procedures:ratings.noteProcedures,moyenne:parseFloat(avg),formation_armement:formationArmement,codes_complet:codes,reforme:reforme,commentaires:document.getElementById('fCommentaires').value.trim(),evaluateur_matricule:currentUser.matricule,evaluateur_nom:currentUser.nom_steam||'',statut:'en_attente',created_at:new Date().toISOString().substring(0,10)};
        try{const saved=await ghAddUnitTest(test);allTests.push(saved);await ghAddReport({matricule:currentUser.matricule,nom_steam:currentUser.nom_steam||'',type:'Test d\'√©valuation',secteur:'',unit√©s:matricule,resume:`Test ‚Äî Unit√© ${matricule} (${grade}) ‚Äî Moyenne: ${avg}/4`,notes:test.commentaires,created_at:test.created_at,type_rapport:'unit√©',division:currentUser.division||''});showAlert('‚úì Test soumis. En attente de validation par un HautGrad√©.','success');resetTest();renderArchives();}catch(e){showAlert('‚úó Erreur: '+e.message,'error');}finally{btn.disabled=false;btn.textContent='‚ü© SOUMETTRE LE TEST';}
      };
      window.resetTest = function() {
        ['fMatricule','fGrade','fFormationArmement','fCodes','fReforme','fCommentaires'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
        ['grpMatricule','grpGrade','grpFormationArmement','grpCodes','grpReforme','grpSaluts','grpSociostatus','grpVerdicts','grpProcedures'].forEach(id=>document.getElementById(id).classList.remove('error'));
        ratings={};document.querySelectorAll('.rating-option').forEach(el=>el.classList.remove('selected'));
      };
      function renderArchives() {
        const tb=document.getElementById('archivesBody');const tests=allTests.sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||''));
        document.getElementById('archiveCount').textContent=tests.length+' TEST'+(tests.length>1?'S':'');
        if(!tests.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--text-muted);">Aucun test enregistr√©</td></tr>';return;}
        tb.innerHTML=tests.map(t=>{const sc=t.statut==='valide'?'validated':(t.statut==='rejete'?'rejected':'pending');const sl=t.statut==='valide'?'VALID√â':(t.statut==='rejete'?'REJET√â':'EN ATTENTE');const ac=t.moyenne>=3?'#00cc55':(t.moyenne>=2?'#ffc800':'#ff4444');return`<tr onclick="showTestDetail('${t._id}')"><td>${fmtDate(t.created_at)}</td><td>${t.unite_matricule||'-'}</td><td>${t.unite_grade||'-'}</td><td><span class="avg-score" style="color:${ac}">${t.moyenne}/4</span></td><td>${t.evaluateur_matricule||'-'}</td><td><span class="status-badge ${sc}">${sl}</span></td></tr>`;}).join('');
      }
      window.showTestDetail = function(id) {
        const t=allTests.find(x=>x._id===id);if(!t)return;
        const o=document.createElement('div');o.className='detail-overlay';
        const ac=t.moyenne>=3?'#00cc55':(t.moyenne>=2?'#ffc800':'#ff4444');
        o.innerHTML=`<div class="detail-box"><h3>TEST ‚Äî ${t.unite_matricule} (${t.unite_grade})</h3><div class="detail-row"><span class="detail-label">DATE</span><span class="detail-value">${fmtDate(t.created_at)}</span></div><div class="detail-row"><span class="detail-label">√âVALUATEUR</span><span class="detail-value">${t.evaluateur_matricule} (${t.evaluateur_nom||'-'})</span></div><div class="detail-row"><span class="detail-label">SALUTS</span><span class="detail-value">${t.note_saluts}/4</span></div><div class="detail-row"><span class="detail-label">SOCIOSTATUS</span><span class="detail-value">${t.note_sociostatus}/4</span></div><div class="detail-row"><span class="detail-label">VERDICTS</span><span class="detail-value">${t.note_verdicts}/4</span></div><div class="detail-row"><span class="detail-label">PROC√âDURES</span><span class="detail-value">${t.note_procedures}/4</span></div><div class="detail-row"><span class="detail-label">MOYENNE</span><span class="detail-value" style="font-weight:700;color:${ac}">${t.moyenne}/4</span></div><div class="detail-row"><span class="detail-label">FORMATION ARME</span><span class="detail-value">${t.formation_armement}</span></div><div class="detail-row"><span class="detail-label">CODES COMPLET</span><span class="detail-value">${t.codes_complet}${t.codes_complet==='Non'?' ‚ö† ERREUR MAJEURE':''}</span></div><div class="detail-row"><span class="detail-label">EN R√âFORME</span><span class="detail-value">${t.reforme}</span></div>${t.commentaires?`<div class="detail-row"><span class="detail-label">COMMENTAIRES</span><span class="detail-value">${t.commentaires}</span></div>`:''}<div class="detail-row"><span class="detail-label">STATUT</span><span class="detail-value">${t.statut==='valide'?'‚úì VALID√â':t.statut==='rejete'?'‚úó REJET√â':'‚è≥ EN ATTENTE'}</span></div><button class="close-btn" onclick="this.closest('.detail-overlay').remove()">FERMER</button></div>`;
        document.body.appendChild(o);o.addEventListener('click',e=>{if(e.target===o)o.remove();});
      };
      onAuthStateChanged(auth, async(user) => {
        if(!user){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}
        try{const s=await getDoc(doc(db,'users',user.uid));if(!s.exists()){document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';return;}const ud=s.data();if(!ud.approved){document.getElementById('loading').style.display='none';document.getElementById('notApproved').style.display='block';return;}
        currentUser={matricule:ud.matricule||'???',nom_steam:ud.nom_steam||'',division:''};let ui=null;try{const u=await ghLoadUnits();allUnitsData=u||[];ui=u.find(x=>x.matricule===currentUser.matricule)||null;}catch(_){}
        const rang=ui?(ui.rang||''):'';const isHG=rang==='Ofc'||rang==='Cmd';const isFormateur=ui?(ui.formateur||false):false;const acc=getAccreditation(rang);currentUser.division=ui?(ui.division||''):'';
        if(!isFormateur&&!isHG){document.getElementById('loading').style.display='none';document.getElementById('noAccess').style.display='block';return;}
        const dv=!isHG&&ui?(ui.division||''):'';document.getElementById('userIdentification').textContent='Identification : '+[rang,dv,currentUser.matricule].filter(Boolean).join(' ');document.getElementById('userAvatar').textContent=currentUser.matricule.substring(0,3);
        if(acc){let l='Accr√©ditation : '+acc;if(isFormateur)l+=' ‚Äî '+((acc==='MPF'||acc==='Recrue')?'Unit√© Formatrice MPF':'Unit√© Formatrice MPEF');document.getElementById('userAccreditation').textContent=l;}
        document.getElementById('loading').style.display='none';document.getElementById('mainContent').style.display='block';filterUnitsDropdown();
        try{allTests=await ghLoadUnitTests();}catch(_){allTests=[];}
        }catch(e){console.error(e);document.getElementById('loading').style.display='none';document.getElementById('access-denied').style.display='block';}
      });
    </script>
</body>
</html>